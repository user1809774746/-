# 问题修复总结

## 🎯 修复的问题

### 1. ✅ 地图容器重复初始化错误

**错误信息**：
```
Uncaught Error: Map container is already initialized.
```

**原因**：
- React StrictMode 在开发环境下会执行两次 useEffect
- 地图容器被重复初始化

**解决方案**：
- 在创建地图前检查 `mapRef.current` 是否已存在
- 如果已存在，跳过初始化
- 添加 try-catch 错误处理

**修改文件**：`src/components/goHomePage.jsx`

---

### 2. ✅ AI接口400错误

**错误信息**：
```
POST https://api.dify.ai/v1/workflows/.../run 400 (Bad Request)
```

**原因**：
- 请求参数格式不正确
- 缺少必要的字段
- 输入变量名与Dify工作流配置不匹配

**解决方案**：

#### 调整请求格式：
```json
{
  "inputs": {
    "出发地": "北京",
    "目的地": "上海",
    "出行方式": "自驾"
  },
  "response_mode": "blocking",
  "user": "user-1234567890"
}
```

#### 添加详细日志：
- 请求前打印参数
- 错误时打印完整错误响应
- 便于调试和排查问题

**修改文件**：`src/components/goHomePage.jsx`

---

### 3. ✅ 页面加载时不应调用AI

**问题**：
- 页面加载时 useEffect 就调用AI接口
- 造成不必要的API请求

**解决方案**：
- 使用 `useRef` 跟踪首次渲染
- 首次渲染时跳过AI调用
- 只在用户切换出行方式时才重新调用

**修改文件**：`src/components/goHomePage.jsx`

---

## 📝 需要在Dify中配置的内容

### 输入变量

在您的Dify工作流中，需要添加以下输入变量：

| 变量名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| 出发地 | String | ✅ | 用户输入的出发地 |
| 目的地 | String | ✅ | 用户输入的目的地 |
| 出行方式 | String | ✅ | 地铁/步行/骑行/自驾/电动车/高铁 |

### 输出格式

工作流应该返回以下JSON格式：

```json
{
  "fastest": {
    "time": "时间：20分钟",
    "description": "路径：经过3个红绿灯",
    "cost": "费用：停车费约￥10.00"
  },
  "cheapest": {
    "time": "时间：30分钟",
    "description": "路径：避开收费路段,经过4个红绿灯",
    "cost": "费用：停车费约￥8.00"
  }
}
```

---

## 🔍 如何调试

### 1. 打开浏览器控制台（F12）

查看以下日志：

```javascript
// 请求开始
"正在调用AI接口..." { from: "北京", to: "上海", activeMode: "自驾" }

// 请求参数
"请求参数:" {
  inputs: { 出发地: "北京", 目的地: "上海", 出行方式: "自驾" },
  response_mode: "blocking",
  user: "user-..."
}

// 成功时
"AI返回数据:" { ... }

// 失败时
"AI接口错误响应:" { code: "...", message: "..." }
```

### 2. 检查Network标签

- 找到 `api.dify.ai` 的请求
- 查看 **Request Payload**（请求体）
- 查看 **Response**（响应内容）
- 查看 **Status Code**（状态码）

### 3. 常见错误码

| 状态码 | 含义 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查Dify输入变量名是否与请求一致 |
| 401 | 认证失败 | 检查API密钥是否正确 |
| 403 | 无权限 | 检查工作流是否启用API访问 |
| 404 | 工作流不存在 | 检查工作流ID是否正确 |
| 500 | 服务器错误 | 检查Dify工作流是否有错误 |

---

## ✅ 验证修复

### 1. 地图初始化问题

刷新页面，控制台应该只显示：
```
地图初始化完成
```

不应该再出现：
```
❌ Uncaught Error: Map container is already initialized.
```

### 2. AI接口调用

输入出发地、目的地，点击"一键规划路线"，应该看到：

1. **成功情况**：
```
✅ 正在调用AI接口...
✅ 请求参数: {...}
✅ AI返回数据: {...}
```

2. **失败情况**（会使用默认数据）：
```
⚠️ AI接口错误响应: {...}
⚠️ 调用AI接口出错: ...
ℹ️ 显示Toast: "AI服务暂时不可用，使用默认路线数据"
```

---

## 📱 当前服务器信息

- **访问地址**：http://localhost:3001/
- **端口**：3001（3000被占用，自动切换）
- **状态**：运行中 ✅

---

## 🚀 下一步

1. **配置Dify工作流**
   - 添加输入变量：出发地、目的地、出行方式
   - 配置AI生成路线方案
   - 设置输出为JSON格式

2. **测试AI接口**
   - 输入测试数据
   - 查看控制台日志
   - 验证返回数据格式

3. **调整解析逻辑**
   - 根据实际返回的数据路径调整代码
   - 可能需要修改 `data.data?.outputs?.text` 部分

---

## 📚 相关文档

- `AI接口说明.md` - 详细的API文档
- `故障排查.md` - 常见问题解决方案
- `启动开发服务器.bat` - 快速启动脚本

---

## 💡 提示

如果400错误仍然存在，请：

1. 在浏览器控制台复制 **"AI接口错误响应"** 的完整内容
2. 检查Dify工作流的输入变量名是否完全匹配
3. 如果Dify使用英文变量名，修改代码中的字段名：
   ```javascript
   inputs: {
     start_location: from,    // 如果Dify中是start_location
     end_location: to,
     travel_mode: activeMode
   }
   ```

