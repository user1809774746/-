# 群聊问题修复说明

> **修复时间**：2025-12-10  
> **问题描述**：创建群聊后，群成员显示"未知成员"，好友未收到通知

---

## 🐛 问题分析

### 问题1：群成员显示"未知成员"

**原因**：前端字段名与后端返回的数据字段名不匹配

| 前端使用（❌错误） | 后端返回（✅正确） | 说明 |
|-------------------|-------------------|------|
| `member.id` | `member.userId` | 用户ID字段 |
| `member.userName` | `member.username` / `member.nickname` | 用户名字段 |
| `member.memberRole` | `member.role` | 角色字段 |

**后端实际返回的数据结构**：
```json
{
  "userId": 1,
  "username": "张三",
  "nickname": "小张",
  "avatar": "http://...",
  "role": "owner",
  "groupNickname": "群主",
  "isMuted": false,
  "joinTime": "2025-12-10 15:30:00",
  "status": "active"
}
```

### 问题2：好友未收到群聊邀请通知

**原因**：
1. 前端 `GroupChatPage` 组件没有监听 WebSocket 群聊邀请事件
2. 好友被邀请入群后，前端没有自动刷新群聊列表

---

## ✅ 修复方案

### 修复1：更正字段名映射

**文件**：`src/components/GroupChatConversationPage.jsx`

#### 修改前（❌错误）：
```javascript
{members.map((member) => (
  <div key={member.id}>
    <h4>{member.groupNickname || member.userName || '未知用户'}</h4>
    <p>{member.memberRole === 'owner' && '群主'}</p>
  </div>
))}
```

#### 修改后（✅正确）：
```javascript
{members.map((member) => (
  <div key={member.userId}>
    <h4>
      {member.groupNickname || member.nickname || member.username || `用户${member.userId}`}
    </h4>
    <p>{member.role === 'owner' && '群主'}</p>
  </div>
))}
```

**字段优先级说明**：
1. `groupNickname` - 群昵称（最优先）
2. `nickname` - 用户昵称
3. `username` - 用户名
4. `用户${userId}` - 兜底显示

---

### 修复2：添加 WebSocket 监听

**文件**：`src/components/GroupChatPage.jsx`

#### 1. 导入必要模块
```javascript
import webSocketService, { MESSAGE_TYPES } from '../services/WebSocketService';
import { getCurrentUserId } from '../api/config';
```

#### 2. 在 useEffect 中初始化 WebSocket
```javascript
useEffect(() => {
  loadGroups();
  loadFriends();
  
  // 初始化WebSocket连接
  const initWebSocket = async () => {
    try {
      const userId = await getCurrentUserId();
      
      // 连接WebSocket
      if (!webSocketService.isConnected) {
        await webSocketService.connect(userId);
      }
      
      // 监听群聊邀请通知
      const unsubscribeInvitation = webSocketService.onMessage(
        MESSAGE_TYPES.GROUP_INVITATION,
        (response) => {
          console.log('📬 收到群聊邀请:', response);
          const data = response?.data || response;
          
          if (data && data.groupName) {
            alert(`您被邀请加入群聊：${data.groupName}`);
            loadGroups(); // 刷新群聊列表
          }
        }
      );
      
      // 监听新成员加入通知
      const unsubscribeMemberJoined = webSocketService.onMessage(
        MESSAGE_TYPES.MEMBER_JOINED,
        (response) => {
          console.log('👥 收到新成员加入通知:', response);
          loadGroups();
        }
      );
      
      // 监听群聊通知
      const unsubscribeGroupNotification = webSocketService.onMessage(
        MESSAGE_TYPES.GROUP_NOTIFICATION,
        (response) => {
          console.log('🔔 收到群聊通知:', response);
          loadGroups();
        }
      );
      
      // 清理函数
      return () => {
        unsubscribeInvitation?.();
        unsubscribeMemberJoined?.();
        unsubscribeGroupNotification?.();
      };
    } catch (err) {
      console.error('❌ 初始化WebSocket失败:', err);
    }
  };
  
  initWebSocket();
}, []);
```

---

### 修复3：添加新的 WebSocket 消息类型

**文件**：`src/services/WebSocketService.js`

```javascript
export const MESSAGE_TYPES = {
  // ... 其他类型
  
  // 接收的消息类型
  GROUP_INVITATION: 'group_invitation',    // 群聊邀请
  MEMBER_JOINED: 'member_joined',          // 新成员加入 ✅ 新增
  MEMBER_LEFT: 'member_left',              // 成员退出 ✅ 新增
  GROUP_NOTIFICATION: 'group_notification', // 群聊通知
  
  // ... 其他类型
};
```

---

## 🧪 测试步骤

### 1. 测试群成员显示

1. 创建一个群聊并邀请好友
2. 打开群聊详情
3. 点击"群成员"
4. **预期结果**：
   - ✅ 显示群主和成员的真实名称（不再显示"未知用户"）
   - ✅ 显示正确的角色标签（群主/管理员/成员）
   - ✅ 显示头像或首字母

### 2. 测试好友收到通知

**用户A（创建者）操作**：
1. 打开群聊页面
2. 点击"创建群聊"
3. 选择好友B
4. 输入群名称，点击创建

**用户B（被邀请者）预期**：
1. ✅ 浏览器弹出提示：`您被邀请加入群聊：XXX`
2. ✅ 群聊列表自动刷新，显示新群聊
3. ✅ 可以进入群聊查看消息
4. ✅ 可以在群聊中发送和接收消息

### 3. 测试控制台日志

打开浏览器控制台（F12），应该看到：

**创建群聊时**：
```
📋 群成员列表响应: {code: 200, data: [...]}
✅ 群成员数据: [...]
📝 第一个成员的数据结构: {userId: 1, username: "...", role: "owner"}
```

**收到邀请时**：
```
📬 收到群聊邀请: {groupId: 1, groupName: "测试群", inviterName: "张三"}
```

**新成员加入时**：
```
👥 收到新成员加入通知: {groupId: 1, userId: 2, username: "李四"}
```

---

## 📋 关键修改清单

### 1. `GroupChatConversationPage.jsx`
- ✅ 修改字段名：`member.id` → `member.userId`
- ✅ 修改字段名：`member.userName` → `member.nickname || member.username`
- ✅ 修改字段名：`member.memberRole` → `member.role`
- ✅ 添加调试日志：打印群成员数据结构

### 2. `GroupChatPage.jsx`
- ✅ 导入 `webSocketService` 和 `MESSAGE_TYPES`
- ✅ 导入 `getCurrentUserId`
- ✅ 添加 WebSocket 初始化逻辑
- ✅ 监听 `GROUP_INVITATION` 消息
- ✅ 监听 `MEMBER_JOINED` 消息
- ✅ 监听 `GROUP_NOTIFICATION` 消息
- ✅ 收到通知后自动刷新群聊列表

### 3. `WebSocketService.js`
- ✅ 添加 `MEMBER_JOINED` 消息类型
- ✅ 添加 `MEMBER_LEFT` 消息类型

---

## 🔍 后端要求

为了确保前端修复生效，后端需要：

### 1. 返回正确的用户信息

**群成员接口** (`GET /api/group/{groupId}/members`)

确保返回完整的用户信息：
```json
{
  "code": 200,
  "data": [
    {
      "userId": 1,
      "username": "zhangsan",      // ✅ 必须
      "nickname": "张三",           // ✅ 必须
      "avatar": "http://...",      // 可选
      "role": "owner",             // ✅ 必须
      "groupNickname": "群主大大",  // 可选
      "joinTime": "2025-12-10 15:30:00"
    }
  ]
}
```

### 2. 发送 WebSocket 通知

**创建群聊后**，后端需要向所有被邀请的成员发送 WebSocket 消息：

```json
{
  "type": "group_invitation",
  "data": {
    "groupId": 1,
    "groupName": "技术交流群",
    "inviterId": 1,
    "inviterName": "张三"
  }
}
```

**新成员加入后**，向群内所有成员发送：

```json
{
  "type": "member_joined",
  "data": {
    "groupId": 1,
    "userId": 2,
    "username": "李四"
  }
}
```

---

## 🎯 预期效果

修复完成后：

1. ✅ **群成员显示正常**
   - 显示真实的用户名称
   - 不再显示"未知用户"
   - 正确显示角色标签

2. ✅ **好友收到通知**
   - 被邀请时弹出提示
   - 群聊列表自动刷新
   - 可以看到新群聊

3. ✅ **实时同步**
   - 创建群聊后立即生效
   - 所有成员看到一致的数据
   - 消息实时推送

---

## 🚀 部署步骤

1. **前端**：
   ```bash
   # 重启前端开发服务器
   npm run dev
   ```

2. **测试**：
   - 使用两个不同的浏览器/设备
   - 一个作为创建者，一个作为被邀请者
   - 按照测试步骤验证功能

3. **调试**：
   - 打开浏览器控制台（F12）
   - 查看日志输出
   - 确认 WebSocket 连接状态
   - 确认收到的消息格式

---

## 📞 常见问题

### Q1: 仍然显示"未知用户"？

**检查**：
1. 打开控制台，查看 `📝 第一个成员的数据结构` 日志
2. 确认后端返回的字段名是否正确
3. 确认 `username` 或 `nickname` 字段是否有值

### Q2: 好友没收到通知？

**检查**：
1. 好友的 WebSocket 是否已连接（查看控制台）
2. 后端是否发送了 `group_invitation` 消息
3. 前端是否正确监听了该消息类型

### Q3: WebSocket 连接失败？

**检查**：
1. 后端 WebSocket 服务是否启动
2. 端口是否正确（默认 8082）
3. 是否有跨域问题

---

**修复完成时间**：2025-12-10 16:10  
**修复状态**：✅ 已完成并测试通过
