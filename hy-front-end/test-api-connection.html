<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #d5f4e6; border: 1px solid #27ae60; }
        .error { background: #fadbd8; border: 1px solid #e74c3c; }
        .info { background: #d6eaf8; border: 1px solid #3498db; }
        .warning { background: #fdeaa7; border: 1px solid #f39c12; }
        input[type="text"] {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 10px;
        }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ APIè¿æ¥æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“¡ æœåŠ¡å™¨é…ç½®</h3>
            <label>åç«¯åœ°å€ï¼š</label>
            <input type="text" id="serverUrl" value="http://localhost:8081" />
            <button onclick="updateServer()">æ›´æ–°</button>
            <div id="serverInfo" class="result info">å½“å‰åç«¯åœ°å€ï¼šhttp://localhost:8081 (åŒæœºå™¨éƒ¨ç½²)</div>
        </div>

        <div class="test-section">
            <h3>ğŸŒ åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <button onclick="testBasicConnection()">æµ‹è¯•ç›´æ¥è¿æ¥</button>
            <button onclick="testProxyConnection()">æµ‹è¯•ä»£ç†è¿æ¥</button>
            <button onclick="testCORS()">æµ‹è¯•CORSç­–ç•¥</button>
            <div id="basicResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“± APIç«¯ç‚¹æµ‹è¯•</h3>
            <button onclick="testSendCode()">æµ‹è¯•å‘é€éªŒè¯ç </button>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•æ¥å£</button>
            <button onclick="testProfile()">æµ‹è¯•ç”¨æˆ·ä¿¡æ¯</button>
            <div id="apiResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” ç½‘ç»œè¯Šæ–­</h3>
            <button onclick="checkNetworkInfo()">æ£€æŸ¥ç½‘ç»œä¿¡æ¯</button>
            <button onclick="testDifferentMethods()">æµ‹è¯•ä¸åŒè¯·æ±‚æ–¹å¼</button>
            <div id="networkResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h3>
            <button onclick="showCORSSolutions()">CORSè§£å†³æ–¹æ¡ˆ</button>
            <button onclick="showNetworkSolutions()">ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ</button>
            <div id="solutionResult" class="result"></div>
        </div>
    </div>

    <script>
        let SERVER_URL = 'http://localhost:8081';

        function updateServer() {
            SERVER_URL = document.getElementById('serverUrl').value;
            document.getElementById('serverInfo').innerHTML = `å½“å‰åç«¯åœ°å€ï¼š${SERVER_URL}`;
            document.getElementById('serverInfo').className = 'result info';
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
        }

        async function testBasicConnection() {
            showResult('basicResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç›´æ¥è¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•ç®€å•çš„GETè¯·æ±‚
                const response = await fetch(SERVER_URL, { 
                    method: 'GET',
                    mode: 'cors'
                });
                
                showResult('basicResult', 
                    `âœ… ç›´æ¥è¿æ¥æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nå“åº”å¤´: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 
                    'success'
                );
            } catch (error) {
                showResult('basicResult', 
                    `âŒ ç›´æ¥è¿æ¥å¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯: ${error.message}\né”™è¯¯ç±»å‹: ${error.name}\n\nå¯èƒ½åŸå› :\n1. åç«¯æœåŠ¡æœªå¯åŠ¨\n2. é˜²ç«å¢™é˜»æ­¢\n3. CORSè·¨åŸŸé™åˆ¶\n4. ç½‘ç»œè¿æ¥é—®é¢˜\n\nğŸ’¡ æç¤º: å¦‚æœä»£ç†è¿æ¥æˆåŠŸï¼Œè¯´æ˜åç«¯æ­£å¸¸ï¼Œåªæ˜¯é˜²ç«å¢™é—®é¢˜`, 
                    'error'
                );
            }
        }

        async function testProxyConnection() {
            showResult('basicResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ä»£ç†è¿æ¥...', 'info');
            
            try {
                // é€šè¿‡ä»£ç†æµ‹è¯•APIè¿æ¥
                const response = await fetch('/api/auth/send-verification-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: '13800138000'
                    })
                });
                
                const data = await response.json();
                
                showResult('basicResult', 
                    `âœ… ä»£ç†è¿æ¥æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}\n\nğŸ‰ å‰ç«¯åº”ç”¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼`, 
                    'success'
                );
            } catch (error) {
                showResult('basicResult', 
                    `âŒ ä»£ç†è¿æ¥å¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯: ${error.message}\n\nè¿™è¡¨ç¤ºViteä»£ç†é…ç½®æœ‰é—®é¢˜`, 
                    'error'
                );
            }
        }

        async function testCORS() {
            showResult('basicResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•CORSç­–ç•¥...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/api/auth/send-verification-code', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                showResult('basicResult', 
                    `âœ… CORSé¢„æ£€è¯·æ±‚æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nCORSé…ç½®:\n${JSON.stringify(corsHeaders, null, 2)}`, 
                    'success'
                );
            } catch (error) {
                showResult('basicResult', 
                    `âŒ CORSæµ‹è¯•å¤±è´¥ï¼\né”™è¯¯: ${error.message}\n\nè¿™é€šå¸¸è¡¨ç¤ºåç«¯æ²¡æœ‰æ­£ç¡®é…ç½®CORSç­–ç•¥`, 
                    'error'
                );
            }
        }

        async function testSendCode() {
            showResult('apiResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•å‘é€éªŒè¯ç æ¥å£...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/api/auth/send-verification-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: '13800138000'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('apiResult', 
                        `âœ… å‘é€éªŒè¯ç æ¥å£æ­£å¸¸ï¼\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResult('apiResult', 
                        `âš ï¸ æ¥å£å“åº”å¼‚å¸¸\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                        'warning'
                    );
                }
            } catch (error) {
                showResult('apiResult', 
                    `âŒ å‘é€éªŒè¯ç æ¥å£å¤±è´¥ï¼\né”™è¯¯: ${error.message}`, 
                    'error'
                );
            }
        }

        async function testLogin() {
            showResult('apiResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç™»å½•æ¥å£...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: '13800138000',
                        password: 'password123',
                        userType: 'user'
                    })
                });
                
                const data = await response.json();
                
                showResult('apiResult', 
                    `ğŸ“Š ç™»å½•æ¥å£å“åº”\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                    response.ok ? 'success' : 'warning'
                );
            } catch (error) {
                showResult('apiResult', 
                    `âŒ ç™»å½•æ¥å£å¤±è´¥ï¼\né”™è¯¯: ${error.message}`, 
                    'error'
                );
            }
        }

        async function testProfile() {
            showResult('apiResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ç”¨æˆ·ä¿¡æ¯æ¥å£...', 'info');
            
            try {
                const response = await fetch(SERVER_URL + '/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                const data = await response.json();
                
                showResult('apiResult', 
                    `ğŸ“Š ç”¨æˆ·ä¿¡æ¯æ¥å£å“åº”\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, 
                    response.status === 401 ? 'warning' : (response.ok ? 'success' : 'error')
                );
            } catch (error) {
                showResult('apiResult', 
                    `âŒ ç”¨æˆ·ä¿¡æ¯æ¥å£å¤±è´¥ï¼\né”™è¯¯: ${error.message}`, 
                    'error'
                );
            }
        }

        function checkNetworkInfo() {
            const info = `
ğŸŒ å½“å‰é¡µé¢ä¿¡æ¯:
- é¡µé¢åœ°å€: ${window.location.href}
- åè®®: ${window.location.protocol}
- ä¸»æœº: ${window.location.host}
- ç”¨æˆ·ä»£ç†: ${navigator.userAgent}

ğŸ¯ ç›®æ ‡æœåŠ¡å™¨:
- åç«¯åœ°å€: ${SERVER_URL}
- è·¨åŸŸæƒ…å†µ: ${window.location.origin !== SERVER_URL ? 'æ˜¯ï¼ˆè·¨åŸŸè¯·æ±‚ï¼‰' : 'å¦ï¼ˆåŒåŸŸè¯·æ±‚ï¼‰'}

ğŸ“Š æµè§ˆå™¨æ”¯æŒ:
- Fetch API: ${typeof fetch !== 'undefined' ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
- CORS: ${typeof XMLHttpRequest !== 'undefined' ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
            `;
            
            showResult('networkResult', info, 'info');
        }

        async function testDifferentMethods() {
            showResult('networkResult', 'ğŸ”„ æ­£åœ¨æµ‹è¯•ä¸åŒè¯·æ±‚æ–¹å¼...', 'info');
            
            const methods = ['GET', 'POST', 'OPTIONS'];
            const results = [];
            
            for (const method of methods) {
                try {
                    const response = await fetch(SERVER_URL, { method });
                    results.push(`${method}: âœ… ${response.status} ${response.statusText}`);
                } catch (error) {
                    results.push(`${method}: âŒ ${error.message}`);
                }
            }
            
            showResult('networkResult', 
                `ğŸ“Š ä¸åŒHTTPæ–¹æ³•æµ‹è¯•ç»“æœ:\n${results.join('\n')}`, 
                'info'
            );
        }

        function showCORSSolutions() {
            const solutions = `
ğŸ”§ CORSè·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆ:

1ï¸âƒ£ åç«¯è§£å†³æ–¹æ¡ˆï¼ˆæ¨èï¼‰:
   åœ¨Spring Bootåç«¯æ·»åŠ CORSé…ç½®:
   
   @CrossOrigin(origins = "*", allowedHeaders = "*")
   æˆ–è€…å…¨å±€é…ç½®WebMvcConfigurer

2ï¸âƒ£ å‰ç«¯ä»£ç†è§£å†³æ–¹æ¡ˆ:
   ä¿®æ”¹vite.config.jsæ·»åŠ ä»£ç†:
   
   server: {
     proxy: {
       '/api': 'http://192.168.1.131:8081'
     }
   }

3ï¸âƒ£ æµè§ˆå™¨è§£å†³æ–¹æ¡ˆï¼ˆä¸´æ—¶ï¼‰:
   ä½¿ç”¨Chromeå¯åŠ¨å‚æ•°:
   --disable-web-security --user-data-dir=/tmp/chrome

4ï¸âƒ£ æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ:
   è®¿é—®: http://192.168.1.131:8081
   åº”è¯¥è¿”å›Spring Booté»˜è®¤é¡µé¢æˆ–APIæ–‡æ¡£
            `;
            
            showResult('solutionResult', solutions, 'info');
        }

        function showNetworkSolutions() {
            const solutions = `
ğŸŒ ç½‘ç»œé—®é¢˜è§£å†³æ–¹æ¡ˆ:

1ï¸âƒ£ æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€:
   - ç¡®è®¤Spring Bootåº”ç”¨è¿è¡Œåœ¨8081ç«¯å£
   - æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤IPåœ°å€192.168.1.131æ­£ç¡®

2ï¸âƒ£ æ£€æŸ¥ç½‘ç»œè¿æ¥:
   - ç¡®ä¿å‰åç«¯åœ¨åŒä¸€ç½‘ç»œ
   - æµ‹è¯•ping 192.168.1.131
   - æ£€æŸ¥è·¯ç”±å™¨è®¾ç½®

3ï¸âƒ£ é˜²ç«å¢™è®¾ç½®:
   - Windows: å…è®¸Java/Node.jsé€šè¿‡é˜²ç«å¢™
   - Linux: sudo ufw allow 8081
   - Mac: ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ â†’ é˜²ç«å¢™

4ï¸âƒ£ ç«¯å£æ£€æŸ¥:
   - ç¡®è®¤8081ç«¯å£æœªè¢«å ç”¨
   - ä½¿ç”¨netstat -ano | findstr :8081æ£€æŸ¥
            `;
            
            showResult('solutionResult', solutions, 'warning');
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œåˆå§‹æ£€æŸ¥
        window.onload = function() {
            checkNetworkInfo();
            showResult('basicResult', 'ğŸ‘‹ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•APIè¿æ¥', 'info');
            showResult('apiResult', 'ğŸ“± ç‚¹å‡»æŒ‰é’®æµ‹è¯•å…·ä½“çš„APIæ¥å£', 'info');
            showResult('solutionResult', 'ğŸ’¡ é‡åˆ°é—®é¢˜æ—¶ç‚¹å‡»æŸ¥çœ‹è§£å†³æ–¹æ¡ˆ', 'info');
        };
    </script>
</body>
</html>
