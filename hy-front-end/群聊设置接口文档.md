# 群聊设置接口文档

## 概述
本文档提供群聊设置相关的API接口说明，包括置顶群聊、消息免打扰、设置群聊背景、清空聊天记录、举报群聊等功能。

## 基础信息
- **Base URL**: `/api/group`
- **内容类型**: `application/json`
- **认证方式**: 需要用户认证

---

## 1. 置顶群聊

### 接口说明
设置或取消置顶群聊

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/pin`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "userId": 1001,
  "isPinned": true
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| isPinned | Boolean | 是 | 是否置顶，true-置顶，false-取消置顶 |

### 响应示例
```json
{
  "code": 200,
  "message": "置顶成功",
  "data": "置顶成功"
}
```

---

## 2. 消息免打扰

### 接口说明
设置或取消群聊的消息免打扰

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/disturb-free`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "userId": 1001,
  "isDisturbFree": true
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| isDisturbFree | Boolean | 是 | 是否免打扰，true-开启，false-关闭 |

### 响应示例
```json
{
  "code": 200,
  "message": "已开启消息免打扰",
  "data": "已开启消息免打扰"
}
```

---

## 3. 设置群聊背景

### 接口说明
设置群聊的聊天背景图片（仅对当前用户生效）

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/background`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "userId": 1001,
  "backgroundUrl": "https://example.com/background.jpg"
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| backgroundUrl | String | 否 | 背景图片URL，传null表示清除背景 |

### 响应示例
```json
{
  "code": 200,
  "message": "聊天背景设置成功",
  "data": "聊天背景设置成功"
}
```

---

## 4. 清空聊天记录

### 接口说明
清空群聊的聊天记录（仅对当前用户有效，不影响其他成员）

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/clear-history`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "userId": 1001
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

### 响应示例
```json
{
  "code": 200,
  "message": "聊天记录已清空",
  "data": "聊天记录已清空"
}
```

### 注意事项
- 清空记录后，用户只能看到清空时间之后的消息
- 此操作不会删除服务器上的消息，只是在查询时过滤
- 未读消息数会被清零

---

## 5. 举报群聊

### 接口说明
举报违规群聊

### 请求信息
- **URL**: `POST /api/group/{groupId}/report`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "reporterId": 1001,
  "reportType": "spam",
  "reportReason": "该群聊频繁发送垃圾广告信息，严重影响用户体验",
  "evidenceUrls": [
    "https://example.com/evidence1.jpg",
    "https://example.com/evidence2.jpg"
  ]
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| reporterId | Long | 是 | 举报人ID |
| reportType | String | 是 | 举报类型，见下方说明 |
| reportReason | String | 是 | 举报原因，10-500字符 |
| evidenceUrls | List<String> | 否 | 证据截图URL列表 |

### 举报类型说明
| 类型值 | 说明 |
|--------|------|
| spam | 垃圾广告 |
| fraud | 欺诈 |
| pornography | 色情 |
| violence | 暴力 |
| politics | 政治敏感 |
| harassment | 骚扰 |
| other | 其他 |

### 响应示例
```json
{
  "code": 200,
  "message": "举报已提交，我们会尽快处理",
  "data": "举报已提交，我们会尽快处理"
}
```

### 注意事项
- 每个用户只能举报同一个群聊一次
- 举报后会进入待处理状态，由管理员审核

---

## 6. 获取群聊设置

### 接口说明
获取用户在该群聊的所有设置信息

### 请求信息
- **URL**: `GET /api/group/{groupId}/settings?userId={userId}`
- **路径参数**:
  - `groupId` (Long): 群聊ID
- **查询参数**:
  - `userId` (Long): 用户ID

### 响应示例
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "groupId": 1,
    "userId": 1001,
    "isPinned": true,
    "isDisturbFree": false,
    "chatBackground": "https://example.com/background.jpg",
    "clearHistoryTime": "2025-12-10T10:30:00",
    "unreadCount": 5
  }
}
```

### 响应字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| groupId | Long | 群聊ID |
| userId | Long | 用户ID |
| isPinned | Boolean | 是否置顶 |
| isDisturbFree | Boolean | 是否免打扰 |
| chatBackground | String | 聊天背景URL |
| clearHistoryTime | DateTime | 清空历史记录的时间点 |
| unreadCount | Integer | 未读消息数 |

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限操作 |
| 404 | 群聊不存在 |
| 500 | 服务器内部错误 |

---

## 使用示例

### JavaScript/Fetch 示例
```javascript
// 1. 置顶群聊
async function pinGroup(groupId, userId, isPinned) {
  const response = await fetch(`/api/group/${groupId}/settings/pin`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      userId: userId,
      isPinned: isPinned
    })
  });
  return await response.json();
}

// 2. 设置消息免打扰
async function setDisturbFree(groupId, userId, isDisturbFree) {
  const response = await fetch(`/api/group/${groupId}/settings/disturb-free`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      userId: userId,
      isDisturbFree: isDisturbFree
    })
  });
  return await response.json();
}

// 3. 清空聊天记录
async function clearChatHistory(groupId, userId) {
  const response = await fetch(`/api/group/${groupId}/settings/clear-history`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      userId: userId
    })
  });
  return await response.json();
}

// 4. 举报群聊
async function reportGroup(groupId, reportData) {
  const response = await fetch(`/api/group/${groupId}/report`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(reportData)
  });
  return await response.json();
}

// 5. 获取群聊设置
async function getGroupSettings(groupId, userId) {
  const response = await fetch(`/api/group/${groupId}/settings?userId=${userId}`);
  return await response.json();
}
```

### cURL 示例
```bash
# 1. 置顶群聊
curl -X POST "http://localhost:8080/api/group/1/settings/pin" \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1001,
    "isPinned": true
  }'

# 2. 举报群聊
curl -X POST "http://localhost:8080/api/group/1/report" \
  -H "Content-Type: application/json" \
  -d '{
    "reporterId": 1001,
    "reportType": "spam",
    "reportReason": "该群聊频繁发送垃圾广告信息",
    "evidenceUrls": ["https://example.com/evidence.jpg"]
  }'

# 3. 获取群聊设置
curl -X GET "http://localhost:8080/api/group/1/settings?userId=1001"
```

---

## 数据库补丁说明

在使用这些接口之前，需要执行数据库补丁文件 `group_settings_patch.sql`，该文件包含：

1. **group_members 表新增字段**:
   - `is_pinned`: 是否置顶
   - `is_disturb_free`: 消息免打扰
   - `chat_background`: 聊天背景URL
   - `clear_history_time`: 清空历史记录时间点

2. **group_reports 表**:
   - 新创建的举报记录表
   - 包含举报类型、原因、证据、处理状态等字段

执行命令：
```sql
SOURCE group_settings_patch.sql;
```

---

## 注意事项

1. **权限验证**: 所有接口都需要验证用户是否为群成员
2. **置顶和免打扰**: 这些设置是用户维度的，不影响其他成员
3. **清空记录**: 只影响当前用户的消息查询，不会真正删除消息
4. **举报限制**: 每个用户只能举报同一个群聊一次
5. **背景设置**: 每个用户可以为同一个群设置不同的背景

---

## 更新日志

### v1.0.0 (2025-12-11)
- 初始版本
- 实现置顶群聊功能
- 实现消息免打扰功能
- 实现设置群聊背景功能
- 实现清空聊天记录功能
- 实现举报群聊功能
- 实现获取群聊设置功能
