# Dify 工作流配置指南

## ⚠️ 当前状态

**工作流ID不存在**

测试结果：
```
❌ 404 Not Found
Workflow not found with id: 3d53d609-922a-42bc-92ff-3807de965a31
```

**当前解决方案**：AI功能已禁用，应用使用默认路线数据，所有功能正常。

---

## 🔧 解决方案

您需要在Dify平台创建一个新的工作流。以下是详细步骤：

---

## 📋 创建Dify工作流的完整步骤

### 第1步：注册/登录Dify

访问：https://dify.ai/

### 第2步：创建新工作流

1. 点击 **"创建应用"** 或 **"工作流"**
2. 选择 **"工作流"** 类型
3. 给工作流命名，例如："路线规划助手"

### 第3步：配置输入变量

在工作流编辑器中，添加**1个输入变量**：

#### 变量：query（用户查询）
- **变量名**：`query`
- **类型**：String（字符串）
- **必填**：是
- **描述**：用户的完整查询内容

**前端会自动组合成以下格式**：
```
我要通过{出行方式}从{出发地}到{目的地}，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费
```

**示例输入**：
```
我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费
```

### 第4步：添加AI节点

1. 在工作流中添加 **"LLM节点"** 或 **"AI节点"**
2. 配置提示词（Prompt）：

```
你是一个智能路线规划助手。

用户查询：{{query}}

请根据用户的查询生成两种路线方案：
1. 最快路线方案
2. 最省钱方案

请严格按照以下JSON格式返回，不要包含任何其他文字：

{
  "fastest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过C、D等",
    "cost": "花费：￥XX.XX"
  },
  "cheapest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过E、F等",
    "cost": "花费：￥XX.XX"
  }
}

格式要求：
- time格式：时间：XX分钟 或 时间：X小时XX分钟
- description：详细描述路线，包括途经道路、换乘信息、距离等
- cost格式：花费：￥XX.XX 或 花费：免费
- 必须返回有效的JSON格式
- 根据实际出行方式给出合理的时间和花费
```

3. 选择合适的AI模型（如 GPT-4、Claude等）

### 第5步：添加输出节点

1. 添加 **"输出节点"**
2. 将AI节点的输出连接到输出节点
3. 确保输出格式为JSON

### 第6步：测试工作流

1. 点击 **"测试运行"**
2. 输入测试数据：
   - 出发地：北京
   - 目的地：上海
   - 出行方式：自驾
3. 查看输出是否符合JSON格式
4. 调整提示词直到输出正确

### 第7步：启用API访问

1. 点击右上角 **"发布"** 或 **"API"**
2. 启用 **"API访问"**
3. 选择 **"阻塞模式"**（blocking）
4. 复制以下信息：
   - **工作流ID**（在URL中或API设置中）
   - **API密钥**（app-开头的字符串）

---

## 🔄 更新前端配置

配置非常简单！只需更新 `src/config/aiConfig.js` 中的两个字段：

```javascript
const aiConfig = {
  enabled: true,  // ✅ 改为 true 启用AI
  workflowId: '您的新工作流ID',  // ✅ 替换为您的工作流ID
  apiKey: 'app-您的新API密钥',    // ✅ 替换为您的API密钥
  // ... 其他字段保持不变
};
```

**就这么简单！** 因为现在只使用一个 `query` 字段，无需额外配置。

---

## ✅ 测试配置

### 1. 运行测试脚本

更新配置后，运行：

```bash
node test-api.js
```

### 2. 查看结果

**成功示例**：
```
✅ 请求成功！

返回数据:
{
  "data": {
    "outputs": {
      "text": "{\"fastest\":...}"
    }
  }
}
```

**失败示例**：
```
❌ 请求失败！
状态码: 400/401/404
```

### 3. 在浏览器中测试

1. 刷新浏览器：http://localhost:3001/
2. 按F12打开控制台
3. 输入出发地、目的地，点击"一键规划路线"
4. 查看控制台日志

---

## 📊 常见错误及解决方案

| 错误码 | 含义 | 解决方案 |
|--------|------|----------|
| 404 | 工作流不存在 | 检查工作流ID是否正确，工作流是否发布 |
| 401 | 认证失败 | 检查API密钥是否正确 |
| 400 | 参数错误 | 检查输入变量名是否匹配 |
| 500 | 服务器错误 | 检查工作流配置，查看Dify日志 |

---

## 💡 提示

1. **先在Dify中测试**
   - 确保工作流能正常运行
   - 输出格式正确

2. **使用测试脚本验证**
   - 运行 `node test-api.js`
   - 确认API可以正常调用

3. **再启用前端AI功能**
   - 修改 `enabled: true`
   - 刷新浏览器测试

4. **查看详细日志**
   - 浏览器控制台会显示详细的请求/响应
   - 根据日志调试问题

---

## 🎯 当前可用功能

即使不配置AI，应用所有功能都正常：

✅ 登录/注册  
✅ 地图显示  
✅ 输入出发地和目的地  
✅ 选择出行方式  
✅ 查看路线方案（预设数据）  
✅ 选择最快/最省钱路线  
✅ 地图路线展示  

---

## 📞 需要帮助？

如果配置过程中遇到问题：

1. **查看测试脚本输出**
   ```bash
   node test-api.js
   ```

2. **检查浏览器控制台**
   - 查找 `"AI接口错误响应:"`
   - 查看完整错误信息

3. **验证Dify配置**
   - 输入变量名是否正确
   - 输出格式是否为JSON
   - API访问是否启用

---

## 📚 相关文件

- `src/config/aiConfig.js` - AI配置文件
- `test-api.js` - API测试脚本
- `AI接口说明.md` - API详细文档
- `如何配置AI功能.md` - 配置说明

