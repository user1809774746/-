# ğŸ”§ åç«¯ç™»å½•æ¥å£ä¿®å¤è¯´æ˜

> **é—®é¢˜**ï¼šç®¡ç†å‘˜ç™»å½•å¤±è´¥ï¼Œæç¤º"æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"  
> **åŸå› **ï¼šåç«¯æœªæ ¹æ® `userType` åŒºåˆ†ç”¨æˆ·è¡¨å’Œç®¡ç†å‘˜è¡¨  
> **çŠ¶æ€**ï¼šğŸ”´ éœ€è¦åç«¯ä¿®æ”¹

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç°çŠ¶

1. âœ… **ç®¡ç†å‘˜æ³¨å†ŒæˆåŠŸ**
   - æ•°æ®å·²ä¿å­˜åˆ° `administrator_info` è¡¨
   - å¯†ç å·²ä½¿ç”¨BCryptåŠ å¯†
   
2. âŒ **ç®¡ç†å‘˜ç™»å½•å¤±è´¥**
   - å‰ç«¯æ­£ç¡®å‘é€ï¼š`{ phone, password, userType: "admin" }`
   - åç«¯é”™è¯¯ï¼šåœ¨ `user_info` è¡¨ä¸­æŸ¥æ‰¾ç®¡ç†å‘˜
   - ç»“æœï¼šæ‰¾ä¸åˆ°ï¼Œè¿”å›"æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"

### æ ¹æœ¬åŸå› 

åç«¯ç™»å½•é€»è¾‘æœªæ ¹æ® `userType` å‚æ•°åŒºåˆ†æŸ¥è¯¢å“ªä¸ªè¡¨ï¼š

```java
// âŒ å½“å‰é€»è¾‘ï¼ˆé”™è¯¯ï¼‰
// ä¸ç®¡ userType æ˜¯ä»€ä¹ˆï¼Œéƒ½æŸ¥ user_info è¡¨
User user = userRepository.findByPhone(phone);

// âœ… æ­£ç¡®é€»è¾‘
if ("admin".equals(userType)) {
    // æŸ¥è¯¢ administrator_info è¡¨
    Administrator admin = administratorRepository.findByPhone(phone);
} else {
    // æŸ¥è¯¢ user_info è¡¨
    User user = userRepository.findByPhone(phone);
}
```

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šä¿®æ”¹ç™»å½•æ¥å£ï¼Œæ ¹æ® userType åŒºåˆ†æŸ¥è¯¢

**æ–‡ä»¶**ï¼š`AuthController.java` æˆ– `AuthService.java`

#### ä¿®æ”¹å‰ï¼ˆé”™è¯¯çš„é€»è¾‘ï¼‰

```java
@PostMapping("/login")
public ResponseDTO login(@RequestBody LoginRequest request) {
    String phone = request.getPhone();
    String password = request.getPassword();
    
    // âŒ é—®é¢˜ï¼šåªæŸ¥ user_info è¡¨
    User user = userRepository.findByPhone(phone)
        .orElseThrow(() -> new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"));
    
    if (!passwordEncoder.matches(password, user.getPassword())) {
        throw new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯");
    }
    
    // ç”Ÿæˆtokenå¹¶è¿”å›
    String token = generateToken(phone, "user");
    return ResponseDTO.success(Map.of("token", token));
}
```

#### ä¿®æ”¹åï¼ˆæ­£ç¡®çš„é€»è¾‘ï¼‰

```java
@PostMapping("/login")
public ResponseDTO login(@RequestBody LoginRequest request) {
    String phone = request.getPhone();
    String password = request.getPassword();
    String userType = request.getUserType(); // æ–°å¢ï¼šè·å–ç”¨æˆ·ç±»å‹
    
    // âœ… æ ¹æ® userType åŒºåˆ†æŸ¥è¯¢
    if ("admin".equals(userType)) {
        // ç®¡ç†å‘˜ç™»å½•ï¼šæŸ¥è¯¢ administrator_info è¡¨
        Administrator admin = administratorRepository.findByPhone(phone)
            .orElseThrow(() -> new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"));
        
        // éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(password, admin.getPassword())) {
            throw new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯");
        }
        
        // ç”Ÿæˆtoken
        String token = generateToken(phone, "admin");
        
        // æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œtoken
        admin.setLastLoginDate(new Date());
        admin.setActiveToken(token);
        admin.setTokenCreatedAt(new Date());
        admin.setTokenExpiresAt(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000));
        administratorRepository.save(admin);
        
        // è¿”å›ç®¡ç†å‘˜ç™»å½•ä¿¡æ¯
        return ResponseDTO.success(Map.of(
            "token", token,
            "userType", "admin",
            "phone", phone
        ));
        
    } else {
        // æ™®é€šç”¨æˆ·ç™»å½•ï¼šæŸ¥è¯¢ user_info è¡¨
        User user = userRepository.findByPhone(phone)
            .orElseThrow(() -> new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"));
        
        // éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new RuntimeException("æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯");
        }
        
        // ç”Ÿæˆtoken
        String token = generateToken(phone, "user");
        
        // æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œtoken
        user.setLastLoginDate(new Date());
        user.setActiveToken(token);
        user.setTokenCreatedAt(new Date());
        user.setTokenExpiresAt(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000));
        userRepository.save(user);
        
        // è¿”å›æ™®é€šç”¨æˆ·ç™»å½•ä¿¡æ¯
        return ResponseDTO.success(Map.of(
            "token", token,
            "userType", "user",
            "phone", phone
        ));
    }
}
```

---

## ğŸ“¡ æ¥å£è§„èŒƒï¼ˆå‰ç«¯å·²æŒ‰æ­¤å®ç°ï¼‰

### è¯·æ±‚æ ¼å¼

```http
POST /api/auth/login
Content-Type: application/json

{
  "phone": "18888888888",
  "password": "123123",
  "userType": "admin"  â† å…³é”®å‚æ•°
}
```

### å“åº”æ ¼å¼

#### ç®¡ç†å‘˜ç™»å½•æˆåŠŸ
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userType": "admin",
    "phone": "18888888888"
  }
}
```

#### æ™®é€šç”¨æˆ·ç™»å½•æˆåŠŸ
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userType": "user",
    "phone": "13800138000"
  }
}
```

#### ç™»å½•å¤±è´¥
```json
{
  "code": 401,
  "message": "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯",
  "data": null
}
```

---

## ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### 1. LoginRequest.javaï¼ˆDTOç±»ï¼‰

æ·»åŠ  `userType` å­—æ®µï¼š

```java
public class LoginRequest {
    private String phone;
    private String password;
    private String userType; // æ–°å¢
    
    // Getters and Setters
    public String getUserType() {
        return userType;
    }
    
    public void setUserType(String userType) {
        this.userType = userType;
    }
}
```

### 2. AuthController.java æˆ– AuthService.java

æŒ‰ç…§ä¸Šé¢çš„"ä¿®æ”¹å"é€»è¾‘ä¿®æ”¹ç™»å½•æ–¹æ³•ã€‚

### 3. AdministratorRepository.java

ç¡®ä¿æœ‰ `findByPhone` æ–¹æ³•ï¼š

```java
public interface AdministratorRepository extends JpaRepository<Administrator, Long> {
    Optional<Administrator> findByPhone(String phone);
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šç®¡ç†å‘˜ç™»å½•

```javascript
fetch('http://localhost:8081/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phone: "18888888888",
    password: "123123",
    userType: "admin"  // ç®¡ç†å‘˜
  })
})
.then(res => res.json())
.then(data => {
  console.log('ç®¡ç†å‘˜ç™»å½•ç»“æœ:', data);
  // é¢„æœŸï¼šcode: 200, data.userType: "admin"
});
```

### æµ‹è¯•2ï¼šæ™®é€šç”¨æˆ·ç™»å½•

```javascript
fetch('http://localhost:8081/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phone: "13800138000",
    password: "123456",
    userType: "user"  // æ™®é€šç”¨æˆ·
  })
})
.then(res => res.json())
.then(data => {
  console.log('æ™®é€šç”¨æˆ·ç™»å½•ç»“æœ:', data);
  // é¢„æœŸï¼šcode: 200, data.userType: "user"
});
```

### æµ‹è¯•3ï¼šé”™è¯¯çš„ userType

```javascript
// ç®¡ç†å‘˜è´¦å·ï¼Œä½†ä½¿ç”¨ user ç±»å‹ç™»å½•
fetch('http://localhost:8081/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phone: "18888888888",
    password: "123123",
    userType: "user"  // é”™è¯¯ï¼šåº”è¯¥æ˜¯ admin
  })
})
.then(res => res.json())
.then(data => {
  console.log('é”™è¯¯ç±»å‹ç™»å½•ç»“æœ:', data);
  // é¢„æœŸï¼šcode: 401, message: "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"
  // å› ä¸ºåœ¨ user_info è¡¨ä¸­æ‰¾ä¸åˆ°è¿™ä¸ªæ‰‹æœºå·
});
```

---

## ğŸ“Š æ•°æ®åº“è¡¨å¯¹ç…§

### user_info è¡¨ï¼ˆæ™®é€šç”¨æˆ·ï¼‰

| å­—æ®µ | è¯´æ˜ |
|------|------|
| userid | ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰ |
| number | æ‰‹æœºå· |
| password | å¯†ç ï¼ˆBCryptï¼‰ |
| active_token | å½“å‰token |

### administrator_info è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰

| å­—æ®µ | è¯´æ˜ |
|------|------|
| adminid | ç®¡ç†å‘˜IDï¼ˆä¸»é”®ï¼‰ |
| phone | æ‰‹æœºå· |
| password | å¯†ç ï¼ˆBCryptï¼‰ |
| active_token | å½“å‰token |

**å…³é”®åŒºåˆ«**ï¼š
- æ™®é€šç”¨æˆ·æ‰‹æœºå·å­—æ®µæ˜¯ `number`
- ç®¡ç†å‘˜æ‰‹æœºå·å­—æ®µæ˜¯ `phone`

---

## ğŸ¯ å®Œæ•´çš„ç™»å½•æµç¨‹

### ç®¡ç†å‘˜ç™»å½•æµç¨‹

```
1. å‰ç«¯å‘é€è¯·æ±‚
   { phone: "18888888888", password: "123123", userType: "admin" }
   â†“
2. åç«¯æ¥æ”¶è¯·æ±‚ï¼Œåˆ¤æ–­ userType === "admin"
   â†“
3. æŸ¥è¯¢ administrator_info è¡¨
   SELECT * FROM administrator_info WHERE phone = '18888888888'
   â†“
4. æ‰¾åˆ°ç®¡ç†å‘˜è®°å½•
   â†“
5. éªŒè¯å¯†ç 
   passwordEncoder.matches("123123", "$2a$10$...")
   â†“
6. éªŒè¯æˆåŠŸï¼Œç”Ÿæˆ JWT tokenï¼ˆuserType: "admin"ï¼‰
   â†“
7. æ›´æ–° active_token å’Œæœ€åç™»å½•æ—¶é—´
   â†“
8. è¿”å› token å’Œ userType
   â†“
9. å‰ç«¯ä¿å­˜ tokenï¼Œè·³è½¬åˆ°ç®¡ç†å‘˜åå°
```

### æ™®é€šç”¨æˆ·ç™»å½•æµç¨‹

```
1. å‰ç«¯å‘é€è¯·æ±‚
   { phone: "13800138000", password: "123456", userType: "user" }
   â†“
2. åç«¯æ¥æ”¶è¯·æ±‚ï¼Œåˆ¤æ–­ userType === "user"
   â†“
3. æŸ¥è¯¢ user_info è¡¨
   SELECT * FROM user_info WHERE number = '13800138000'
   â†“
4. æ‰¾åˆ°ç”¨æˆ·è®°å½•
   â†“
5. éªŒè¯å¯†ç 
   â†“
6. ç”Ÿæˆ JWT tokenï¼ˆuserType: "user"ï¼‰
   â†“
7. è¿”å› token
   â†“
8. å‰ç«¯ä¿å­˜ tokenï¼Œè·³è½¬åˆ°ä¸»é¡µ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å­—æ®µåç§°å·®å¼‚

- æ™®é€šç”¨æˆ·è¡¨ï¼šæ‰‹æœºå·å­—æ®µæ˜¯ `number`
- ç®¡ç†å‘˜è¡¨ï¼šæ‰‹æœºå·å­—æ®µæ˜¯ `phone`

åç«¯æŸ¥è¯¢æ—¶è¦æ³¨æ„ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåã€‚

### 2. Token å†…å®¹

Token ä¸­åº”åŒ…å« `userType` ä¿¡æ¯ï¼š

```java
Map<String, Object> claims = new HashMap<>();
claims.put("phone", phone);
claims.put("userType", userType); // é‡è¦ï¼šåŒºåˆ†ç”¨æˆ·ç±»å‹
String token = Jwts.builder()
    .setClaims(claims)
    .setExpiration(new Date(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000))
    .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
    .compact();
```

### 3. æƒé™éªŒè¯

è®¿é—®ç®¡ç†å‘˜æ¥å£æ—¶ï¼Œéœ€è¦éªŒè¯ token ä¸­çš„ `userType` æ˜¯å¦ä¸º `admin`ï¼š

```java
@GetMapping("/api/admin/posts/pending")
public ResponseDTO getPendingPosts(@RequestHeader("Authorization") String authHeader) {
    // è§£ætoken
    String token = authHeader.replace("Bearer ", "");
    Claims claims = Jwts.parser()
        .setSigningKey(SECRET_KEY)
        .parseClaimsJws(token)
        .getBody();
    
    String userType = (String) claims.get("userType");
    
    // éªŒè¯æ˜¯å¦ä¸ºç®¡ç†å‘˜
    if (!"admin".equals(userType)) {
        return ResponseDTO.error(403, "éœ€è¦ç®¡ç†å‘˜æƒé™");
    }
    
    // ç»§ç»­å¤„ç†...
}
```

---

## ğŸ§ª éªŒè¯æ¸…å•

ä¿®æ”¹å®Œæˆåï¼Œè¯·éªŒè¯ï¼š

- [ ] ç®¡ç†å‘˜å¯ä»¥æˆåŠŸç™»å½•ï¼ˆuserType: "admin"ï¼‰
- [ ] æ™®é€šç”¨æˆ·å¯ä»¥æˆåŠŸç™»å½•ï¼ˆuserType: "user"ï¼‰
- [ ] ç®¡ç†å‘˜ç™»å½•è¿”å›çš„ userType æ˜¯ "admin"
- [ ] æ™®é€šç”¨æˆ·ç™»å½•è¿”å›çš„ userType æ˜¯ "user"
- [ ] Token ä¸­åŒ…å«æ­£ç¡®çš„ userType ä¿¡æ¯
- [ ] ç®¡ç†å‘˜ç™»å½•åèƒ½è®¿é—®ç®¡ç†å‘˜æ¥å£
- [ ] æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜æ¥å£ï¼ˆè¿”å›403ï¼‰
- [ ] ä½¿ç”¨é”™è¯¯çš„ userType ç™»å½•ä¼šå¤±è´¥

---

## ğŸ“ å‰ç«¯å·²å®Œæˆçš„éƒ¨åˆ†

âœ… å‰ç«¯ä»£ç å·²ç»å®Œå…¨ç¬¦åˆæ¥å£è§„èŒƒï¼š

1. âœ… ç™»å½•é¡µé¢æœ‰ç”¨æˆ·ç±»å‹é€‰æ‹©å™¨ï¼ˆæ™®é€šç”¨æˆ·/ç®¡ç†å‘˜ï¼‰
2. âœ… ç™»å½•æ—¶æ­£ç¡®ä¼ é€’ `userType` å‚æ•°
3. âœ… æ ¹æ®è¿”å›çš„ `userType` è·³è½¬åˆ°ä¸åŒé¡µé¢
4. âœ… ç®¡ç†å‘˜è·³è½¬åˆ°å®¡æ ¸ç³»ç»Ÿ
5. âœ… æ™®é€šç”¨æˆ·è·³è½¬åˆ°ä¸»é¡µ

---

## ğŸ“ æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| **é—®é¢˜** | ç®¡ç†å‘˜ç™»å½•å¤±è´¥ |
| **åŸå› ** | åç«¯æœªæ ¹æ® userType åŒºåˆ†è¡¨æŸ¥è¯¢ |
| **å‰ç«¯** | âœ… å·²æ­£ç¡®å®ç° |
| **åç«¯** | âŒ éœ€è¦ä¿®æ”¹ç™»å½•é€»è¾‘ |
| **ä¿®æ”¹é‡ç‚¹** | æ ¹æ® userType åˆ¤æ–­æŸ¥è¯¢å“ªä¸ªè¡¨ |
| **é¢„è®¡æ—¶é—´** | â±ï¸ 10-15åˆ†é’Ÿ |

---

**è¯·å°†æ­¤æ–‡æ¡£å‘ç»™åç«¯å¼€å‘äººå‘˜ï¼Œä¿®æ”¹ç™»å½•æ¥å£é€»è¾‘ï¼** ğŸš€

