# 坐标功能测试说明

## ✅ 已完成的修改

### 1. goHomePage.jsx
- ✅ 添加了 `coordinates` 状态来存储AI返回的经纬度
- ✅ 在 `fetchAIRoutes` 中提取并保存坐标数据
- ✅ 在 `handleConfirm` 中将坐标传递给 MapPage
- ✅ 增强了日志输出，便于调试

### 2. MapPage.jsx
- ✅ 添加了 `getCoordinates` 函数来处理坐标
- ✅ 优先使用AI返回的坐标
- ✅ 如果没有AI坐标，则使用地址匹配默认坐标
- ✅ 自动调整地图视野以显示完整路线

### 3. App.jsx
- ✅ 更新 `handlePlanRoute` 来接收完整的路线数据
- ✅ 传递坐标到 MapPage

## 🔄 数据流程

```
用户输入（出发地 + 目的地）
    ↓
goHomePage.jsx - handleSearch()
    ↓
fetchAIRoutes() - 调用AI接口
    ↓
AI返回数据：
{
  fastest: {...},
  cheapest: {...},
  coordinates: {
    start: {lng, lat, address},
    end: {lng, lat, address}
  }
}
    ↓
setAiRoutes() + setCoordinates()
    ↓
handleConfirm() - 用户选择路线
    ↓
onPlanRoute(from, to, mode, routeType, coordinates)
    ↓
App.jsx - handlePlanRoute()
    ↓
setRouteData({...所有数据...})
    ↓
MapPage.jsx - getCoordinates()
    ↓
使用坐标绘制路线
```

## 🧪 测试步骤

### 阶段1：测试不带坐标（使用默认坐标）

1. **启动开发服务器**
   ```bash
   npm run dev
   ```

2. **登录系统**

3. **输入测试数据**
   - 出发地：北京长城
   - 目的地：北京天安门
   - 选择出行方式：自驾

4. **点击"一键规划路线"**

5. **检查控制台输出**
   应该看到：
   ```
   正在调用AI接口... {from: '北京长城', to: '北京天安门', activeMode: '自驾'}
   AI返回数据: {...}
   data.data内容: {...}
   data.data.outputs: {...}
   AI原始响应: ...
   解析后的数据: {...}
   ```

6. **如果AI未返回坐标**
   - 会看到警告：`⚠️ AI未返回坐标信息，将使用地址名称进行地理编码`
   - MapPage 会使用内置的地址匹配
   - 地图应该显示在北京区域的某个位置（使用默认坐标）

### 阶段2：配置AI返回坐标

1. **按照 `Dify工作流配置-返回坐标.md` 配置Dify工作流**

2. **测试AI返回格式**
   在Dify中测试，确保返回格式为：
   ```json
   {
     "fastest": {...},
     "cheapest": {...},
     "coordinates": {
       "start": {"lng": 116.xx, "lat": 40.xx, "address": "..."},
       "end": {"lng": 116.xx, "lat": 39.xx, "address": "..."}
     }
   }
   ```

3. **在应用中重新测试**
   - 输入相同的出发地和目的地
   - 点击规划路线
   - 检查控制台输出

4. **应该看到**
   ```
   ✅ AI路线数据和坐标设置成功 {start: {...}, end: {...}}
   ```

5. **选择路线类型（最快/最省钱）并点击确定**

6. **在MapPage中查看**
   应该看到：
   ```
   MapPage - 路线数据: {start: ..., end: ..., coordinates: {...}}
   MapPage - 起点坐标: {lng: ..., lat: ...}
   MapPage - 终点坐标: {lng: ..., lat: ...}
   ✅ 绘制驾车路线完成
   ```

## 📊 调试检查清单

### goHomePage.jsx 日志检查
- [ ] `正在调用AI接口...` - 显示请求参数
- [ ] `AI返回数据:` - 完整的响应对象
- [ ] `data.data内容:` - data.data 对象
- [ ] `data.data.outputs:` - outputs 对象
- [ ] `AI原始响应:` - 提取的文本/JSON
- [ ] `响应类型:` - string 或 object
- [ ] `解析后的数据:` - 解析后的对象
- [ ] `✅ AI路线数据和坐标设置成功` 或 `⚠️ AI未返回坐标信息`

### MapPage.jsx 日志检查
- [ ] `MapPage - 路线数据:` - 接收到的 routeData
- [ ] `MapPage - 起点坐标:` - 计算得到的起点
- [ ] `MapPage - 终点坐标:` - 计算得到的终点
- [ ] `✅ 绘制驾车路线完成` 或 `❌ 获取驾车数据失败`

### App.jsx 日志检查
- [ ] `App.jsx - 设置路线数据:` - 传递给 MapPage 的完整数据

## 🔍 常见问题排查

### 问题1：AI原始响应为空
**可能原因：**
- Dify 工作流输出配置不正确
- 输出字段名不是 `text`、`result` 或 `output`

**解决方案：**
1. 检查 Dify 工作流的输出节点
2. 确保输出变量名为 `text`
3. 或者在 `goHomePage.jsx` 中添加你的输出字段名

### 问题2：JSON解析失败
**可能原因：**
- AI返回的不是纯JSON
- JSON格式不正确

**解决方案：**
1. 检查 `AI原始响应:` 日志
2. 确保Dify中的LLM只输出JSON，不要有其他文字
3. 验证JSON格式（可以用在线JSON验证工具）

### 问题3：坐标格式不正确
**可能原因：**
- AI返回的坐标字段名不对
- 坐标值不是数字

**解决方案：**
1. 检查 `解析后的数据:` 日志
2. 确保格式为：
   ```json
   {
     "coordinates": {
       "start": {"lng": number, "lat": number},
       "end": {"lng": number, "lat": number}
     }
   }
   ```

### 问题4：地图显示位置不对
**可能原因：**
- 坐标值错误
- 经纬度顺序颠倒

**解决方案：**
1. 检查坐标范围：
   - 中国经度：73-135
   - 中国纬度：18-54
2. 高德地图使用 [经度, 纬度] 顺序
3. 确保使用 GCJ-02 坐标系（火星坐标）

## 📝 测试用例

### 测试用例1：北京市内
```
出发地：北京天安门
目的地：北京故宫
期望坐标：
- 天安门：116.397428, 39.90923
- 故宫：116.397128, 39.917544
```

### 测试用例2：跨城市
```
出发地：北京市
目的地：上海市
期望坐标：
- 北京：116.4074, 39.9042
- 上海：121.4737, 31.2304
```

### 测试用例3：景点
```
出发地：杭州西湖
目的地：杭州灵隐寺
期望坐标：
- 西湖：120.148969, 30.242865
- 灵隐寺：120.099166, 30.242291
```

## 🎯 成功标准

✅ AI接口成功调用并返回数据
✅ 数据格式正确（包含 fastest、cheapest）
✅ 如果AI返回了坐标，正确提取并保存
✅ 坐标正确传递到 MapPage
✅ 地图显示在正确的位置
✅ 路线绘制成功

## 📞 需要帮助？

如果遇到问题，请提供：
1. 完整的控制台日志
2. `AI返回数据:` 的内容
3. `AI原始响应:` 的内容
4. `解析后的数据:` 的内容
5. 错误信息（如果有）

