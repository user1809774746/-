# ğŸ“ å®è—æ™¯ç‚¹åŠŸèƒ½ - å®Œæ•´ä»£ç å­¦ä¹ ç‰ˆ

è¿™ä¸ªæ–‡æ¡£åŒ…å«äº†æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼Œæ–¹ä¾¿ä½ ç›´æ¥å¤åˆ¶å­¦ä¹ ï¼

---

## ğŸ“„ æ–‡ä»¶ 1: `src/App.jsx`

**ä¿®æ”¹è¯´æ˜ï¼šæ·»åŠ å®è—æ™¯ç‚¹çŠ¶æ€ç®¡ç†ï¼Œé¿å…é‡å¤è¯·æ±‚**

å…³é”®ä¿®æ”¹ç‚¹ï¼š
1. ç¬¬ 47-48 è¡Œï¼šæ·»åŠ å®è—æ™¯ç‚¹çŠ¶æ€
2. ç¬¬ 247-254 è¡Œï¼šä¿®æ”¹è·³è½¬åœ°å›¾å‡½æ•°ï¼Œæ¥æ”¶æ™¯ç‚¹æ•°æ®
3. ç¬¬ 304-308 è¡Œï¼šæ·»åŠ å®è—æ™¯ç‚¹æ•°æ®æ›´æ–°å›è°ƒ
4. ç¬¬ 399-405 è¡Œï¼šä¼ é€’æ™¯ç‚¹æ•°æ®ç»™ DiscoverPage
5. ç¬¬ 410-413 è¡Œï¼šä¼ é€’æ™¯ç‚¹æ•°æ®ç»™ DLookMap

```javascript
// src/App.jsx - å…³é”®éƒ¨åˆ†ä»£ç 
import React, { useState, useEffect } from 'react'
// ... å…¶ä»–å¯¼å…¥ ...

function App() {
  const [currentPage, setCurrentPage] = useState('login')
  const [routeData, setRouteData] = useState(null)
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [isAdmin, setIsAdmin] = useState(false)

  const [showKickOutDialog, setShowKickOutDialog] = useState(false)
  const [editingPost, setEditingPost] = useState(null)
  const [selectedPost, setSelectedPost] = useState(null)
  const [selectedTrip, setSelectedTrip] = useState(null)
  
  // å‘ç°é¡µé¢çš„æ—…æ¸¸è·¯çº¿çŠ¶æ€
  const [tripPlansData, setTripPlansData] = useState([])
  const [selectedCityName, setSelectedCityName] = useState('')

  // ğŸŒŸ æ–°å¢ï¼šå®è—æ™¯ç‚¹çŠ¶æ€ç®¡ç†ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
  const [treasureSpotsData, setTreasureSpotsData] = useState([])
  const [treasureUserLocation, setTreasureUserLocation] = useState(null)

  // ... å…¶ä»–çŠ¶æ€å’ŒuseEffect ...

  // ğŸŒŸ ä¿®æ”¹ï¼šæ¥æ”¶æ™¯ç‚¹æ•°æ®å¹¶ä¿å­˜
  const handleNavigateToDLookMap = (data) => {
    console.log('ğŸ“ æ¥æ”¶åˆ°æ™¯ç‚¹æ•°æ®:', data)
    if (data && data.treasureSpots && data.userLocation) {
      setTreasureSpotsData(data.treasureSpots)
      setTreasureUserLocation(data.userLocation)
    }
    setCurrentPage('dlookmap')
  }

  // ğŸŒŸ æ–°å¢ï¼šå®è—æ™¯ç‚¹æ•°æ®æ›´æ–°å›è°ƒ
  const handleTreasureDataUpdate = (spots, location) => {
    console.log('ğŸ”„ æ›´æ–°å®è—æ™¯ç‚¹æ•°æ®:', spots.length, 'ä¸ªæ™¯ç‚¹')
    setTreasureSpotsData(spots)
    setTreasureUserLocation(location)
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ... å…¶ä»–é¡µé¢ ... */}

      {/* ğŸŒŸ å‘ç°é¡µ - ä¼ å…¥å®è—æ™¯ç‚¹æ•°æ® */}
      {currentPage === 'discover' && isAuthenticated && (
        <DiscoverPage 
          onBackToHome={handleBackToHome}
          onNavigateToMine={handleNavigateMine}
          onNavigateToDSreach={handleNavigateToDSreach}
          onNavigateToPostDetail={handleNavigateToPostDetail}
          onNavigateToTripDetail={handleNavigateToTripDetail}
          tripPlans={tripPlansData}
          currentCity={selectedCityName}
          onTripPlansUpdate={setTripPlansData}
          onCityUpdate={setSelectedCityName}
          onNavigateToDLookMap={handleNavigateToDLookMap}
          onNavigateToSelectCity={handleNavigateToSelectCity}
          {/* ğŸŒŸ æ–°å¢ï¼šä¼ é€’å®è—æ™¯ç‚¹æ•°æ® */}
          treasureSpots={treasureSpotsData}
          treasureUserLocation={treasureUserLocation}
          onTreasureDataUpdate={handleTreasureDataUpdate}
        />
      )}

      {/* ğŸŒŸ å‘ç°é¡µé¢çš„åœ°å›¾æŸ¥çœ‹é¡µé¢ - ä¼ å…¥æ™¯ç‚¹æ•°æ® */}
      {currentPage === 'dlookmap' && isAuthenticated && (
        <DLookMap
          onNavigateToDiscover={handleNavigateToDiscover}
          {/* ğŸŒŸ ä¼ é€’ç”¨æˆ·ä½ç½®å’Œæ™¯ç‚¹æ•°æ® */}
          userLocation={treasureUserLocation}
          treasureSpots={treasureSpotsData}
        />
      )}

      {/* ... å…¶ä»–é¡µé¢ ... */}
    </div>
  )
}

export default App
```

---

## ğŸ“„ æ–‡ä»¶ 2: `src/components/DiscoverPage.jsx`

**ä¿®æ”¹è¯´æ˜ï¼šå®ç°å®è—æ™¯ç‚¹æ•°æ®è·å–å’Œæ˜¾ç¤º**

### å…³é”®éƒ¨åˆ† 1: Props å’ŒçŠ¶æ€å®šä¹‰

```javascript
// src/components/DiscoverPage.jsx - Props å®šä¹‰
export default function DiscoverPage({ 
  onNavigateToDSreach, 
  onNavigateToMine, 
  onBack, 
  onNavigateToPostDetail, 
  onNavigateToTripDetail,
  tripPlans: tripPlansFromProps = [],
  currentCity: currentCityFromProps = '',
  onTripPlansUpdate,
  onCityUpdate,
  onNavigateToDLookMap,
  onNavigateToSelectCity,
  // ğŸŒŸ æ–°å¢ï¼šæ¥æ”¶å®è—æ™¯ç‚¹æ•°æ®
  treasureSpots: treasureSpotsFromProps = [],
  treasureUserLocation: treasureUserLocationFromProps = null,
  onTreasureDataUpdate
}){
  // ... å…¶ä»–çŠ¶æ€ ...

  // ğŸŒŸ å®è—æ™¯ç‚¹ - ä¼˜å…ˆä½¿ç”¨App.jsxä¼ å…¥çš„æ•°æ®
  const [localTreasureSpots, setLocalTreasureSpots] = useState([]);
  const [localUserLocation, setLocalUserLocation] = useState(null);
  const [treasureSpotsLoading, setTreasureSpotsLoading] = useState(false);
  const [locationError, setLocationError] = useState(null);

  // ä½¿ç”¨æ¥è‡ªAppçš„æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
  const treasureSpots = onTreasureDataUpdate ? treasureSpotsFromProps : localTreasureSpots;
  const userLocation = onTreasureDataUpdate ? treasureUserLocationFromProps : localUserLocation;
  
  const setTreasureSpots = onTreasureDataUpdate 
    ? (spots) => {
        setLocalTreasureSpots(spots);
        if (onTreasureDataUpdate && userLocation) {
          onTreasureDataUpdate(spots, userLocation);
        }
      }
    : setLocalTreasureSpots;
    
  const setUserLocation = onTreasureDataUpdate
    ? (location) => {
        setLocalUserLocation(location);
        if (onTreasureDataUpdate && treasureSpots) {
          onTreasureDataUpdate(treasureSpots, location);
        }
      }
    : setLocalUserLocation;
```

### å…³é”®éƒ¨åˆ† 2: è·å–ç”¨æˆ·ä½ç½®

```javascript
  // ğŸŒŸ è·å–ç”¨æˆ·å½“å‰ä½ç½®
  const getUserLocation = () => {
    return new Promise((resolve, reject) => {
      if (!window.AMap) {
        // å¦‚æœé«˜å¾·åœ°å›¾APIæœªåŠ è½½ï¼ŒåŠ¨æ€åŠ è½½
        const script = document.createElement('script');
        script.src = amapConfig.getApiUrl(['AMap.Geolocation']);
        script.onload = () => {
          getLocationWithAMap(resolve, reject);
        };
        script.onerror = () => {
          reject(new Error('é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥'));
        };
        document.head.appendChild(script);
      } else {
        getLocationWithAMap(resolve, reject);
      }
    });
  };

  // ğŸŒŸ ä½¿ç”¨é«˜å¾·åœ°å›¾APIè·å–ä½ç½®
  const getLocationWithAMap = (resolve, reject) => {
    window._AMapSecurityConfig = {
      securityJsCode: amapConfig.securityKey,
    };

    window.AMap.plugin('AMap.Geolocation', function() {
      const geolocation = new window.AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
      });

      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          const locationData = {
            lng: result.position.lng,
            lat: result.position.lat,
            address: result.formattedAddress || '',
          };
          console.log('âœ… å®šä½æˆåŠŸ:', locationData);
          resolve(locationData);
        } else {
          console.error('âŒ å®šä½å¤±è´¥:', result);
          reject(new Error(result.message || 'å®šä½å¤±è´¥'));
        }
      });
    });
  };
```

### å…³é”®éƒ¨åˆ† 3: è°ƒç”¨ Dify API è·å–å®è—æ™¯ç‚¹

```javascript
  // ğŸŒŸ è·å–å®è—æ™¯ç‚¹ - è°ƒç”¨Dify API
  const fectcTreasureSpots = async (lng, lat, locationData) => {
    setTreasureSpotsLoading(true);
    setLocationError(null);
    
    try {
      console.log('ğŸ” å¼€å§‹è·å–å®è—æ™¯ç‚¹', { lng, lat });
      
      const response = await fetch(`${DIFY_CONFIG.baseUrl}/run`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${DIFY_CONFIG.apiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          inputs: {
            lng: lng.toString(),
            lat: lat.toString(),
          },
          response_mode: 'blocking',  // ä½¿ç”¨é˜»å¡æ¨¡å¼
          user: 'user-treasure-' + Date.now()
        })
      });
      
      if (!response.ok) {
        throw new Error(`APIè¯·æ±‚å¤±è´¥ ${response.status}`);
      }
      
      const data = await response.json();
      console.log('ğŸ“¦ Difyè¿”å›çš„å®è—æ•°æ®:', data);
      
      // è§£ææ™¯ç‚¹æ•°æ®
      let spots = [];
      if (data.data && data.data.outputs) {
        const outputKey = Object.keys(data.data.outputs)[0];
        const outputValue = data.data.outputs[outputKey];
        
        if (typeof outputValue === 'string') {
          try {
            spots = JSON.parse(outputValue);
          } catch (e) {
            console.error('âŒ è§£æå®è—æ•°æ®å¤±è´¥:', e);
            throw new Error('è§£æå®è—æ•°æ®å¤±è´¥');
          }
        } else if (Array.isArray(outputValue)) {
          spots = outputValue;
        }
      }
      
      console.log('âœ… è§£æåçš„å®è—æ•°æ®:', spots.length, 'ä¸ªæ™¯ç‚¹');
      
      // éªŒè¯æ ¼å¼å¹¶æ›´æ–°æ•°æ®
      if (Array.isArray(spots) && spots.length > 0) {
        setTreasureSpots(spots);
        // ğŸŒŸ åŒæ—¶é€šçŸ¥App.jsxä¿å­˜æ•°æ®
        if (onTreasureDataUpdate && locationData) {
          onTreasureDataUpdate(spots, locationData);
        }
      } else {
        console.warn('âš ï¸ æ²¡æœ‰è·å–åˆ°æ™¯ç‚¹æ•°æ®');
        setTreasureSpots([]);
      }
    } catch (error) {
      console.error('âŒ è·å–å®è—æ™¯ç‚¹å¤±è´¥:', error);
      setLocationError(error.message);
      setTreasureSpots([]);
    } finally {
      setTreasureSpotsLoading(false);
    }   
  };
```

### å…³é”®éƒ¨åˆ† 4: useEffect - é¿å…é‡å¤è¯·æ±‚

```javascript
  // ğŸŒŸ åªåœ¨æ²¡æœ‰æ•°æ®æ—¶æ‰åˆå§‹åŒ–ï¼Œé¿å…é‡å¤è°ƒç”¨
  useEffect(() => {
    const initTreasureSpots = async () => {
      // âœ… å…³é”®ï¼šå¦‚æœå·²ç»æœ‰æ™¯ç‚¹æ•°æ®å’Œä½ç½®æ•°æ®ï¼Œä¸é‡å¤è·å–
      if (treasureSpots.length > 0 && userLocation) {
        console.log('âœ… å·²æœ‰å®è—æ™¯ç‚¹æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      try {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å®è—æ™¯ç‚¹');
        const location = await getUserLocation();
        setUserLocation(location);
        
        // è·å–æ™¯ç‚¹æ•°æ®ï¼Œä¼ å…¥locationç¡®ä¿æ•°æ®åŒæ­¥
        await fectcTreasureSpots(location.lng, location.lat, location);
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å®è—å¤±è´¥', error);
        setLocationError(error.message);
      }
    };
    
    initTreasureSpots();
  }, []); // ç©ºä¾èµ–æ•°ç»„ï¼Œåªåœ¨é¦–æ¬¡æŒ‚è½½æ—¶æ‰§è¡Œ
```

### å…³é”®éƒ¨åˆ† 5: è·³è½¬åœ°å›¾å¹¶ä¼ é€’æ•°æ®

```javascript
  // ğŸŒŸ å¤„ç†"æŸ¥çœ‹åœ°å›¾"ç‚¹å‡»äº‹ä»¶
  const handleViewMap = () => {
    if (onNavigateToDLookMap) {
      // ä¼ é€’æ™¯ç‚¹æ•°æ®å’Œç”¨æˆ·ä½ç½®åˆ°åœ°å›¾é¡µé¢
      onNavigateToDLookMap({
        treasureSpots: treasureSpots,
        userLocation: userLocation
      });
    }
  };
```

### å…³é”®éƒ¨åˆ† 6: UI æ¸²æŸ“ï¼ˆæ™¯ç‚¹åˆ—è¡¨ï¼‰

```jsx
  return (
    <>
      <div className="flex flex-col min-h-screen bg-gray-50">
        {/* ... Header ... */}

        <div className="pt-32 pb-20">
          {/* ... å…¶ä»–å†…å®¹ ... */}

          {/* ğŸŒŸ å®è—æ™¯ç‚¹åˆ—è¡¨ */}
          <div className="px-4 mb-6">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-lg font-semibold text-gray-800">èº«è¾¹çš„å®è—æ™¯ç‚¹</h2>
              <span 
                className="text-sm text-blue-600 cursor-pointer" 
                onClick={handleViewMap}
              >
                æŸ¥çœ‹åœ°å›¾ {'>'}
              </span>
            </div>
            
            {/* åŠ è½½çŠ¶æ€ */}
            {treasureSpotsLoading && (
              <div className="bg-white rounded-lg p-4 shadow-sm mb-4">
                <div className="flex items-center mb-3">
                  <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                  <span className="text-gray-600">æ­£åœ¨åŠ è½½å®è—æ™¯ç‚¹...</span>
                </div>
              </div>
            )}
            
            {/* é”™è¯¯æç¤º */}
            {locationError && !treasureSpotsLoading && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                <div className="flex items-center text-sm text-yellow-800">
                  <i className="fa-solid fa-exclamation-triangle mr-2"></i>
                  <span>åŠ è½½å¤±è´¥ï¼Œ{locationError}</span>
                </div>
              </div>
            )}
            
            {/* æ™¯ç‚¹åˆ—è¡¨ */}
            {!treasureSpotsLoading && treasureSpots.length > 0 && (
              <div className="space-y-3">
                {treasureSpots.map((spot, index) => (
                  <div key={index} className="bg-white rounded-lg p-3 shadow-sm">
                    <div className="flex items-center">
                      <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <i className="fa-solid fa-map-marker-alt text-green-600"></i>
                      </div>
                      <div className="flex-1 min-w-0">
                        <h3 className="text-sm font-medium text-gray-800 mb-1">{spot.name}</h3>
                        <div className="flex items-center text-xs text-gray-500 mt-1">
                          <span className="text-yellow-500 mr-1">â˜…</span>
                          <span className="mr-2">{spot.rating}</span>
                          <span>{spot.distance}</span>
                        </div>
                        {spot.address && (
                          <p className="text-xs text-gray-500 line-clamp-1">
                            <i className="fa-solid fa-location-dot mr-1"></i>
                            {spot.address}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {/* ç©ºçŠ¶æ€ */}
            {!treasureSpotsLoading && !locationError && treasureSpots.length === 0 && (
              <div className="bg-gray-50 rounded-lg p-6 text-center">
                <i className="fa-solid fa-map-location-dot text-3xl text-gray-300 mb-2"></i>
                <p className="text-sm text-gray-500">é™„è¿‘æš‚æ— æ™¯ç‚¹æ•°æ®</p>
              </div>
            )}
          </div>

          {/* ... å…¶ä»–å†…å®¹ ... */}
        </div>
      </div>
    </>
  );
}
```

---

## ğŸ“„ æ–‡ä»¶ 3: `src/components/DLookMap.jsx`

**ä¿®æ”¹è¯´æ˜ï¼šåœ¨åœ°å›¾ä¸Šæ ‡è®°å®è—æ™¯ç‚¹**

### å…³é”®ä¿®æ”¹éƒ¨åˆ†ï¼šæ·»åŠ æ™¯ç‚¹æ ‡è®°

åœ¨ `map.on('complete')` å›è°ƒä¸­æ·»åŠ ï¼š

```javascript
// src/components/DLookMap.jsx - å…³é”®éƒ¨åˆ†

export default function DLookMap({ 
  onNavigateToDiscover, 
  userLocation, 
  treasureSpots = []  // ğŸŒŸ æ¥æ”¶æ™¯ç‚¹æ•°æ®
}) {
  // ... çŠ¶æ€å®šä¹‰ ...
  const markersRef = useRef([]);

  useEffect(() => {
    // ... åœ°å›¾åˆå§‹åŒ–ä»£ç  ...

    const createMapWithGeolocation = () => {
      // ... åˆ›å»ºåœ°å›¾ ...
      
      map.on('complete', function() {
        console.log('âœ… åœ°å›¾åŠ è½½å®Œæˆ');
        mapRef.current = map;
        setMapLoaded(true);
        setLocationStatus('åœ°å›¾åŠ è½½æˆåŠŸ');
        
        // å¦‚æœå·²æœ‰ç”¨æˆ·ä½ç½®
        if (userLocation && userLocation.lng && userLocation.lat) {
          const position = [userLocation.lng, userLocation.lat];
          map.setCenter(position);
          
          // ğŸŒŸ æ·»åŠ ç”¨æˆ·ä½ç½®æ ‡è®°ç‚¹ï¼ˆè“è‰²ï¼‰
          const userMarker = new window.AMap.Marker({
            position: position,
            title: 'æˆ‘çš„ä½ç½®',
            icon: new window.AMap.Icon({
              size: new window.AMap.Size(32, 32),
              image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
              imageSize: new window.AMap.Size(32, 32)
            })
          });
          map.add(userMarker);
          markersRef.current.push(userMarker);
          
          setLocationStatus('å®šä½æˆåŠŸ');
          setLocationResult(`ä½ç½®ï¼š${userLocation.address || `ç»åº¦${userLocation.lng}, çº¬åº¦${userLocation.lat}`}`);
          
          // ğŸŒŸ æ·»åŠ å®è—æ™¯ç‚¹æ ‡è®°
          if (treasureSpots && treasureSpots.length > 0) {
            addTreasureMarkers(map, treasureSpots);
          }
        }
      });
    };

    // ğŸŒŸ æ·»åŠ å®è—æ™¯ç‚¹æ ‡è®°åˆ°åœ°å›¾
    const addTreasureMarkers = (map, spots) => {
      console.log('ğŸ—ºï¸ å¼€å§‹æ·»åŠ æ™¯ç‚¹æ ‡è®°ï¼Œæ•°é‡:', spots.length);
      
      spots.forEach((spot, index) => {
        if (spot.lng && spot.lat) {
          const position = [parseFloat(spot.lng), parseFloat(spot.lat)];
          
          // åˆ›å»ºæ ‡è®°ç‚¹ï¼ˆçº¢è‰²ï¼‰
          const marker = new window.AMap.Marker({
            position: position,
            title: spot.name,
            icon: new window.AMap.Icon({
              size: new window.AMap.Size(28, 28),
              image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
              imageSize: new window.AMap.Size(28, 28)
            })
          });
          
          // ğŸŒŸ åˆ›å»ºä¿¡æ¯çª—ä½“
          const infoContent = `
            <div style="padding: 10px; min-width: 200px;">
              <h3 style="margin: 0 0 8px 0; font-size: 14px; font-weight: bold; color: #333;">
                ${spot.name}
              </h3>
              <div style="font-size: 12px; color: #666; line-height: 1.6;">
                <div style="margin-bottom: 4px;">
                  <span style="color: #FFB800;">â˜…</span> 
                  <span style="font-weight: 500;">${spot.rating}</span>
                  <span style="margin-left: 8px; color: #999;">${spot.distance}</span>
                </div>
                ${spot.address ? `
                  <div style="margin-top: 6px; color: #888;">
                    <i class="fa-solid fa-location-dot" style="margin-right: 4px;"></i>
                    ${spot.address}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
          
          const infoWindow = new window.AMap.InfoWindow({
            content: infoContent,
            offset: new window.AMap.Pixel(0, -30)
          });
          
          // ğŸŒŸ ç‚¹å‡»æ ‡è®°æ˜¾ç¤ºä¿¡æ¯çª—ä½“
          marker.on('click', () => {
            infoWindow.open(map, position);
          });
          
          map.add(marker);
          markersRef.current.push(marker);
          
          console.log(`âœ… æ ‡è®° ${index + 1}: ${spot.name} - [${spot.lng}, ${spot.lat}]`);
        }
      });
      
      // ğŸŒŸ è‡ªåŠ¨è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
      if (markersRef.current.length > 0) {
        map.setFitView(markersRef.current);
      }
    };

    initMap();

    // ğŸŒŸ æ¸…ç†å‡½æ•° - æ¸…é™¤æ‰€æœ‰æ ‡è®°
    return () => {
      markersRef.current.forEach(marker => {
        marker.setMap(null);
      });
      markersRef.current = [];
      
      if (mapRef.current) {
        try {
          mapRef.current.destroy();
        } catch (error) {
          console.warn('åœ°å›¾é”€æ¯é”™è¯¯:', error);
        } finally {
          mapRef.current = null;
          setMapLoaded(false);
        }
      }
    };
  }, [userLocation, treasureSpots]); // ğŸŒŸ ä¾èµ–æ™¯ç‚¹æ•°æ®

  return (
    <div className="flex flex-col min-h-screen bg-white">
      {/* é¡¶éƒ¨å¯¼èˆªæ  */}
      <div className="fixed top-0 left-0 right-0 z-10 bg-white shadow-sm">
        <div className="flex items-center px-4 py-3">
          <button onClick={onNavigateToDiscover} className="mr-3">
            <i className="fa-solid fa-arrow-left text-xl text-gray-600"></i>
          </button>
          <h1 className="text-lg font-bold text-gray-800">é™„è¿‘å®è—æ™¯ç‚¹</h1>
          {/* ğŸŒŸ æ˜¾ç¤ºæ™¯ç‚¹æ•°é‡ */}
          <div className="ml-auto text-sm text-gray-600">
            {treasureSpots.length > 0 && `${treasureSpots.length} ä¸ªæ™¯ç‚¹`}
          </div>
        </div>
      </div>

      {/* åœ°å›¾å®¹å™¨ */}
      <div className="pt-14 flex-grow relative">
        <div 
          ref={mapContainerRef}
          className="absolute inset-0 w-full h-full"
        />
        
        {/* ... åŠ è½½çŠ¶æ€å’Œå®šä½ä¿¡æ¯ ... */}
      </div>
    </div>
  );
}
```

---

## ğŸ¯ å­¦ä¹ è¦ç‚¹æ€»ç»“

### 1. **çŠ¶æ€æå‡ï¼ˆState Liftingï¼‰**
```javascript
// åœ¨ App.jsx ä¸­ç®¡ç†å…±äº«çŠ¶æ€
const [treasureSpotsData, setTreasureSpotsData] = useState([])
const [treasureUserLocation, setTreasureUserLocation] = useState(null)

// é€šè¿‡ props ä¼ é€’ç»™å­ç»„ä»¶
<DiscoverPage treasureSpots={treasureSpotsData} />
<DLookMap treasureSpots={treasureSpotsData} />
```

### 2. **é¿å…é‡å¤è¯·æ±‚**
```javascript
// åœ¨ useEffect ä¸­æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
if (treasureSpots.length > 0 && userLocation) {
  console.log('âœ… å·²æœ‰æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–');
  return;
}
```

### 3. **å¼‚æ­¥æ•°æ®è·å–**
```javascript
// 1. è·å–ä½ç½®
const location = await getUserLocation();

// 2. è°ƒç”¨ API
await fectcTreasureSpots(location.lng, location.lat, location);

// 3. æ›´æ–°çŠ¶æ€å¹¶é€šçŸ¥çˆ¶ç»„ä»¶
setTreasureSpots(spots);
onTreasureDataUpdate(spots, location);
```

### 4. **æ•°æ®ä¼ é€’**
```javascript
// DiscoverPage â†’ App.jsx
onTreasureDataUpdate(spots, location);

// App.jsx â†’ DLookMap
onNavigateToDLookMap({ treasureSpots, userLocation });
```

### 5. **åœ°å›¾æ ‡è®°ç®¡ç†**
```javascript
// ä½¿ç”¨ ref å­˜å‚¨æ ‡è®°
const markersRef = useRef([]);

// æ·»åŠ æ ‡è®°
markersRef.current.push(marker);

// æ¸…ç†æ ‡è®°
markersRef.current.forEach(marker => marker.setMap(null));
```

---

## ğŸš€ å®Œæ•´çš„å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·è¿›å…¥ DiscoverPage
   â†“
2. useEffect æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
   â”œâ”€ æœ‰æ•°æ® â†’ ç›´æ¥æ˜¾ç¤º âœ…
   â””â”€ æ— æ•°æ® â†’ ç»§ç»­è·å–
   â†“
3. è°ƒç”¨ getUserLocation() è·å–ä½ç½®
   â†“
4. è°ƒç”¨ fectcTreasureSpots() è·å–æ™¯ç‚¹
   â†“
5. æ›´æ–°æœ¬åœ°çŠ¶æ€ + é€šçŸ¥ App.jsx
   â†“
6. æ˜¾ç¤ºæ™¯ç‚¹åˆ—è¡¨
   â†“
7. ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹åœ°å›¾"
   â†“
8. handleViewMap() ä¼ é€’æ•°æ®åˆ° App.jsx
   â†“
9. App.jsx ä¿å­˜æ•°æ®å¹¶è·³è½¬åˆ° DLookMap
   â†“
10. DLookMap æ¥æ”¶æ•°æ®å¹¶åœ¨åœ°å›¾ä¸Šæ ‡è®°
    â†“
11. ç”¨æˆ·ç‚¹å‡»è¿”å›
    â†“
12. è¿”å› DiscoverPage
    â†“
13. useEffect æ£€æµ‹åˆ°å·²æœ‰æ•°æ®
    â†“
14. ç›´æ¥æ˜¾ç¤ºï¼Œä¸é‡å¤è¯·æ±‚ API âœ…
```

---

## ğŸ“ è°ƒè¯•æŠ€å·§

### æ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹
```javascript
// é¦–æ¬¡åŠ è½½åº”è¯¥çœ‹åˆ°ï¼š
ğŸš€ å¼€å§‹åˆå§‹åŒ–å®è—æ™¯ç‚¹
âœ… å®šä½æˆåŠŸ: {lng: ..., lat: ..., address: ...}
ğŸ” å¼€å§‹è·å–å®è—æ™¯ç‚¹ {lng: ..., lat: ...}
ğŸ“¦ Difyè¿”å›çš„å®è—æ•°æ®: {...}
âœ… è§£æåçš„å®è—æ•°æ®: 5 ä¸ªæ™¯ç‚¹
ğŸ”„ æ›´æ–°å®è—æ™¯ç‚¹æ•°æ®: 5 ä¸ªæ™¯ç‚¹

// æŸ¥çœ‹åœ°å›¾åº”è¯¥çœ‹åˆ°ï¼š
ğŸ“ æ¥æ”¶åˆ°æ™¯ç‚¹æ•°æ®: {treasureSpots: Array(5), userLocation: {...}}
ğŸ—ºï¸ å¼€å§‹æ·»åŠ æ™¯ç‚¹æ ‡è®°ï¼Œæ•°é‡: 5
âœ… æ ‡è®° 1: é²¨é±¼å…¬å›­(å‹’æ³°ä¸­å¿ƒ) - [114.508, 38.042]
...

// è¿”å›æ—¶åº”è¯¥çœ‹åˆ°ï¼š
âœ… å·²æœ‰å®è—æ™¯ç‚¹æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–
```

---

ğŸ‰ **å®Œæ•´ä»£ç å·²ç»æä¾›ï¼ç›´æ¥å¤åˆ¶åˆ°å¯¹åº”æ–‡ä»¶å³å¯ä½¿ç”¨ï¼**


