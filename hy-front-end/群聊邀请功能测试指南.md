# 群聊邀请功能测试指南

> **状态**：✅ 后端已实现，前端已集成  
> **测试时间**：2025-12-10  
> **测试环境**：localhost:8082 (后端) + localhost:3000 (前端)

---

## ✅ 功能状态

### 后端已实现

1. ✅ **WebSocket 推送通知**
   - 创建群聊时自动推送给所有被邀请的好友
   - 消息类型：`group_invitation`
   - 包含群信息、邀请人信息

2. ✅ **获取邀请列表**
   - 接口：`GET /api/group/my-invitations`
   - 返回最近7天的邀请通知

3. ✅ **标记已读**
   - 接口：`POST /api/group/invitations/{groupId}/read`

### 前端已集成

1. ✅ **WebSocket 监听器**
   - 已在 `GroupChatPage.jsx` 中注册
   - 监听 `group_invitation` 消息
   - 收到通知后弹窗提示并刷新列表

2. ✅ **API 函数**
   - `getMyInvitations()` - 获取邀请列表
   - `markInvitationAsRead(groupId)` - 标记已读

3. ✅ **调试日志**
   - 完整的日志输出
   - 便于追踪问题

---

## 🧪 测试步骤

### 准备工作

1. **启动后端**
   ```bash
   # 确保后端运行在 http://localhost:8082
   mvn spring-boot:run
   ```

2. **启动前端**
   ```bash
   # 确保前端运行在 http://localhost:3000
   npm run dev
   ```

3. **准备两个测试账号**
   - 用户A（创建者）：userId=1
   - 用户B（被邀请者）：userId=2

---

### 测试场景 1：实时 WebSocket 通知

#### 步骤1：用户B 登录并打开群聊页面

1. 使用**无痕窗口或不同浏览器**（避免 session 冲突）
2. 登录用户B账号
3. 打开群聊页面（"消息" → "群聊"）
4. **打开控制台（F12）**

**预期看到的日志**：
```
🔌 正在初始化WebSocket连接, 用户ID: 2
📡 WebSocket未连接，正在连接...
✅ WebSocket连接成功
✅ 已注册监听: GROUP_INVITATION
✅ 已注册监听: MEMBER_JOINED
✅ 已注册监听: GROUP_NOTIFICATION
🎯 WebSocket初始化完成，等待接收消息...
```

#### 步骤2：用户A 创建群聊并邀请用户B

1. 使用**另一个浏览器**
2. 登录用户A账号
3. 打开群聊页面
4. 点击"创建群聊"
5. 输入群名称："测试群聊"
6. 选择用户B
7. 点击"创建"

**用户A 控制台应显示**：
```
🎯 开始创建群聊
📝 群名称: 测试群聊
👥 选择的好友ID列表: [2]
👥 选择的好友详情: [{id: 2, nickname: "用户B"}]
✅ 创建群聊响应: {code: 200, message: "群聊创建成功", ...}
🎉 群聊创建成功！
📊 群聊信息: {groupId: 1, groupName: "测试群聊", currentMembers: 2}
⚠️ 后端应该已向以下用户ID发送WebSocket通知: [2]
```

#### 步骤3：观察用户B 收到通知

**用户B 控制台应显示**：
```
📬 收到群聊邀请通知 - 原始数据: {
  type: "group_invitation",
  data: {
    groupId: 1,
    groupName: "测试群聊",
    inviterId: 1,
    inviterName: "用户A",
    currentMembers: 2,
    ...
  }
}
📬 解析后的邀请数据: {groupId: 1, groupName: "测试群聊", ...}
🎉 显示邀请通知: 您被邀请加入群聊：测试群聊\n邀请人：用户A
🔄 刷新群聊列表...
```

**用户B 浏览器应显示**：
- ✅ 弹出提示框："您被邀请加入群聊：测试群聊 邀请人：用户A"
- ✅ 群聊列表自动刷新，显示新群聊
- ✅ 群聊卡片显示"测试群聊"

---

### 测试场景 2：获取邀请列表

#### 测试方法

在浏览器控制台输入：

```javascript
// 导入API函数（如果已在全局作用域）
const response = await fetch('http://localhost:8082/api/group/my-invitations?userId=2', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});
const data = await response.json();
console.log('邀请列表:', data);
```

**预期响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "notificationId": 1,
      "groupId": 1,
      "groupName": "测试群聊",
      "memberCount": 2,
      "inviterId": 1,
      "inviterName": "用户A",
      "joinTime": "2025-12-10 16:30:00",
      "hasRead": false,
      "status": "accepted"
    }
  ]
}
```

---

### 测试场景 3：标记已读

#### 测试方法

在浏览器控制台输入：

```javascript
const response = await fetch('http://localhost:8082/api/group/invitations/1/read?userId=2', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  }
});
const data = await response.json();
console.log('标记已读结果:', data);
```

**预期响应**：
```json
{
  "code": 200,
  "message": "邀请通知已标记为已读",
  "data": null
}
```

---

## 🔍 问题排查

### 问题1：用户B 没有收到通知

#### 检查清单

1. **检查 WebSocket 连接状态**
   
   在用户B的控制台查找：
   ```
   ✅ WebSocket连接成功
   ✅ 已注册监听: GROUP_INVITATION
   ```
   
   如果没有看到，说明 WebSocket 未连接。

2. **检查后端是否发送了通知**
   
   查看后端日志，应该有：
   ```
   已向用户 2 发送群聊邀请通知, 群聊ID: 1, 群名: 测试群聊
   ```

3. **检查用户B是否在线**
   
   确保用户B的浏览器页面是打开的，且 WebSocket 连接活跃。

4. **检查网络连接**
   
   - 确保前端能访问 `ws://localhost:8082/ws/chat`
   - 检查浏览器控制台的 Network 标签，确认 WebSocket 连接成功

### 问题2：群聊列表没有刷新

#### 检查清单

1. **检查 loadGroups() 是否被调用**
   
   控制台应显示：
   ```
   🔄 刷新群聊列表...
   ```

2. **检查后端接口**
   
   手动调用：
   ```javascript
   const response = await fetch('http://localhost:8082/api/group/my-groups?userId=2', {
     headers: { 'Authorization': `Bearer ${token}` }
   });
   console.log(await response.json());
   ```

### 问题3：邀请列表为空

#### 可能原因

1. **时间范围限制**
   - 只显示最近7天的邀请
   - 确认创建时间在7天内

2. **状态过滤**
   - 只显示 `status = 'active'` 的群
   - 确认群聊未被解散

3. **权限过滤**
   - 不显示自己创建的群（群主）
   - 只显示用户当前是成员的群

---

## 📊 完整测试矩阵

| 测试项 | 操作 | 预期结果 | 实际结果 | 状态 |
|--------|------|----------|----------|------|
| WebSocket连接 | 登录并进入群聊页面 | 控制台显示"WebSocket连接成功" | | ⬜ |
| 注册监听器 | 自动注册 | 控制台显示"已注册监听: GROUP_INVITATION" | | ⬜ |
| 创建群聊 | 用户A创建群聊邀请用户B | 返回成功响应 | | ⬜ |
| 推送通知 | 后端自动推送 | 用户B收到WebSocket消息 | | ⬜ |
| 弹窗提示 | 前端处理消息 | 显示"您被邀请加入群聊" | | ⬜ |
| 刷新列表 | 自动刷新 | 群聊列表显示新群聊 | | ⬜ |
| 获取邀请列表 | 调用API | 返回邀请数据 | | ⬜ |
| 标记已读 | 调用API | 返回成功响应 | | ⬜ |
| 进入群聊 | 点击群聊卡片 | 跳转到群聊对话页面 | | ⬜ |
| 发送消息 | 在群聊中发送消息 | 消息成功发送和接收 | | ⬜ |

---

## 🎯 验收标准

### 必须通过

1. ✅ 用户A创建群聊后，用户B立即收到弹窗通知
2. ✅ 用户B的群聊列表自动刷新并显示新群聊
3. ✅ 控制台日志完整且无错误
4. ✅ 用户B可以进入群聊并发送消息

### 可选功能

- ⬜ 邀请列表页面（未实现UI）
- ⬜ 标记已读功能（未实现UI）
- ⬜ 通知中心（未实现UI）

---

## 🚀 下一步计划

### 短期（可选）

1. **创建邀请通知列表页面**
   - 显示所有未读邀请
   - 支持一键加入
   - 支持标记已读

2. **优化通知样式**
   - 使用 Toast 组件替代 alert
   - 添加图标和动画
   - 支持点击跳转

### 长期（可选）

1. **通知中心**
   - 统一管理所有通知
   - 支持通知历史
   - 支持通知设置

2. **离线消息**
   - 用户离线时保存通知
   - 上线后批量推送
   - 支持消息持久化

---

## 📝 测试记录

### 测试人员：_________

### 测试日期：2025-12-10

### 测试结果

| 测试轮次 | 时间 | 结果 | 备注 |
|---------|------|------|------|
| 第1轮 | __:__ | ⬜通过 / ⬜失败 | |
| 第2轮 | __:__ | ⬜通过 / ⬜失败 | |
| 第3轮 | __:__ | ⬜通过 / ⬜失败 | |

### 发现的问题

1. _________________________________________________
2. _________________________________________________
3. _________________________________________________

### 解决方案

1. _________________________________________________
2. _________________________________________________
3. _________________________________________________

---

## 📞 联系方式

**问题反馈**：
- 前端问题：查看控制台日志
- 后端问题：查看后端日志
- WebSocket问题：检查 Network 标签

**调试技巧**：
```javascript
// 查看 WebSocket 状态
console.log('WebSocket 连接:', webSocketService.isConnected);

// 手动触发通知（测试用）
webSocketService.emit('group_invitation', {
  type: 'group_invitation',
  data: {
    groupId: 1,
    groupName: '测试群',
    inviterId: 1,
    inviterName: '测试用户'
  }
});

// 查看已注册的监听器
console.log('监听器列表:', Object.keys(webSocketService.handlers));
```

---

**文档版本**：v1.0  
**最后更新**：2025-12-10 16:30  
**测试状态**：⏳ 待测试
