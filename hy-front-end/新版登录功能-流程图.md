# 新版七天免密登录 - 流程图

## 📊 完整登录流程图

```
┌─────────────────────────────────────────────────────────────┐
│                       用户访问系统                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│               App.jsx 启动检查                                │
│   检查 localStorage 是否有 token, phone, userType             │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
   有完整信息                     没有信息
        │                           │
        ▼                           ▼
┌───────────────┐          ┌──────────────────┐
│ 调用          │          │ 跳转到登录页      │
│ getUserProfile│          │ isAuthenticated   │
│ 验证token     │          │ = false          │
└───────┬───────┘          └────────┬─────────┘
        │                           │
   ┌────┴────┐                      │
   │         │                      │
   ▼         ▼                      │
 成功      失败                     │
   │         │                      │
   ▼         │                      │
┌──────┐     │                      │
│进入  │     └──────────────────────┘
│系统  │                            │
└──────┘                            ▼
                        ┌────────────────────────┐
                        │  LoginPage 加载        │
                        │  检查本地是否有token    │
                        └───────────┬────────────┘
                                    │
                          ┌─────────┴─────────┐
                          │                   │
                          ▼                   ▼
                      有token              没有token
                          │                   │
                          ▼                   ▼
                  ┌───────────────┐    ┌──────────────┐
                  │ 显示加载提示   │    │ 显示登录表单 │
                  │"正在自动登录"  │    │ 等待用户输入 │
                  └───────┬───────┘    └──────────────┘
                          │
                          ▼
                  ┌───────────────┐
                  │ 调用smartLogin│
                  │ 携带token参数 │
                  └───────┬───────┘
                          │
                    ┌─────┴─────┐
                    │           │
                    ▼           ▼
                  成功        失败
                    │           │
                    ▼           ▼
            ┌──────────┐  ┌──────────────┐
            │ 进入系统 │  │ 显示登录表单 │
            └──────────┘  │ 可能显示免密 │
                          │ 登录按钮     │
                          └──────────────┘
```

---

## 🔄 自动登录详细流程

```
┌─────────────────────────────────────────┐
│    LoginPage.useEffect() 启动           │
│    检测到有 token + phone               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│    调用 smartLogin(phone, type, token)  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│    调用 autoLogin(phone, type, token)   │
│    POST /api/auth/auto-login            │
│    Body: { phone, userType, token }     │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         后端验证流程                     │
│  1. 验证JWT格式                         │
│  2. 从数据库查询activeToken             │
│  3. 比对: 请求token === activeToken?    │
│  4. 检查: token是否过期?                │
└─────────────────┬───────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
    验证通过             验证失败
        │                   │
        ▼                   ▼
┌───────────────┐    ┌──────────────────┐
│ 返回200       │    │ 返回401          │
│ 返回原token   │    │ Token失效/过期   │
└───────┬───────┘    └────────┬─────────┘
        │                     │
        ▼                     ▼
┌───────────────┐    ┌──────────────────┐
│ 前端保存数据  │    │ 前端清除token    │
│ 跳转到主页    │    │ 显示登录表单     │
└───────────────┘    └──────────────────┘
```

---

## 🔐 顶号机制流程

```
时间线：
─────────────────────────────────────────────────────→

设备A                           设备B                    设备A
  │                              │                        │
  ▼                              │                        │
登录成功                         │                        │
tokenA 生成                      │                        │
数据库: activeToken = tokenA     │                        │
  │                              │                        │
  │                              ▼                        │
  │                           登录成功                    │
  │                           tokenB 生成                 │
  │                           数据库: activeToken = tokenB│
  │                           （覆盖tokenA）              │
  │                              │                        │
  │                              │                        ▼
  │                              │                    发起任何请求
  │                              │                    携带tokenA
  │                              │                        │
  │                              │                        ▼
  │                              │                 后端验证:
  │                              │                 tokenA ≠ activeToken(tokenB)
  │                              │                        │
  │                              │                        ▼
  │                              │                    返回401错误
  │                              │                        │
  │                              │                        ▼
  │                              │                 前端拦截401
  │                              │                 弹出顶号提示
  │                              │                 清除本地数据
  │                              │                 跳转登录页
  │                              │                        │
  ▼                              ▼                        ▼
 正常使用                      正常使用                 被踢出
 tokenB有效                    tokenB有效              需重新登录
```

---

## 🎯 请求拦截器流程

```
┌─────────────────────────────────────────┐
│      用户发起任何API请求                 │
│      (发现页、地图、我的等)               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         apiRequest() 拦截器              │
│  1. 从localStorage获取token             │
│  2. 添加到请求头: Authorization: Bearer  │
│  3. 发送请求到后端                       │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│          后端验证token                   │
│  JwtAuthenticationFilter拦截             │
│  validateToken(token, phone, userType)   │
└─────────────────┬───────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
    token有效            token失效
        │                   │
        ▼                   ▼
┌───────────────┐    ┌──────────────────┐
│ 返回正常数据  │    │ 返回401 Unauthorized│
│ Status: 200   │    │ "Token已失效"    │
└───────────────┘    └────────┬─────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ apiRequest拦截401│
                    │ handleTokenExpired│
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ 清除localStorage │
                    │ - auth_token     │
                    │ - user_phone     │
                    │ - user_type      │
                    │ - login_time     │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ 调用顶号处理回调  │
                    │ tokenKickOutHandler│
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ 显示友好提示     │
                    │ "账号在其他设备  │
                    │  登录"           │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ 跳转到登录页     │
                    └──────────────────┘
```

---

## 📝 Token验证判断逻辑

```
┌──────────────────────────────────────────┐
│      后端TokenService.validateToken      │
└─────────────────┬────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  1. 验证JWT格式                          │
│     JwtUtil.validateToken(token)         │
└─────────────────┬───────────────────────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
         有效        无效 → 返回false
            │
            ▼
┌─────────────────────────────────────────┐
│  2. 从数据库查询用户                     │
│     User user = userRepository.find()    │
└─────────────────┬───────────────────────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
        找到用户     未找到 → 返回false
            │
            ▼
┌─────────────────────────────────────────┐
│  3. 获取数据库中的activeToken            │
│     String dbToken = user.getActiveToken()│
└─────────────────┬───────────────────────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
       dbToken存在   不存在 → 返回false
            │
            ▼
┌─────────────────────────────────────────┐
│  4. 比对token                            │
│     requestToken === dbToken?            │
└─────────────────┬───────────────────────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
         相同      不相同 → 返回false (被顶号)
            │
            ▼
┌─────────────────────────────────────────┐
│  5. 检查是否过期                         │
│     now > token_expires_at?              │
└─────────────────┬───────────────────────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
        未过期      已过期 → 返回false
            │
            ▼
┌─────────────────────────────────────────┐
│         ✅ 验证通过                      │
│         返回true                         │
└─────────────────────────────────────────┘
```

---

## 🎨 用户界面状态流转

```
┌──────────────┐
│  初始状态    │
│  (空白页面)  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  检查中...   │
│  (无界面)    │
└──────┬───────┘
       │
   ┌───┴────────────────┐
   │                    │
   ▼                    ▼
有token              没有token
   │                    │
   ▼                    ▼
┌──────────────┐   ┌──────────────┐
│ 加载提示     │   │ 登录表单     │
│ "正在自动    │   │ - 手机号     │
│  登录..."    │   │ - 密码/验证码│
│ (全屏遮罩)   │   │ - 登录按钮   │
└──────┬───────┘   └──────┬───────┘
       │                  │
   ┌───┴───┐             登录
   │       │              │
   ▼       ▼              ▼
 成功    失败        ┌──────────────┐
   │       │        │  登录成功    │
   │       ▼        └──────┬───────┘
   │  ┌──────────────┐     │
   │  │ 登录表单     │     │
   │  │ + 免密按钮   │     │
   │  └──────────────┘     │
   │                       │
   └───────────────────────┘
                 │
                 ▼
        ┌──────────────┐
        │   主页面     │
        │  (系统界面)  │
        └──────┬───────┘
               │
         ┌─────┴──────┐
         │            │
         ▼            ▼
      继续使用      被顶号
         │            │
         │            ▼
         │   ┌──────────────┐
         │   │  顶号提示框  │
         │   │ "账号在其他  │
         │   │  设备登录"   │
         │   └──────┬───────┘
         │          │
         │          ▼
         │   ┌──────────────┐
         └──►│  登录表单    │
             └──────────────┘
```

---

## 🎉 总结

这些流程图展示了：

1. **完整登录流程** - 从用户访问到成功进入系统
2. **自动登录详细流程** - smartLogin的内部实现
3. **顶号机制流程** - 时间线展示顶号发生过程
4. **请求拦截器流程** - 401错误的完整处理链路
5. **Token验证逻辑** - 后端验证的详细步骤
6. **用户界面流转** - 用户看到的界面状态变化

通过这些流程图，您可以清晰地理解整个系统的运作机制！🚀

