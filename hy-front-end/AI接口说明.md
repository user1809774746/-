# AI接口对接说明

## 接口信息
- **地址**: `POST https://api.dify.ai/v1/workflows/3d53d609-922a-42bc-92ff-3807de965a31/run`
- **认证**: Bearer Token `app-pzlH8kd5K6AgphI5B5qnMQKD`
- **响应模式**: blocking（阻塞模式）

## 请求格式

```json
{
  "inputs": {
    "query": "我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费"
  },
  "response_mode": "blocking",
  "user": "user-1234567890"
}
```

**字段说明**：
- `inputs.query`: 组合后的完整查询文本
- `response_mode`: 固定为 "blocking"（阻塞模式）
- `user`: 用户标识（自动生成）

**查询文本格式**：
```
我要通过{出行方式}从{出发地}到{目的地}，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费
```

**示例**：
- `我要通过地铁从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费`
- `我要通过步行从天安门到故宫，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费`

## 期望AI返回的数据格式

为了让前端正确解析和显示，AI应该返回以下JSON格式的数据：

```json
{
  "fastest": {
    "time": "时间：20分钟",
    "description": "路径：经过3个红绿灯",
    "cost": "费用：停车费约￥10.00"
  },
  "cheapest": {
    "time": "时间：30分钟",
    "description": "路径：避开收费路段,经过4个红绿灯",
    "cost": "费用：停车费约￥8.00"
  }
}
```

### 数据结构说明

- **fastest**: 最快路线方案
  - `time`: 时间信息，格式：`"时间：XX分钟"` 或 `"时间：X小时XX分钟"`
  - `description`: 详细路径描述
  - `cost`: 费用信息，格式：`"费用：￥XX.XX"` 或 `"费用：免费"`

- **cheapest**: 最省钱路线方案
  - `time`: 时间信息
  - `description`: 详细路径描述
  - `cost`: 费用信息

## 实际API响应路径

根据Dify API的标准响应，数据可能在以下路径中：
- `data.data.outputs.text` - 文本输出
- `data.data.outputs.result` - 结果输出

代码会自动尝试解析这些路径。

## 不同出行方式的示例

### 地铁
```json
{
  "fastest": {
    "time": "时间：35分钟",
    "description": "路线：地铁2号线→地铁10号线",
    "cost": "费用：￥5.00"
  },
  "cheapest": {
    "time": "时间：52分钟",
    "description": "路线：地铁2号线->公交10号->步行2公里",
    "cost": "费用：￥3.00"
  }
}
```

### 步行
```json
{
  "fastest": {
    "time": "时间：1小时20分钟",
    "description": "路径：途经长安街，全程5.3公里",
    "cost": "费用：免费"
  },
  "cheapest": {
    "time": "时间：1小时50分钟",
    "description": "路径：途经长安2街，全程5.5公里",
    "cost": "费用：免费"
  }
}
```

## 错误处理

如果AI接口调用失败或返回数据格式不正确，前端会：
1. 自动使用默认数据（预设的路线方案）
2. 显示Toast提示：`"AI服务暂时不可用，使用默认路线数据"`
3. 继续正常显示弹窗和路线选择

## Dify 工作流配置

### 输入变量配置

在Dify工作流中，只需要配置**1个输入变量**：

| 变量名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| query | String | 完整的查询文本 | 我要通过自驾从北京到上海，给我生成... |

**前端会自动组合用户输入为一句话**，无需多个变量。

### 输出格式配置

工作流的最终输出节点应该返回JSON格式：

```json
{
  "fastest": {
    "time": "时间：20分钟",
    "description": "路径：经过3个红绿灯",
    "cost": "费用：停车费约￥10.00"
  },
  "cheapest": {
    "time": "时间：30分钟",
    "description": "路径：避开收费路段,经过4个红绿灯",
    "cost": "费用：停车费约￥8.00"
  }
}
```

### 常见配置错误

1. **400 Bad Request**
   - ❌ 输入变量名不匹配
   - ✅ 确保Dify中的变量名与请求中的字段名完全一致

2. **401 Unauthorized**
   - ❌ API密钥错误
   - ✅ 检查Bearer Token是否正确

3. **返回数据无法解析**
   - ❌ 输出格式不是JSON
   - ✅ 在Dify工作流最后添加JSON格式化节点

---

## 调试建议

### 1. 查看控制台日志

打开浏览器开发者工具（F12），在 Console 标签页查看：
- `"正在调用AI接口..."` - 显示请求参数
- `"请求参数:"` - 完整的请求体
- `"AI返回数据:"` - 完整的API响应
- `"AI接口错误响应:"` - 详细的错误信息（400/401等）
- `"AI原始响应:"` - AI返回的原始文本
- `"调用AI接口出错:"` - 错误信息

### 2. 检查网络请求

在开发者工具的 Network 标签页：
- 筛选 `api.dify.ai` 请求
- 查看请求状态码（应该是 200）
- 查看请求体（Request Payload）
- 查看响应数据（Response）

### 3. 常见问题

**问题**: 看到 `chrome-extension://...` 的请求错误
- **解答**: 这是浏览器扩展的请求，与AI接口无关，可以忽略

**问题**: `X-Content-Type-Options` 缺失警告
- **解答**: 这是服务器端的安全响应头，需要Dify后端配置，不影响功能

**问题**: CORS 跨域错误
- **解答**: 需要检查API密钥是否正确，或联系Dify支持

### 4. 确保AI返回标准JSON格式

在Dify工作流中配置输出格式为JSON

## 前端调用流程

1. 用户输入出发地、目的地
2. 选择出行方式
3. 点击"一键规划路线"按钮
4. 前端显示弹窗和加载动画
5. 调用AI接口（传入组合后的提示词）
6. 等待AI返回数据
7. 解析并显示路线方案
8. 用户选择方案后点击"确定"
9. 跳转到地图页面展示具体路线

