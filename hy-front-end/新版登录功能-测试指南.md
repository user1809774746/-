# 新版七天免密登录 - 测试指南

## 🎯 测试目标

验证新版七天免密登录和顶号机制是否正常工作。

## 🧪 测试环境准备

### 1. 启动项目
```bash
npm run dev
```

### 2. 准备测试账号
- 手机号：13800138000（或其他已注册账号）
- 密码：你的密码

### 3. 准备两个浏览器
- 浏览器A：用于测试主账号
- 浏览器B：用于测试顶号机制（可以用Chrome的隐私模式）

## ✅ 测试用例

### 测试1：首次登录（基础功能）

**步骤：**
1. 打开浏览器，按F12打开控制台
2. 清空localStorage：`localStorage.clear()`
3. 访问登录页
4. 输入账号密码登录

**预期结果：**
- ✅ 登录成功，跳转到主页
- ✅ 控制台显示：`✅ 登录成功`
- ✅ localStorage包含：`auth_token`, `user_phone`, `user_type`

**控制台关键日志：**
```
📱 没有登录信息，显示登录页
🌐 API请求: POST /api/auth/login
✅ 登录成功
```

---

### 测试2：自动登录（七天免密）

**步骤：**
1. 在测试1登录成功后
2. 关闭浏览器（或标签页）
3. 重新打开浏览器访问系统

**预期结果：**
- ✅ 短暂显示"正在自动登录..."提示
- ✅ 自动登录成功，直接进入主页
- ✅ 无需输入密码

**控制台关键日志：**
```
🔍 App启动，验证现有token...
✅ Token验证通过，直接进入系统
```

或者（如果App验证失败）：
```
🔍 页面加载，尝试七天免密登录...
✅ 找到token，尝试七天免密登录...
🎉 七天免密登录成功
```

---

### 测试3：Token验证通过（快速进入）

**步骤：**
1. 保持登录状态
2. 直接刷新页面

**预期结果：**
- ✅ 无加载提示，瞬间进入主页
- ✅ 控制台显示token验证通过

**控制台关键日志：**
```
🔍 App启动，验证现有token...
🌐 API请求: GET /api/auth/profile
✅ Token验证通过，直接进入系统
```

---

### 测试4：顶号机制（重要）

**步骤：**
1. **浏览器A**：正常登录，保持在主页
2. **浏览器B**：用同一账号登录
3. **浏览器A**：刷新页面或进行任何操作

**预期结果：**
- ✅ 浏览器B登录成功
- ✅ 浏览器A收到401错误
- ✅ 浏览器A弹出提示："您的账号在其他设备登录，当前登录已失效，请重新登录"
- ✅ 浏览器A自动跳转到登录页

**浏览器A控制台关键日志：**
```
🚫 检测到令牌失效，可能被顶号
❌ API请求失败: 登录已失效
🚫 收到顶号通知: 登录已失效
```

**浏览器B控制台关键日志：**
```
🌐 API请求: POST /api/auth/login
✅ 登录成功
```

---

### 测试5：免密登录按钮

**步骤：**
1. 在测试2的基础上，退出登录
2. 不要清空localStorage
3. 手动访问登录页
4. 输入之前登录过的手机号

**预期结果：**
- ✅ 页面显示"七天免密登录可用"
- ✅ 出现蓝色的"七天免密登录"按钮
- ✅ 点击按钮后自动登录成功

**控制台关键日志：**
```
🔍 检查七天免密登录状态...
✅ 找到token，尝试七天免密登录...
🎉 七天免密登录成功
```

---

### 测试6：Token过期（模拟）

**步骤：**
1. 登录成功后
2. 打开控制台，手动修改token：
   ```javascript
   localStorage.setItem('auth_token', 'invalid_token_123')
   ```
3. 刷新页面

**预期结果：**
- ✅ 自动登录失败
- ✅ 显示登录表单
- ✅ token被清除

**控制台关键日志：**
```
❌ 七天免密登录失败: Token无效或已过期
```

---

### 测试7：完全清空后的首次访问

**步骤：**
1. 打开控制台
2. 执行：`localStorage.clear()`
3. 刷新页面

**预期结果：**
- ✅ 直接显示登录表单
- ✅ 不尝试自动登录
- ✅ 无"正在自动登录..."提示

**控制台关键日志：**
```
📱 没有登录信息，显示登录页
⚠️ 没有token，需要手动登录
```

---

## 📊 测试检查清单

完成测试后，请检查以下项目：

- [ ] 首次登录成功，token正确保存
- [ ] 七天免密登录自动生效
- [ ] Token有效时快速进入系统
- [ ] 被顶号后立即失效并提示
- [ ] 免密登录按钮正常工作
- [ ] Token失效后自动清除
- [ ] 清空数据后正常显示登录表单

## 🐛 常见问题排查

### 问题1：自动登录失败
**检查：**
```javascript
// 控制台执行
console.log('Token:', localStorage.getItem('auth_token'))
console.log('Phone:', localStorage.getItem('user_phone'))
console.log('UserType:', localStorage.getItem('user_type'))
```
确保三个值都存在且有效。

### 问题2：顶号不生效
**检查：**
1. 确保使用的是同一个账号
2. 查看后端日志，确认activeToken是否被更新
3. 检查浏览器B是否真的登录成功

### 问题3：页面一直转圈
**检查：**
1. 查看控制台是否有网络错误
2. 确认后端服务是否正常运行
3. 检查vite.config.js的代理配置

### 问题4：401错误未弹出提示
**检查：**
1. 确认`TokenKickOutHandler`组件是否存在
2. 查看`setTokenKickOutHandler`是否正确设置
3. 检查`apiRequest`函数中的401处理逻辑

## 📝 测试报告模板

```markdown
## 测试时间
2025年10月30日

## 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 首次登录 | ✅/❌ |  |
| 自动登录 | ✅/❌ |  |
| Token验证 | ✅/❌ |  |
| 顶号机制 | ✅/❌ |  |
| 免密按钮 | ✅/❌ |  |
| Token过期 | ✅/❌ |  |
| 首次访问 | ✅/❌ |  |

## 发现的问题
（如有）

## 总结
（测试结论）
```

## 🎉 测试完成

如果所有测试用例都通过，说明新版七天免密登录功能已经完美适配！

**祝测试顺利！** 🚀

