# ä¸ƒå¤©å…å¯†ç™»å½• - å¿«é€Ÿå¼€å§‹æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“ä¿®æ”¹
- âœ… user_infoè¡¨æ·»åŠ äº†3ä¸ªå­—æ®µï¼š`active_token`, `token_created_at`, `token_expires_at`
- âœ… administrator_infoè¡¨æ·»åŠ äº†3ä¸ªå­—æ®µï¼š`active_token`, `token_created_at`, `token_expires_at`

### 2. åç«¯ä»£ç ä¿®æ”¹
- âœ… æ–°å¢ï¼š`TokenService.java` - ç»Ÿä¸€ç®¡ç†tokençš„ç”Ÿæˆã€éªŒè¯ã€åˆ é™¤
- âœ… ä¿®æ”¹ï¼š`User.java` å’Œ `Administrator.java` - æ·»åŠ tokenç›¸å…³å­—æ®µ
- âœ… ä¿®æ”¹ï¼š`AuthService.java` - æ‰€æœ‰ç™»å½•æ–¹æ³•ä½¿ç”¨æ–°çš„TokenService
- âœ… ä¿®æ”¹ï¼š`JwtAuthenticationFilter.java` - å®ç°é¡¶å·æ£€æµ‹é€»è¾‘
- âœ… ä¿®æ”¹ï¼š`AuthController.java` - è‡ªåŠ¨ç™»å½•æ¥å£æ”¹ä¸ºåŸºäºtokenéªŒè¯
- âœ… ä¿®æ”¹ï¼š`AutoLoginRequest.java` - æ·»åŠ tokenå­—æ®µ

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### åç«¯ä½¿ç”¨ï¼ˆå·²è‡ªåŠ¨ç”Ÿæ•ˆï¼‰

æ‰€æœ‰ç™»å½•æ–¹å¼ï¼ˆå¯†ç ç™»å½•ã€éªŒè¯ç ç™»å½•ï¼‰éƒ½ä¼šè‡ªåŠ¨ï¼š
1. ç”Ÿæˆtoken
2. ä¿å­˜åˆ°æ•°æ®åº“
3. è®¾ç½®7å¤©è¿‡æœŸæ—¶é—´
4. å®ç°é¡¶å·æœºåˆ¶

**æ— éœ€é¢å¤–é…ç½®**ï¼Œç›´æ¥è¿è¡Œé¡¹ç›®å³å¯ï¼

### å‰ç«¯é›†æˆï¼ˆéœ€è¦ä¿®æ”¹ï¼‰

#### 1. ç™»å½•æˆåŠŸåå­˜å‚¨token

```javascript
// å¯†ç ç™»å½•æˆ–éªŒè¯ç ç™»å½•æˆåŠŸå
fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone, password, userType })
})
.then(res => res.json())
.then(data => {
    if (data.code === 200) {
        // âš ï¸ é‡è¦ï¼šå­˜å‚¨è¿™ä¸‰ä¸ªå€¼åˆ°æœ¬åœ°
        localStorage.setItem('token', data.data.token);
        localStorage.setItem('phone', data.data.phone);
        localStorage.setItem('userType', data.data.userType);
        
        // è·³è½¬åˆ°ä¸»é¡µ
        window.location.href = '/dashboard';
    }
});
```

#### 2. é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨ç™»å½•

```javascript
// åœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
window.addEventListener('load', async () => {
    const token = localStorage.getItem('token');
    const phone = localStorage.getItem('phone');
    const userType = localStorage.getItem('userType');
    
    // å¦‚æœæœ‰æœ¬åœ°tokenï¼Œå°è¯•è‡ªåŠ¨ç™»å½•
    if (token && phone && userType) {
        try {
            const response = await fetch('/api/auth/auto-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    userType: userType,
                    token: token  // âš ï¸ å¿…é¡»æºå¸¦token
                })
            });
            
            const data = await response.json();
            
            if (data.code === 200) {
                // è‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œç›´æ¥è¿›å…¥ç³»ç»Ÿ
                console.log('âœ… ä¸ƒå¤©å…å¯†ç™»å½•æˆåŠŸ');
                // è·³è½¬åˆ°ä¸»é¡µ
                window.location.href = '/dashboard';
            } else {
                // Tokenå¤±æ•ˆï¼ˆè¢«é¡¶å·æˆ–å·²è¿‡æœŸï¼‰
                console.log('âŒ Tokenå·²å¤±æ•ˆ');
                localStorage.clear();
                // æ˜¾ç¤ºç™»å½•è¡¨å•
                showLoginForm();
            }
        } catch (error) {
            console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š', error);
            showLoginForm();
        }
    } else {
        // æ²¡æœ‰æœ¬åœ°tokenï¼Œæ˜¾ç¤ºç™»å½•è¡¨å•
        showLoginForm();
    }
});
```

#### 3. ç»Ÿä¸€å¤„ç†401é”™è¯¯ï¼ˆè¢«é¡¶å·ï¼‰

```javascript
// å°è£…APIè¯·æ±‚å‡½æ•°
async function apiRequest(url, options = {}) {
    const token = localStorage.getItem('token');
    
    // æ·»åŠ Authorizationå¤´
    options.headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
    };
    
    const response = await fetch(url, options);
    
    // å¦‚æœè¿”å›401ï¼Œè¯´æ˜è¢«é¡¶å·æˆ–tokenè¿‡æœŸ
    if (response.status === 401) {
        alert('æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•');
        localStorage.clear();
        window.location.href = '/login';
        return null;
    }
    
    return response.json();
}

// ä½¿ç”¨ç¤ºä¾‹
apiRequest('/api/posts/list', { method: 'GET' })
    .then(data => {
        if (data) {
            console.log('å¸–å­åˆ—è¡¨ï¼š', data);
        }
    });
```

## ğŸ“‹ å®Œæ•´çš„å‰ç«¯ç¤ºä¾‹ï¼ˆHTML + JavaScriptï¼‰

```html
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½•é¡µé¢</title>
</head>
<body>
    <!-- ç™»å½•è¡¨å• -->
    <div id="loginForm" style="display:none;">
        <h2>ç”¨æˆ·ç™»å½•</h2>
        <input type="text" id="phone" placeholder="æ‰‹æœºå·">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="login()">ç™»å½•</button>
    </div>
    
    <!-- åŠ è½½ä¸­æç¤º -->
    <div id="loading">
        <p>æ­£åœ¨è‡ªåŠ¨ç™»å½•...</p>
    </div>

    <script>
        // ========== é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç™»å½• ==========
        window.addEventListener('load', autoLogin);
        
        async function autoLogin() {
            const token = localStorage.getItem('token');
            const phone = localStorage.getItem('phone');
            const userType = localStorage.getItem('userType') || 'user';
            
            if (!token || !phone) {
                // æ²¡æœ‰æœ¬åœ°tokenï¼Œæ˜¾ç¤ºç™»å½•è¡¨å•
                showLoginForm();
                return;
            }
            
            try {
                const response = await fetch('/api/auth/auto-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, userType, token })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    console.log('âœ… ä¸ƒå¤©å…å¯†ç™»å½•æˆåŠŸ');
                    goToDashboard();
                } else {
                    console.log('âŒ Tokenå·²å¤±æ•ˆï¼š', data.message);
                    localStorage.clear();
                    showLoginForm();
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼š', error);
                showLoginForm();
            }
        }
        
        // ========== å¯†ç ç™»å½• ==========
        async function login() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        password: password,
                        userType: 'user'
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    // ä¿å­˜token
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('phone', data.data.phone);
                    localStorage.setItem('userType', data.data.userType);
                    
                    console.log('âœ… ç™»å½•æˆåŠŸ');
                    goToDashboard();
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥ï¼š', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ========== è¾…åŠ©å‡½æ•° ==========
        function showLoginForm() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }
        
        function goToDashboard() {
            window.location.href = '/dashboard.html';
        }
    </script>
</body>
</html>
```

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸ä¸ƒå¤©å…å¯†ç™»å½•
1. ç”¨æˆ·ç™»å½•æˆåŠŸ
2. å…³é—­æµè§ˆå™¨
3. 7å¤©å†…é‡æ–°æ‰“å¼€
4. âœ… è‡ªåŠ¨ç™»å½•æˆåŠŸ

### åœºæ™¯2ï¼šé¡¶å·æµ‹è¯•
1. ç”¨æˆ·Aåœ¨è®¾å¤‡1ç™»å½•
2. ç”¨æˆ·Båœ¨è®¾å¤‡2ç™»å½•åŒä¸€è´¦å·
3. ç”¨æˆ·Aåœ¨è®¾å¤‡1ç»§ç»­æ“ä½œ
4. âœ… ç”¨æˆ·Aæ”¶åˆ°401é”™è¯¯ï¼Œæç¤º"è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"

### åœºæ™¯3ï¼šTokenè¿‡æœŸ
1. ç”¨æˆ·ç™»å½•æˆåŠŸ
2. ç­‰å¾…è¶…è¿‡7å¤©
3. å°è¯•è‡ªåŠ¨ç™»å½•
4. âœ… æ”¶åˆ°"Tokenå·²è¿‡æœŸ"æç¤ºï¼Œéœ€è¦é‡æ–°ç™»å½•

## âš ï¸ é‡è¦æé†’

### å‰ç«¯å¿…é¡»ä¿®æ”¹çš„åœ°æ–¹ï¼š

1. **ç™»å½•æˆåŠŸåå­˜å‚¨token**
   ```javascript
   localStorage.setItem('token', data.data.token);
   localStorage.setItem('phone', data.data.phone);
   localStorage.setItem('userType', data.data.userType);
   ```

2. **è‡ªåŠ¨ç™»å½•æ¥å£è°ƒç”¨**
   ```javascript
   // âš ï¸ å¿…é¡»æºå¸¦tokenå­—æ®µ
   body: JSON.stringify({ phone, userType, token })
   ```

3. **æ‰€æœ‰APIè¯·æ±‚æ·»åŠ Authorizationå¤´**
   ```javascript
   headers: {
       'Authorization': `Bearer ${token}`
   }
   ```

4. **ç»Ÿä¸€å¤„ç†401é”™è¯¯**
   ```javascript
   if (response.status === 401) {
       alert('è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•');
       localStorage.clear();
       window.location.href = '/login';
   }
   ```

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘çš„è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Ÿ
**A:** æ£€æŸ¥ï¼š
1. æ˜¯å¦åœ¨è¯·æ±‚ä¸­æºå¸¦äº†tokenå­—æ®µï¼Ÿ
2. localStorageä¸­æ˜¯å¦å­˜å‚¨äº†tokenï¼Ÿ
3. æ˜¯å¦è¶…è¿‡7å¤©ï¼Ÿ
4. æ˜¯å¦åœ¨å…¶ä»–è®¾å¤‡ç™»å½•è¿‡ï¼Ÿ

### Q2: 401é”™è¯¯æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
**A:** 401è¡¨ç¤ºtokenå¤±æ•ˆï¼ŒåŸå› å¯èƒ½æ˜¯ï¼š
1. è¢«å…¶ä»–è®¾å¤‡ç™»å½•é¡¶å·
2. Tokenå·²è¿‡æœŸï¼ˆè¶…è¿‡7å¤©ï¼‰
3. ç”¨æˆ·ä¸»åŠ¨ç™»å‡º

### Q3: å‰ç«¯éœ€è¦åšä»€ä¹ˆç‰¹æ®Šå¤„ç†å—ï¼Ÿ
**A:** åªéœ€è¦ï¼š
1. ç™»å½•åå­˜å‚¨tokenåˆ°localStorage
2. é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨ç™»å½•
3. æ‰€æœ‰è¯·æ±‚æºå¸¦Authorizationå¤´
4. ç»Ÿä¸€å¤„ç†401é”™è¯¯

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„ç³»ç»Ÿå·²ç»æ”¯æŒï¼š
- âœ… ä¸ƒå¤©å…å¯†ç™»å½•
- âœ… è‡ªåŠ¨é¡¶å·æœºåˆ¶
- âœ… Tokenè¿‡æœŸæ£€æµ‹
- âœ… å®‰å…¨å¯é çš„èº«ä»½éªŒè¯

**å‰ç«¯åªéœ€æŒ‰ç…§ä¸Šè¿°ç¤ºä¾‹ä¿®æ”¹å³å¯ä½¿ç”¨ï¼**

