# AI接口更新说明

## 📌 更新内容

**更新时间**: 刚刚  
**更新内容**: 修改AI接口请求格式，使用单个文本字段

---

## ✅ 新的请求格式

### 之前的格式（已废弃）
```json
{
  "inputs": {
    "出发地": "北京",
    "目的地": "上海",
    "出行方式": "自驾"
  }
}
```

### 现在的格式（推荐）
```json
{
  "inputs": {
    "query": "我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费"
  }
}
```

---

## 🎯 主要变化

### 1. 输入方式
- **之前**: 3个独立字段（出发地、目的地、出行方式）
- **现在**: 1个文本字段（query），前端自动组合

### 2. 文本组合格式
```
我要通过{出行方式}从{出发地}到{目的地}，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费
```

### 3. 示例
- **输入**: 出发地="北京", 目的地="上海", 出行方式="自驾"
- **组合**: "我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费"

---

## 📋 Dify工作流配置变化

### 输入变量配置

**之前需要配置3个变量**：
- 出发地 (String)
- 目的地 (String)
- 出行方式 (String)

**现在只需要1个变量**：
- query (String) - 完整的查询文本

### AI提示词配置

**推荐的提示词**：
```
你是一个智能路线规划助手。

用户查询：{{query}}

请根据用户的查询生成两种路线方案：
1. 最快路线方案
2. 最省钱方案

请严格按照以下JSON格式返回，不要包含任何其他文字：

{
  "fastest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过C、D等",
    "cost": "花费：￥XX.XX"
  },
  "cheapest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过E、F等",
    "cost": "花费：￥XX.XX"
  }
}

格式要求：
- time格式：时间：XX分钟 或 时间：X小时XX分钟
- description：详细描述路线，包括途经道路、换乘信息、距离等
- cost格式：花费：￥XX.XX 或 花费：免费
- 必须返回有效的JSON格式
- 根据实际出行方式给出合理的时间和花费
```

---

## 🔧 前端代码变化

### 配置文件 (src/config/aiConfig.js)

**修改内容**：
```javascript
// 构建请求体
export const buildRequestBody = (from, to, mode) => {
  // 将用户输入组合成一句话
  const promptText = `我要通过${mode}从${from}到${to}，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费`;
  
  return {
    inputs: {
      query: promptText  // 使用单个文本字段
    },
    response_mode: 'blocking',
    user: 'user-' + Date.now()
  };
};
```

**优点**：
- ✅ 更简单的配置
- ✅ 更灵活的提示词
- ✅ 更容易调试
- ✅ AI可以更好地理解上下文

---

## 🧪 测试

### 1. 运行测试脚本

```bash
node test-api.js
```

**会看到**：
```
组合的提示词:
我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费

请求参数:
{
  "inputs": {
    "query": "我要通过自驾从北京到上海..."
  },
  "response_mode": "blocking",
  "user": "test-user"
}
```

### 2. 在浏览器中测试

1. 访问 http://localhost:3001/
2. 按F12打开控制台
3. 输入出发地和目的地
4. 点击"一键规划路线"
5. 查看控制台日志：

```javascript
正在调用AI接口... { from: "北京", to: "上海", activeMode: "自驾" }
请求参数: {
  inputs: {
    query: "我要通过自驾从北京到上海，给我生成..."
  },
  ...
}
```

---

## ✅ 迁移步骤

如果您之前已经配置了Dify工作流，需要更新：

### 步骤1: 更新Dify工作流

1. 删除旧的输入变量（出发地、目的地、出行方式）
2. 添加新的输入变量 `query` (String类型)
3. 更新AI节点的提示词，使用 `{{query}}`

### 步骤2: 前端配置保持不变

配置文件 `src/config/aiConfig.js` 中：
- ✅ `enabled` 保持您的设置
- ✅ `workflowId` 保持不变
- ✅ `apiKey` 保持不变

**代码已自动更新，无需手动修改！**

### 步骤3: 测试

1. 运行 `node test-api.js`
2. 刷新浏览器测试

---

## 🎉 优势

### 对用户的优势
- ✅ 更自然的查询方式
- ✅ AI可以理解完整的上下文
- ✅ 更准确的路线推荐

### 对开发的优势
- ✅ 配置更简单（只需1个变量）
- ✅ 提示词更灵活
- ✅ 更容易调试和测试
- ✅ 可以轻松修改查询格式

### 对AI的优势
- ✅ 完整的上下文信息
- ✅ 更自然的语言理解
- ✅ 更准确的意图识别

---

## 📝 注意事项

1. **Dify配置必须更新**
   - 旧的3变量配置不再兼容
   - 必须使用新的单变量配置

2. **提示词格式固定**
   - 格式：`我要通过{mode}从{from}到{to}，给我生成...`
   - 如需修改，在 `src/config/aiConfig.js` 中修改

3. **测试很重要**
   - 先用 `node test-api.js` 测试
   - 确认API正常后再在浏览器测试

---

## 📚 相关文档

- **Dify工作流配置指南.md** - 详细的配置步骤
- **AI接口说明.md** - 完整的API文档
- **test-api.js** - API测试脚本

---

## 💡 常见问题

### Q: 为什么要改成单个文本字段？
**A**: 
- 更符合自然语言处理的方式
- AI可以更好地理解完整的查询意图
- 配置更简单，只需1个变量

### Q: 旧的配置还能用吗？
**A**: 
- 不能，必须更新Dify工作流
- 前端代码已自动更新
- 使用 `node test-api.js` 测试新配置

### Q: 如何修改查询格式？
**A**: 
- 编辑 `src/config/aiConfig.js`
- 找到 `buildRequestBody` 函数
- 修改 `promptText` 的模板字符串

### Q: 出错了怎么办？
**A**: 
1. 运行 `node test-api.js` 查看详细错误
2. 检查Dify工作流配置
3. 查看浏览器控制台日志

---

## ✨ 总结

- ✅ **更简单**: 1个变量代替3个
- ✅ **更自然**: 完整的句子而非片段
- ✅ **更准确**: AI理解更好
- ✅ **更灵活**: 易于修改和扩展

现在您的AI接口使用更自然、更强大的查询方式了！🎉

