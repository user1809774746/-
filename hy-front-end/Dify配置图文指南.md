# Dify 配置图文指南

## 🎯 目标
解决 404 错误，启用AI路线规划功能

---

## 📋 准备工作

1. 注册Dify账号：https://cloud.dify.ai/
2. 准备好这个文档和配置文件

---

## 🔨 创建工作流（5个步骤）

### 第1步：创建新应用

```
登录 Dify → 点击"创建应用" → 选择"工作流"
```

**要点**：
- 应用类型：工作流 (Workflow)
- 名称：路线规划助手
- 图标：随意选择

---

### 第2步：配置输入变量

在工作流画布左侧找到 **"开始"** 节点，点击它：

**添加输入变量**：
```
变量名: query
类型: 文本 (Text/String)
必填: ✅ 是
描述: 用户的完整查询（例如：我要通过自驾从北京到上海...）
```

**示例输入值**（用于测试）：
```
我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费
```

---

### 第3步：添加LLM节点

**操作**：
1. 从左侧工具栏拖拽 **"LLM"** 节点到画布
2. 用箭头连接：**开始** → **LLM**
3. 点击LLM节点进行配置

**配置内容**：

#### 模型选择：
- 推荐：GPT-4 / Claude-3 / 通义千问
- 也可用：GPT-3.5（便宜但效果稍差）

#### 提示词：
```
你是一个智能路线规划助手。

用户查询：{{#start.query#}}

请根据用户的查询生成两种路线方案：
1. 最快路线方案
2. 最省钱方案

请严格按照以下JSON格式返回，不要包含任何其他文字：

{
  "fastest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过C、D等",
    "cost": "花费：￥XX.XX"
  },
  "cheapest": {
    "time": "时间：XX分钟",
    "description": "详细路线：从A到B经过E、F等",
    "cost": "花费：￥XX.XX"
  }
}

格式要求：
- time格式：时间：XX分钟 或 时间：X小时XX分钟
- description：详细描述路线，包括途经道路、换乘信息、距离等
- cost格式：花费：￥XX.XX 或 花费：免费
- 必须返回有效的JSON格式
- 根据实际出行方式给出合理的时间和花费
```

#### 参数设置：
- 温度 (Temperature): 0.7
- 最大令牌 (Max Tokens): 1000

---

### 第4步：添加结束节点

**操作**：
1. 拖拽 **"结束"** 节点到画布
2. 连接：**LLM** → **结束**
3. 配置输出

**输出配置**：
```
输出变量名: result
输出内容: 选择LLM节点的输出
```

**节点连接关系**：
```
[开始] → [LLM] → [结束]
```

---

### 第5步：测试工作流

**点击右上角 "运行"**

**测试输入**：
```json
{
  "query": "我要通过自驾从北京到上海，给我生成两个方案：一个是最快路线方案一个是最省钱方案。需要的方案数据是：时间，详细路线，花费"
}
```

**期望输出**（类似）：
```json
{
  "fastest": {
    "time": "时间：12小时30分钟",
    "description": "详细路线：京沪高速(G2)全程约1200公里，途经天津、济南、徐州、南京",
    "cost": "花费：￥600.00"
  },
  "cheapest": {
    "time": "时间：15小时",
    "description": "详细路线：国道G104全程约1300公里，途经天津、德州、济南、徐州、南京、上海",
    "cost": "花费：￥300.00"
  }
}
```

**调试提示**：
- 如果输出不是JSON格式，修改提示词强调"只返回JSON"
- 如果格式不对，在提示词中添加更多示例
- 可以多次测试调整

---

## 🔑 获取API凭证

### 发布工作流

1. 点击右上角 **"发布"** 按钮
2. 确认发布

### 获取API信息

1. 点击右上角 **"访问API"** 或 **"API"** 按钮
2. 选择 **"API访问"** 标签

**复制以下信息**：

#### 工作流ID：
在API URL中：
```
https://api.dify.ai/v1/workflows/【这里是工作流ID】/run
                                 ^^^^^^^^^^^^^^^^^^^^
```
例如：`f8c91234-5678-90ab-cdef-1234567890ab`

#### API密钥：
```
app-xxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**重要**：
- ✅ 复制完整的密钥（包括 `app-` 前缀）
- ✅ 不要分享给他人
- ✅ 可以随时重新生成

---

## ⚙️ 更新前端配置

### 编辑配置文件

打开文件：`src/config/aiConfig.js`

找到这几行并修改：

```javascript
const aiConfig = {
  // 第1步：启用AI
  enabled: true,  // 改为 true
  
  // 第2步：粘贴您的工作流ID
  workflowId: '粘贴您从Dify复制的工作流ID',
  
  // 第3步：粘贴您的API密钥
  apiKey: 'app-粘贴您的API密钥',
  
  // 其他配置保持不变
  baseUrl: 'https://api.dify.ai/v1/workflows',
  timeout: 30000,
  inputFieldName: 'query'
};
```

### 保存文件

按 `Ctrl + S` 保存

---

## 🧪 测试配置

### 1. 测试API连接

打开终端，运行：

```bash
node test-api.js
```

**成功的输出**：
```
✅ 请求成功！

返回数据:
{
  "fastest": { ... },
  "cheapest": { ... }
}
```

**失败的输出**：
```
❌ 请求失败！
错误详情: ...
```

**常见错误**：
- 404: 工作流ID错误
- 401: API密钥错误
- 400: 输入变量名不匹配（应该是 `query`）

### 2. 在浏览器测试

1. **刷新浏览器**：http://localhost:3001/
2. **打开控制台**：按 F12
3. **测试路线规划**：
   - 输入：出发地 "北京"
   - 输入：目的地 "上海"
   - 选择：出行方式 "自驾"
   - 点击："一键规划路线"

4. **查看控制台**：
   ```
   ✅ 正在调用AI接口...
   ✅ 请求参数: {...}
   ✅ AI返回数据: {...}
   ```

5. **查看弹窗**：
   - 应该显示AI生成的路线
   - 不是预设的默认数据

---

## ✅ 验证成功

配置成功的标志：

1. ✅ `node test-api.js` 显示 "请求成功"
2. ✅ 浏览器控制台显示 "AI返回数据"
3. ✅ 弹窗显示真实的路线方案
4. ✅ 数据根据输入动态变化

---

## ❌ 故障排查

### 问题1: 404 Not Found

**原因**：工作流ID错误或工作流未发布

**解决**：
1. 检查工作流ID是否完整复制
2. 确认工作流已发布
3. 在Dify中找到正确的API URL

### 问题2: 401 Unauthorized

**原因**：API密钥错误

**解决**：
1. 检查密钥是否包含 `app-` 前缀
2. 重新复制密钥（避免多余空格）
3. 在Dify中重新生成密钥

### 问题3: 400 Bad Request

**原因**：输入变量名不匹配

**解决**：
1. 确认Dify中的变量名是 `query`
2. 检查变量类型是文本/String
3. 查看错误消息中的详细信息

### 问题4: 返回数据格式错误

**原因**：AI没有按JSON格式返回

**解决**：
1. 修改提示词，强调"只返回JSON"
2. 添加示例到提示词
3. 在Dify中测试并调整
4. 尝试更好的AI模型（如GPT-4）

---

## 📝 配置清单

完成以下所有项即可成功：

- [ ] Dify账号已注册
- [ ] 工作流已创建
- [ ] 输入变量 `query` 已配置
- [ ] LLM节点已添加并配置提示词
- [ ] 结束节点已添加
- [ ] 工作流测试通过
- [ ] 工作流已发布
- [ ] 工作流ID已复制
- [ ] API密钥已复制
- [ ] `src/config/aiConfig.js` 已更新
- [ ] `enabled` 改为 `true`
- [ ] `workflowId` 已粘贴
- [ ] `apiKey` 已粘贴
- [ ] `node test-api.js` 测试成功
- [ ] 浏览器测试成功

---

## 💡 提示

1. **先在Dify中测试**
   - 确保工作流能正常工作
   - 输出是标准的JSON格式

2. **使用测试脚本**
   - `node test-api.js` 快速验证
   - 查看详细的错误信息

3. **查看控制台日志**
   - 浏览器F12控制台
   - 显示完整的请求和响应

4. **保存好您的密钥**
   - 不要提交到Git
   - 不要分享给他人
   - 可以随时重新生成

---

## 🎉 完成

配置完成后，您的应用将使用AI生成真实的路线规划！

**现在开始创建您的Dify工作流吧！** 🚀

