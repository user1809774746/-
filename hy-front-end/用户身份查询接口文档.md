# ç”¨æˆ·èº«ä»½æŸ¥è¯¢æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è¿°

æœ¬æ¥å£ç”¨äºè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·è¿˜æ˜¯ç®¡ç†å‘˜ã€‚

---

## ğŸ”— æ¥å£ä¿¡æ¯

**æ¥å£åœ°å€ï¼š** `GET /api/auth/user-info`

**åŠŸèƒ½æè¿°ï¼š** è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆæ™®é€šç”¨æˆ·/ç®¡ç†å‘˜ï¼‰

**è¯·æ±‚æ–¹å¼ï¼š** GET

**æ˜¯å¦éœ€è¦è®¤è¯ï¼š** æ˜¯ï¼ˆéœ€è¦æºå¸¦tokenï¼‰

---

## ğŸ“¤ è¯·æ±‚å‚æ•°

### è¯·æ±‚å¤´ï¼ˆHeaderï¼‰

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| Authorization | String | æ˜¯ | Bearer {token} |

**ç¤ºä¾‹ï¼š**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMzgwMDEzODAwMCIsInVzZXJUeXBlIjoidXNlciIsImlhdCI6MTYzNTc0MDAwMCwiZXhwIjoxNjM2MzQ0ODAwfQ.xxx
```

### è¯·æ±‚ä½“ï¼ˆBodyï¼‰

æ— éœ€è¯·æ±‚ä½“

---

## ğŸ“¥ å“åº”ç»“æœ

### æˆåŠŸå“åº”ï¼ˆæ™®é€šç”¨æˆ·ï¼‰

**HTTPçŠ¶æ€ç ï¼š** 200

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "phone": "13800138000",
    "userType": "user",
    "userRole": "æ™®é€šç”¨æˆ·",
    "isAdmin": false
  }
}
```

### æˆåŠŸå“åº”ï¼ˆç®¡ç†å‘˜ï¼‰

**HTTPçŠ¶æ€ç ï¼š** 200

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "phone": "13800138000",
    "userType": "admin",
    "userRole": "ç®¡ç†å‘˜",
    "isAdmin": true
  }
}
```

### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| code | Integer | å“åº”çŠ¶æ€ç ï¼Œ200è¡¨ç¤ºæˆåŠŸ |
| message | String | å“åº”æ¶ˆæ¯ |
| data | Object | ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ |
| data.phone | String | ç”¨æˆ·æ‰‹æœºå· |
| data.userType | String | ç”¨æˆ·ç±»å‹ï¼šuserï¼ˆæ™®é€šç”¨æˆ·ï¼‰ã€adminï¼ˆç®¡ç†å‘˜ï¼‰ |
| data.userRole | String | ç”¨æˆ·è§’è‰²ä¸­æ–‡æè¿°ï¼šæ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ |
| data.isAdmin | Boolean | æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼štrue/false |

### å¤±è´¥å“åº”

#### 1. æœªç™»å½•ï¼ˆæ— tokenæˆ–tokenæ— æ•ˆï¼‰

**HTTPçŠ¶æ€ç ï¼š** 401

```json
{
  "code": 401,
  "message": "error",
  "data": "ç”¨æˆ·æœªç™»å½•"
}
```

#### 2. Tokenå·²å¤±æ•ˆï¼ˆè¢«é¡¶å·æˆ–è¿‡æœŸï¼‰

**HTTPçŠ¶æ€ç ï¼š** 401

```json
{
  "code": 401,
  "message": "error",
  "data": "Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•"
}
```

#### 3. æœåŠ¡å™¨é”™è¯¯

**HTTPçŠ¶æ€ç ï¼š** 500

```json
{
  "code": 500,
  "message": "error",
  "data": "è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: {å…·ä½“é”™è¯¯ä¿¡æ¯}"
}
```

---

## ğŸ’» å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### 1. JavaScript (Fetch API)

```javascript
// è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯
async function getUserInfo() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        console.log('æœªç™»å½•');
        return null;
    }
    
    try {
        const response = await fetch('/api/auth/user-info', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
            console.log('ç”¨æˆ·ä¿¡æ¯ï¼š', data.data);
            
            // åˆ¤æ–­ç”¨æˆ·èº«ä»½
            if (data.data.isAdmin) {
                console.log('å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜');
                // æ˜¾ç¤ºç®¡ç†å‘˜åŠŸèƒ½
                showAdminFeatures();
            } else {
                console.log('å½“å‰ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·');
                // æ˜¾ç¤ºæ™®é€šç”¨æˆ·åŠŸèƒ½
                showUserFeatures();
            }
            
            return data.data;
        } else if (data.code === 401) {
            console.log('æœªç™»å½•æˆ–tokenå·²å¤±æ•ˆ');
            // è·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = '/login';
            return null;
        }
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', error);
        return null;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
getUserInfo().then(userInfo => {
    if (userInfo) {
        console.log('æ‰‹æœºå·ï¼š', userInfo.phone);
        console.log('ç”¨æˆ·è§’è‰²ï¼š', userInfo.userRole);
        console.log('æ˜¯å¦ç®¡ç†å‘˜ï¼š', userInfo.isAdmin);
    }
});
```

### 2. JavaScript (Axios)

```javascript
import axios from 'axios';

// é…ç½®axiosæ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨æ·»åŠ token
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// è·å–ç”¨æˆ·ä¿¡æ¯
async function getUserInfo() {
    try {
        const response = await axios.get('/api/auth/user-info');
        
        if (response.data.code === 200) {
            const userInfo = response.data.data;
            console.log('ç”¨æˆ·ä¿¡æ¯ï¼š', userInfo);
            
            // æ ¹æ®èº«ä»½æ˜¾ç¤ºä¸åŒçš„å†…å®¹
            if (userInfo.isAdmin) {
                console.log('ç®¡ç†å‘˜ç”¨æˆ·');
            } else {
                console.log('æ™®é€šç”¨æˆ·');
            }
            
            return userInfo;
        }
    } catch (error) {
        if (error.response && error.response.status === 401) {
            console.log('Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = '/login';
        } else {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', error);
        }
        return null;
    }
}
```

### 3. Vue.js ç¤ºä¾‹

```vue
<template>
  <div>
    <div v-if="userInfo">
      <h2>æ¬¢è¿ï¼Œ{{ userInfo.phone }}</h2>
      <p>ç”¨æˆ·è§’è‰²ï¼š{{ userInfo.userRole }}</p>
      
      <!-- ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½ -->
      <div v-if="userInfo.isAdmin">
        <h3>ç®¡ç†å‘˜åŠŸèƒ½</h3>
        <button @click="goToAdminPanel">è¿›å…¥ç®¡ç†åå°</button>
      </div>
      
      <!-- æ™®é€šç”¨æˆ·åŠŸèƒ½ -->
      <div v-else>
        <h3>ç”¨æˆ·åŠŸèƒ½</h3>
        <button @click="goToUserPanel">ä¸ªäººä¸­å¿ƒ</button>
      </div>
    </div>
    <div v-else>
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      userInfo: null
    }
  },
  mounted() {
    this.getUserInfo();
  },
  methods: {
    async getUserInfo() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        this.$router.push('/login');
        return;
      }
      
      try {
        const response = await fetch('/api/auth/user-info', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.code === 200) {
          this.userInfo = data.data;
        } else if (data.code === 401) {
          // Tokenå¤±æ•ˆï¼Œè·³è½¬ç™»å½•
          localStorage.clear();
          this.$router.push('/login');
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', error);
      }
    },
    goToAdminPanel() {
      this.$router.push('/admin');
    },
    goToUserPanel() {
      this.$router.push('/user');
    }
  }
}
</script>
```

### 4. React ç¤ºä¾‹

```jsx
import React, { useEffect, useState } from 'react';

function UserInfoComponent() {
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    getUserInfo();
  }, []);

  const getUserInfo = async () => {
    const token = localStorage.getItem('token');
    
    if (!token) {
      window.location.href = '/login';
      return;
    }
    
    try {
      const response = await fetch('/api/auth/user-info', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      const data = await response.json();
      
      if (data.code === 200) {
        setUserInfo(data.data);
      } else if (data.code === 401) {
        localStorage.clear();
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!userInfo) {
    return <div>æœªç™»å½•</div>;
  }

  return (
    <div>
      <h2>æ¬¢è¿ï¼Œ{userInfo.phone}</h2>
      <p>ç”¨æˆ·è§’è‰²ï¼š{userInfo.userRole}</p>
      
      {userInfo.isAdmin ? (
        <div>
          <h3>ç®¡ç†å‘˜åŠŸèƒ½</h3>
          <button onClick={() => window.location.href = '/admin'}>
            è¿›å…¥ç®¡ç†åå°
          </button>
        </div>
      ) : (
        <div>
          <h3>ç”¨æˆ·åŠŸèƒ½</h3>
          <button onClick={() => window.location.href = '/user'}>
            ä¸ªäººä¸­å¿ƒ
          </button>
        </div>
      )}
    </div>
  );
}

export default UserInfoComponent;
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·èº«ä»½

```javascript
// åœ¨é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
window.addEventListener('load', async () => {
    const userInfo = await getUserInfo();
    
    if (userInfo) {
        // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„å¯¼èˆªèœå•
        if (userInfo.isAdmin) {
            showAdminNavigation();
        } else {
            showUserNavigation();
        }
    }
});
```

### 2. æƒé™æ§åˆ¶

```javascript
// æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
async function checkAdminPermission() {
    const userInfo = await getUserInfo();
    
    if (!userInfo) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = '/login';
        return false;
    }
    
    if (!userInfo.isAdmin) {
        alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢');
        window.location.href = '/';
        return false;
    }
    
    return true;
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šè®¿é—®ç®¡ç†å‘˜é¡µé¢å‰æ£€æŸ¥æƒé™
async function goToAdminPage() {
    const hasPermission = await checkAdminPermission();
    if (hasPermission) {
        window.location.href = '/admin/dashboard';
    }
}
```

### 3. åŠ¨æ€æ˜¾ç¤ºåŠŸèƒ½æŒ‰é’®

```javascript
// æ ¹æ®ç”¨æˆ·èº«ä»½åŠ¨æ€æ˜¾ç¤ºåŠŸèƒ½
async function renderFeatures() {
    const userInfo = await getUserInfo();
    
    if (!userInfo) return;
    
    const featuresDiv = document.getElementById('features');
    
    if (userInfo.isAdmin) {
        // ç®¡ç†å‘˜åŠŸèƒ½
        featuresDiv.innerHTML = `
            <button onclick="manageUsers()">ç”¨æˆ·ç®¡ç†</button>
            <button onclick="viewStatistics()">æ•°æ®ç»Ÿè®¡</button>
            <button onclick="systemSettings()">ç³»ç»Ÿè®¾ç½®</button>
        `;
    } else {
        // æ™®é€šç”¨æˆ·åŠŸèƒ½
        featuresDiv.innerHTML = `
            <button onclick="viewProfile()">ä¸ªäººèµ„æ–™</button>
            <button onclick="myPosts()">æˆ‘çš„å¸–å­</button>
            <button onclick="myFavorites()">æˆ‘çš„æ”¶è—</button>
        `;
    }
}
```

### 4. ç»“åˆè·¯ç”±å®ˆå«

```javascript
// Vue Router è·¯ç”±å®ˆå«ç¤ºä¾‹
router.beforeEach(async (to, from, next) => {
    // éœ€è¦ç®¡ç†å‘˜æƒé™çš„è·¯ç”±
    if (to.meta.requiresAdmin) {
        const token = localStorage.getItem('token');
        
        if (!token) {
            next('/login');
            return;
        }
        
        try {
            const response = await fetch('/api/auth/user-info', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            
            if (data.code === 200 && data.data.isAdmin) {
                next(); // æ˜¯ç®¡ç†å‘˜ï¼Œå…è®¸è®¿é—®
            } else {
                alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
                next('/'); // é‡å®šå‘åˆ°é¦–é¡µ
            }
        } catch (error) {
            next('/login');
        }
    } else {
        next();
    }
});
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Tokenå¿…é¡»æœ‰æ•ˆ**ï¼šè°ƒç”¨æ­¤æ¥å£å‰ç¡®ä¿tokenæœ‰æ•ˆï¼Œå¦åˆ™è¿”å›401
2. **è¯·æ±‚å¤´æ ¼å¼**ï¼šAuthorizationå¤´å¿…é¡»æ˜¯ `Bearer {token}` æ ¼å¼
3. **åŠæ—¶åˆ·æ–°**ï¼šå»ºè®®åœ¨ç™»å½•æˆåŠŸåç«‹å³è°ƒç”¨æ­¤æ¥å£è·å–ç”¨æˆ·èº«ä»½
4. **ç¼“å­˜ç­–ç•¥**ï¼šå¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯ç¼“å­˜åˆ°localStorageï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°
5. **æƒé™æ§åˆ¶**ï¼šæ ¹æ®isAdminå­—æ®µæ§åˆ¶å‰ç«¯åŠŸèƒ½çš„æ˜¾ç¤ºå’Œéšè—
6. **401å¤„ç†**ï¼šæ”¶åˆ°401é”™è¯¯æ—¶ï¼Œåº”æ¸…é™¤æœ¬åœ°tokenå¹¶è·³è½¬ç™»å½•é¡µ

---

## ğŸ”„ å®Œæ•´çš„ç™»å½•æµç¨‹ï¼ˆå«èº«ä»½è¯†åˆ«ï¼‰

```javascript
// å®Œæ•´çš„ç™»å½•æµç¨‹
async function completeLogin(phone, password, userType) {
    try {
        // 1. ç™»å½•
        const loginResponse = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, password, userType })
        });
        
        const loginData = await loginResponse.json();
        
        if (loginData.code === 200) {
            // 2. ä¿å­˜token
            localStorage.setItem('token', loginData.data.token);
            localStorage.setItem('phone', loginData.data.phone);
            localStorage.setItem('userType', loginData.data.userType);
            
            // 3. è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
            const userInfoResponse = await fetch('/api/auth/user-info', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${loginData.data.token}`
                }
            });
            
            const userInfoData = await userInfoResponse.json();
            
            if (userInfoData.code === 200) {
                const userInfo = userInfoData.data;
                
                // 4. ä¿å­˜ç”¨æˆ·èº«ä»½ä¿¡æ¯
                localStorage.setItem('isAdmin', userInfo.isAdmin);
                localStorage.setItem('userRole', userInfo.userRole);
                
                // 5. æ ¹æ®èº«ä»½è·³è½¬
                if (userInfo.isAdmin) {
                    console.log('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                    window.location.href = '/admin/dashboard';
                } else {
                    console.log('æ™®é€šç”¨æˆ·ç™»å½•æˆåŠŸ');
                    window.location.href = '/user/dashboard';
                }
            }
        } else {
            alert('ç™»å½•å¤±è´¥ï¼š' + loginData.message);
        }
    } catch (error) {
        console.error('ç™»å½•å¤±è´¥ï¼š', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    }
}
```

---

## âœ… æ€»ç»“

**æ¥å£åœ°å€ï¼š** `GET /api/auth/user-info`

**ä¸»è¦ç”¨é€”ï¼š**
1. è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æ‰‹æœºå·
2. åˆ¤æ–­ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·è¿˜æ˜¯ç®¡ç†å‘˜
3. ç”¨äºå‰ç«¯æƒé™æ§åˆ¶å’ŒåŠŸèƒ½æ˜¾ç¤º

**è¿”å›å­—æ®µï¼š**
- `phone` - æ‰‹æœºå·
- `userType` - ç±»å‹ï¼ˆuser/adminï¼‰
- `userRole` - è§’è‰²ä¸­æ–‡ï¼ˆæ™®é€šç”¨æˆ·/ç®¡ç†å‘˜ï¼‰
- `isAdmin` - æ˜¯å¦ç®¡ç†å‘˜ï¼ˆtrue/falseï¼‰

**å‰ç«¯åªéœ€åˆ¤æ–­ `isAdmin` å­—æ®µå³å¯åŒºåˆ†ç”¨æˆ·èº«ä»½ï¼** âœ¨

