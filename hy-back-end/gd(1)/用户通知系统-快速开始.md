# 用户通知系统 - 快速开始指南

## 📋 概述

用户通知系统已完成开发和集成，可以自动通知帖子作者其他用户的互动行为（评论、收藏、浏览）。

## 🚀 快速开始

### 1. 数据库初始化

首先，执行SQL脚本创建通知表：

```bash
# 在MySQL中执行
mysql -u root -p gd_mcp < user_notification.sql
```

或者直接在数据库管理工具中执行 `user_notification.sql` 文件。

### 2. 启动后端服务

```bash
# 如果服务正在运行，重启服务以加载新的通知功能
# 如果使用Maven
mvn spring-boot:run

# 或者如果已编译
java -jar target/auth-system.jar
```

### 3. 测试通知功能

#### 场景1：评论通知测试

**步骤1：用户A登录并创建帖子**

```bash
# 登录用户A
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "phone": "13800138001",
  "password": "password123"
}

# 保存返回的token
```

```bash
# 创建帖子
POST http://localhost:8080/api/post/create
Authorization: Bearer <用户A的token>
Content-Type: application/json

{
  "title": "美丽的桂林之旅",
  "content": "桂林山水甲天下...",
  "postType": "travel_note"
}

# 记录返回的帖子ID
```

**步骤2：用户B登录并评论用户A的帖子**

```bash
# 登录用户B
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "phone": "13800138002",
  "password": "password123"
}
```

```bash
# 用户B评论用户A的帖子
POST http://localhost:8080/api/post/comment
Authorization: Bearer <用户B的token>
Content-Type: application/json

{
  "postId": 1,
  "commentContent": "这个地方太美了！"
}
```

**步骤3：用户A查看通知**

```bash
# 用户A获取通知列表
GET http://localhost:8080/api/notifications/list
Authorization: Bearer <用户A的token>

# 应该能看到用户B的评论通知
```

#### 场景2：收藏通知测试

**步骤1：用户B收藏用户A的帖子**

```bash
POST http://localhost:8080/api/favorite/post/1
Authorization: Bearer <用户B的token>
```

**步骤2：用户A查看通知**

```bash
# 用户A获取未读通知
GET http://localhost:8080/api/notifications/unread
Authorization: Bearer <用户A的token>

# 应该能看到用户B的收藏通知
```

#### 场景3：通知管理测试

```bash
# 获取通知统计
GET http://localhost:8080/api/notifications/stats
Authorization: Bearer <token>

# 标记单个通知为已读
PUT http://localhost:8080/api/notifications/1/read
Authorization: Bearer <token>

# 标记所有通知为已读
PUT http://localhost:8080/api/notifications/read-all
Authorization: Bearer <token>

# 删除单个通知
DELETE http://localhost:8080/api/notifications/1
Authorization: Bearer <token>

# 获取未读数量（用于角标）
GET http://localhost:8080/api/notifications/unread-count
Authorization: Bearer <token>
```

## 📊 通知类型说明

| 类型 | 代码 | 触发场景 | 备注 |
|------|------|----------|------|
| 评论通知 | COMMENT | 其他用户评论了你的帖子 | 自己评论自己的帖子不会产生通知 |
| 收藏通知 | FAVORITE | 其他用户收藏了你的帖子 | 自己收藏自己的帖子不会产生通知 |
| 浏览通知 | VIEW | 其他用户浏览了你的帖子 | 需要在帖子详情接口中集成 |

## 🔄 自动通知机制

### 评论时自动创建通知

当用户评论帖子时，系统会自动：
1. 保存评论到数据库
2. 更新帖子的评论数
3. **自动创建评论通知发送给帖子作者**
4. 如果通知创建失败，不会影响评论功能

### 收藏时自动创建通知

当用户收藏帖子时，系统会自动：
1. 保存收藏记录到数据库
2. 更新帖子的收藏数
3. **自动创建收藏通知发送给帖子作者**
4. 如果通知创建失败，不会影响收藏功能

## 🛡️ 防重复机制

系统内置了防重复通知机制：
- 相同的用户对同一帖子的相同类型操作不会重复创建通知
- 用户对自己帖子的操作不会创建通知

## 🔍 验证通知是否创建成功

### 方式1：查看数据库

```sql
-- 查看所有通知
SELECT * FROM user_notification ORDER BY created_time DESC;

-- 查看某个用户的通知
SELECT * FROM user_notification WHERE receiver_id = 1 ORDER BY created_time DESC;

-- 查看未读通知数量
SELECT COUNT(*) FROM user_notification WHERE receiver_id = 1 AND is_read = 0 AND is_deleted = 0;
```

### 方式2：调用API接口

```bash
# 获取所有通知
curl -X GET http://localhost:8080/api/notifications/list \
  -H "Authorization: Bearer <token>"

# 获取未读数量
curl -X GET http://localhost:8080/api/notifications/unread-count \
  -H "Authorization: Bearer <token>"
```

## 📱 前端集成建议

### 1. 通知列表页面

```javascript
// 获取通知列表
async function getNotifications() {
  const response = await fetch('/api/notifications/list', {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });
  const data = await response.json();
  
  // 显示通知列表
  displayNotifications(data.data);
}

// 标记通知为已读
async function markAsRead(notificationId) {
  await fetch(`/api/notifications/${notificationId}/read`, {
    method: 'PUT',
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });
  // 刷新列表
  getNotifications();
}
```

### 2. 通知角标

```javascript
// 获取未读数量，显示在图标角标上
async function updateNotificationBadge() {
  const response = await fetch('/api/notifications/unread-count', {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });
  const data = await response.json();
  
  // 更新角标数字
  updateBadge(data.data.unreadCount);
}

// 每30秒刷新一次
setInterval(updateNotificationBadge, 30000);
```

### 3. 通知类型筛选

```javascript
// 获取评论通知
async function getCommentNotifications() {
  const response = await fetch('/api/notifications/type/COMMENT', {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });
  const data = await response.json();
  displayNotifications(data.data);
}

// 获取收藏通知
async function getFavoriteNotifications() {
  const response = await fetch('/api/notifications/type/FAVORITE', {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });
  const data = await response.json();
  displayNotifications(data.data);
}
```

## 🐛 常见问题排查

### 问题1：评论或收藏后没有收到通知

**排查步骤**：

1. 检查是否是自己的帖子（自己不会收到通知）
2. 查看后端日志，确认是否有错误
3. 检查数据库中是否存在通知记录
4. 确认JWT token是否有效

### 问题2：重复收到通知

**原因**：系统有防重复机制，不应该出现重复通知。如果出现：

1. 检查是否对同一帖子执行了多次操作
2. 查看数据库中的通知记录
3. 检查防重复机制是否正常工作

### 问题3：通知创建失败

**可能原因**：

1. 帖子不存在
2. 用户不存在  
3. 数据库连接问题

**解决方案**：
- 查看后端日志中的错误信息
- 通知创建失败不会影响评论/收藏功能本身

## 📝 后端日志

通知相关日志示例：

```
# 评论时的通知日志
创建评论通知失败: 帖子不存在

# 收藏时的通知日志
创建收藏通知失败: 用户不存在
```

## 🎯 下一步扩展

### 1. 浏览通知集成

在帖子详情接口中添加浏览通知：

```java
// 在帖子详情接口中
@GetMapping("/{postId}")
public ResponseDTO getPostDetail(@PathVariable Long postId, Authentication authentication) {
    // ... 获取帖子详情 ...
    
    // 创建浏览通知
    if (authentication != null && authentication.isAuthenticated()) {
        String phone = authentication.getName();
        Long userId = userService.getUserIdByPhone(phone);
        try {
            notificationService.createViewNotification(postId, userId);
        } catch (Exception e) {
            // 忽略错误
        }
    }
    
    return ResponseDTO.success(postDetail);
}
```

### 2. 实时推送

可以集成WebSocket或Server-Sent Events实现实时推送：
- 用户在线时实时收到通知
- 通知角标实时更新

### 3. 通知聚合

实现通知聚合功能：
- "张三、李四等5人收藏了你的帖子"
- "本周你的帖子收到了10条新评论"

## 📚 相关文档

- [用户通知系统 API 完整文档](./USER_NOTIFICATION_API_DOCUMENTATION.md)
- [数据库表结构](./user_notification.sql)
- [帖子评论API文档](./草稿功能API文档.md)
- [帖子收藏API文档](./帖子收藏功能API文档.md)

## ✅ 完成清单

- [x] 数据库表设计和创建
- [x] 实体类创建（UserNotification）
- [x] Repository创建（UserNotificationRepository）
- [x] DTO创建（NotificationResponse, NotificationStatsResponse）
- [x] Service创建（NotificationService）
- [x] Controller创建（NotificationController）
- [x] 集成到评论功能（自动创建评论通知）
- [x] 集成到收藏功能（自动创建收藏通知）
- [x] 防重复机制实现
- [x] API文档编写
- [x] 快速测试指南编写

## 🎉 总结

用户通知系统已完全集成到现有的评论和收藏功能中，无需手动调用通知创建接口。当用户评论或收藏帖子时，系统会自动通知帖子作者。

前端只需要：
1. 调用通知列表API展示通知
2. 调用未读数量API显示角标
3. 调用标记已读/删除API管理通知

现在就可以开始测试了！ 🚀

