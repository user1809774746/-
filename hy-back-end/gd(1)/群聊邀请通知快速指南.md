# ç¾¤èŠé‚€è¯·é€šçŸ¥åŠŸèƒ½ - å¿«é€Ÿä½¿ç”¨æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### åç«¯å®ç°
- âœ… **WebSocket è‡ªåŠ¨æ¨é€**ï¼šåˆ›å»ºç¾¤èŠæ—¶è‡ªåŠ¨å‘è¢«é‚€è¯·ç”¨æˆ·æ¨é€é€šçŸ¥
- âœ… **è·å–é‚€è¯·åˆ—è¡¨**ï¼š`GET /api/group/my-invitations`
- âœ… **æ ‡è®°å·²è¯»**ï¼š`POST /api/group/invitations/{groupId}/read`
- âœ… **æ–°å¢ DTO**ï¼š`GroupInvitationNotificationDTO`ã€`GroupInvitationDTO`
- âœ… **ç¼–è¯‘æˆåŠŸ**ï¼šæ‰€æœ‰ä»£ç å·²é€šè¿‡ç¼–è¯‘

### æ–‡æ¡£
- âœ… **å®Œæ•´æ¥å£æ–‡æ¡£**ï¼š`ç¾¤èŠé‚€è¯·é€šçŸ¥æ¥å£æ–‡æ¡£.md`ï¼ˆ90+ KBï¼‰
- âœ… **å‰ç«¯é›†æˆç¤ºä¾‹**ï¼šReact + Vue å®Œæ•´ä»£ç 

---

## ğŸš€ ç«‹å³ä½¿ç”¨ï¼ˆ3æ­¥éª¤ï¼‰

### æ­¥éª¤1ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
# Ctrl+C

# é‡æ–°å¯åŠ¨
mvn spring-boot:run
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
Mapped "{[/api/group/my-invitations],methods=[GET]}"
Mapped "{[/api/group/invitations/{groupId}/read],methods=[POST]}"
Started Application in X.XXX seconds
```

### æ­¥éª¤2ï¼šå‰ç«¯æ³¨å†Œ WebSocket ç›‘å¬

```javascript
// åœ¨ WebSocket è¿æ¥æˆåŠŸåæ·»åŠ 
wsService.on('group_invitation', (response) => {
  if (!response || !response.data) return;
  
  const invitation = response.data;
  
  // æ˜¾ç¤ºé€šçŸ¥
  alert(`${invitation.inviterName || 'ç”¨æˆ·'} é‚€è¯·æ‚¨åŠ å…¥ç¾¤èŠã€Œ${invitation.groupName}ã€`);
  
  // æˆ–ä½¿ç”¨ä½ çš„ UI åº“
  // message.info(`${invitation.inviterName} é‚€è¯·æ‚¨åŠ å…¥ç¾¤èŠã€Œ${invitation.groupName}ã€`);
});
```

### æ­¥éª¤3ï¼šæµ‹è¯•åŠŸèƒ½

#### æµ‹è¯•1ï¼šåˆ›å»ºç¾¤èŠ
```bash
curl -X POST "http://localhost:8082/api/group/create-with-friends" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "creatorId": 1,
    "groupName": "æµ‹è¯•ç¾¤èŠ",
    "friendIds": [2, 3]
  }'
```

**é¢„æœŸç»“æœ**ï¼š
- ç”¨æˆ·2ã€3 æ”¶åˆ° WebSocket æ¨é€é€šçŸ¥
- å‰ç«¯æ˜¾ç¤ºå¼¹çª—ï¼š"ç”¨æˆ·1 é‚€è¯·æ‚¨åŠ å…¥ç¾¤èŠã€Œæµ‹è¯•ç¾¤èŠã€"

#### æµ‹è¯•2ï¼šè·å–é‚€è¯·åˆ—è¡¨
```bash
curl "http://localhost:8082/api/group/my-invitations?userId=2"
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "groupId": 1,
      "groupName": "æµ‹è¯•ç¾¤èŠ",
      "memberCount": 3,
      "inviterId": 1,
      "joinTime": "2025-12-10 16:30:00",
      "status": "accepted"
    }
  ]
}
```

---

## ğŸ“‹ æ¥å£é€Ÿè§ˆ

### 1. WebSocket æ¨é€ï¼ˆè‡ªåŠ¨ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- åˆ›å»ºç¾¤èŠæ—¶é€‰æ‹©å¥½å‹
- é‚€è¯·ç”¨æˆ·åŠ å…¥ç¾¤èŠ

**æ¶ˆæ¯ç±»å‹**ï¼š`group_invitation`

**å‰ç«¯ç›‘å¬**ï¼š
```javascript
wsService.on('group_invitation', (response) => {
  const { groupId, groupName, inviterName } = response.data;
  showNotification(`${inviterName} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${groupName}ã€`);
});
```

### 2. è·å–é‚€è¯·åˆ—è¡¨

```
GET /api/group/my-invitations?userId={userId}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "data": [
    {
      "groupId": 1,
      "groupName": "æŠ€æœ¯äº¤æµç¾¤",
      "memberCount": 15,
      "inviterId": 2,
      "joinTime": "2025-12-10 15:30:00"
    }
  ]
}
```

### 3. æ ‡è®°å·²è¯»

```
POST /api/group/invitations/{groupId}/read?userId={userId}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "é‚€è¯·é€šçŸ¥å·²æ ‡è®°ä¸ºå·²è¯»"
}
```

---

## ğŸ’» å‰ç«¯é›†æˆï¼ˆ3åˆ†é’Ÿï¼‰

### React æœ€å°ç¤ºä¾‹

```javascript
import { useEffect, useState } from 'react';
import axios from 'axios';

function GroupInvitationBadge({ userId, wsService }) {
  const [count, setCount] = useState(0);

  // è·å–æœªè¯»æ•°é‡
  const fetchCount = async () => {
    const res = await axios.get('/api/group/my-invitations', {
      params: { userId }
    });
    setCount(res.data.data.length);
  };

  // ç›‘å¬æ–°é‚€è¯·
  useEffect(() => {
    wsService.on('group_invitation', (response) => {
      const inv = response.data;
      alert(`${inv.inviterName || 'ç”¨æˆ·'} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${inv.groupName}ã€`);
      fetchCount();
    });

    fetchCount();
  }, [userId]);

  return (
    <div className="invitation-badge">
      <span>ç¾¤èŠé‚€è¯·</span>
      {count > 0 && <span className="badge">{count}</span>}
    </div>
  );
}
```

### Vue 3 æœ€å°ç¤ºä¾‹

```vue
<template>
  <div class="invitation-badge">
    <span>ç¾¤èŠé‚€è¯·</span>
    <span v-if="count > 0" class="badge">{{ count }}</span>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import axios from 'axios';

const props = defineProps(['userId', 'wsService']);
const count = ref(0);

const fetchCount = async () => {
  const res = await axios.get('/api/group/my-invitations', {
    params: { userId: props.userId }
  });
  count.value = res.data.data.length;
};

onMounted(() => {
  props.wsService.on('group_invitation', (response) => {
    const inv = response.data;
    alert(`${inv.inviterName || 'ç”¨æˆ·'} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${inv.groupName}ã€`);
    fetchCount();
  });
  
  fetchCount();
});
</script>
```

---

## ğŸ” éªŒè¯åŠŸèƒ½

### éªŒè¯1ï¼šåç«¯æ—¥å¿—

```bash
# é‡å¯æœåŠ¡åæŸ¥çœ‹æ—¥å¿—
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š

æ¨é€ç¾¤èŠé‚€è¯·é€šçŸ¥: userId=2, groupId=1, inviterId=1
æ¨é€ç¾¤èŠé‚€è¯·é€šçŸ¥: userId=3, groupId=1, inviterId=1
```

### éªŒè¯2ï¼šå‰ç«¯æ§åˆ¶å°

```javascript
// æ‰“å¼€æµè§ˆå™¨ F12 æ§åˆ¶å°
// åº”è¯¥çœ‹åˆ°ï¼š

ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯: {type: 'group_invitation', data: {...}}
æ”¶åˆ°ç¾¤èŠé‚€è¯·: {groupId: 1, groupName: 'æµ‹è¯•ç¾¤èŠ', ...}
```

### éªŒè¯3ï¼šåŠŸèƒ½æµ‹è¯•

1. **ç”¨æˆ·A åˆ›å»ºç¾¤èŠå¹¶é‚€è¯·ç”¨æˆ·B**
   ```bash
   POST /api/group/create-with-friends
   {
     "creatorId": 1,
     "groupName": "æµ‹è¯•",
     "friendIds": [2]
   }
   ```

2. **ç”¨æˆ·B åº”è¯¥**ï¼š
   - âœ… æ”¶åˆ° WebSocket æ¨é€
   - âœ… çœ‹åˆ°é€šçŸ¥å¼¹çª—
   - âœ… åœ¨é‚€è¯·åˆ—è¡¨ä¸­çœ‹åˆ°æ–°é‚€è¯·

3. **ç”¨æˆ·B è°ƒç”¨è·å–åˆ—è¡¨**ï¼š
   ```bash
   GET /api/group/my-invitations?userId=2
   ```
   
   åº”è¯¥è¿”å›åŒ…å«æ–°ç¾¤èŠçš„åˆ—è¡¨

---

## ğŸ“Š æ•°æ®æµç¨‹

```
ç”¨æˆ·A                WebSocketæœåŠ¡å™¨              ç”¨æˆ·B
  |                        |                        |
  | 1. åˆ›å»ºç¾¤èŠ             |                        |
  | POST /create-with-     |                        |
  |      friends           |                        |
  |----------------------->|                        |
  |                        |                        |
  |                        | 2. æ¨é€é€šçŸ¥             |
  |                        | type: group_invitation |
  |                        |----------------------->|
  |                        |                        |
  |                        |                        | 3. æ”¶åˆ°é€šçŸ¥
  |                        |                        |    æ˜¾ç¤ºå¼¹çª—
  |                        |                        |
  |                        |  4. è·å–é‚€è¯·åˆ—è¡¨        |
  |                        | GET /my-invitations    |
  |                        |<-----------------------|
  |                        |                        |
  |                        | 5. è¿”å›åˆ—è¡¨             |
  |                        |----------------------->|
  |                        |                        |
  |                        |  6. æ ‡è®°å·²è¯»            |
  |                        | POST /invitations/read |
  |                        |<-----------------------|
  |                        |                        |
  |                        | 7. æ ‡è®°æˆåŠŸ             |
  |                        |----------------------->|
```

---

## ğŸ¯ WebSocket æ¶ˆæ¯æ ¼å¼

### æ¨é€æ¶ˆæ¯

```json
{
  "type": "group_invitation",
  "data": {
    "groupId": 1,
    "groupName": "æŠ€æœ¯äº¤æµç¾¤",
    "groupAvatar": "http://example.com/avatar.jpg",
    "groupDescription": "åˆ†äº«æŠ€æœ¯",
    "currentMembers": 5,
    "maxMembers": 200,
    
    "inviterId": 1,
    "inviterName": null,
    "inviterAvatar": null,
    
    "invitationTime": "2025-12-10 16:00:00",
    "notificationType": "group_invitation",
    "invitationMessage": "æ‚¨è¢«é‚€è¯·åŠ å…¥äº†ç¾¤èŠ"
  },
  "success": true,
  "timestamp": 1702195200000
}
```

### å‰ç«¯å¤„ç†

```javascript
wsService.on('group_invitation', (response) => {
  // å®‰å…¨è®¿é—®
  const data = response?.data;
  if (!data) return;
  
  // è·å–ä¿¡æ¯
  const groupName = data.groupName;
  const inviterName = data.inviterName || 'ç”¨æˆ·';
  const groupId = data.groupId;
  
  // æ˜¾ç¤ºé€šçŸ¥
  showNotification({
    title: 'ç¾¤èŠé‚€è¯·',
    message: `${inviterName} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${groupName}ã€`,
    duration: 5000,
    onClick: () => {
      // è·³è½¬åˆ°ç¾¤èŠ
      router.push(`/group/${groupId}`);
    }
  });
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. inviterName å¯èƒ½ä¸º null

**åŸå› **ï¼šå½“å‰ç‰ˆæœ¬æœªå®ç°ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
const inviterName = invitation.inviterName || `ç”¨æˆ·${invitation.inviterId}`;
```

### 2. é‚€è¯·åˆ—è¡¨åªæ˜¾ç¤º7å¤©å†…çš„

**åŸå› **ï¼šé¿å…åˆ—è¡¨è¿‡é•¿

**å¦‚éœ€ä¿®æ”¹**ï¼š
```java
// GroupChatServiceImpl.java ç¬¬573è¡Œ
LocalDateTime sevenDaysAgo = LocalDateTime.now().minusDays(7);
// æ”¹ä¸ºï¼š
LocalDateTime sevenDaysAgo = LocalDateTime.now().minusDays(30); // 30å¤©
```

### 3. å·²è¯»çŠ¶æ€æœªæŒä¹…åŒ–

**å½±å“**ï¼šåˆ·æ–°é¡µé¢åå·²è¯»çŠ¶æ€ä¼šä¸¢å¤±

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼šä½¿ç”¨ localStorage ç¼“å­˜
```javascript
// æ ‡è®°å·²è¯»å
localStorage.setItem(`invitation_read_${groupId}`, 'true');

// æ˜¾ç¤ºæ—¶æ£€æŸ¥
const hasRead = localStorage.getItem(`invitation_read_${groupId}`) === 'true';
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ”¶ä¸åˆ° WebSocket æ¨é€ï¼Ÿ

**æ£€æŸ¥æ¸…å•**ï¼š
```javascript
// 1. WebSocket æ˜¯å¦è¿æ¥
console.log('è¿æ¥çŠ¶æ€:', wsService.isConnected());

// 2. æ˜¯å¦æ³¨å†Œç›‘å¬å™¨
console.log('ç›‘å¬å™¨:', wsService.getHandlers());

// 3. ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®
console.log('å½“å‰ç”¨æˆ·ID:', currentUserId);

// 4. æµ‹è¯•æ¨é€
wsService.send({
  type: 'ping',
  data: { userId: currentUserId }
});
```

### Q2: é‚€è¯·åˆ—è¡¨ä¸ºç©ºï¼Ÿ

**åŸå› **ï¼š
1. ç”¨æˆ·æœ€è¿‘7å¤©æ²¡æœ‰è¢«é‚€è¯·åŠ å…¥æ–°ç¾¤
2. æ‰€æœ‰ç¾¤éƒ½æ˜¯è‡ªå·±åˆ›å»ºçš„ï¼ˆç¾¤ä¸»è§’è‰²ï¼‰
3. åŠ å…¥çš„ç¾¤å·²è§£æ•£

**éªŒè¯**ï¼š
```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„ç¾¤æˆå‘˜è®°å½•
SELECT * FROM group_members 
WHERE user_id = 2 
AND member_status = 'active'
AND join_time > DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### Q3: å¦‚ä½•è‡ªå®šä¹‰é€šçŸ¥æ ·å¼ï¼Ÿ

```javascript
// ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶
wsService.on('group_invitation', (response) => {
  const inv = response.data;
  
  // Ant Design
  notification.open({
    message: 'ç¾¤èŠé‚€è¯·',
    description: `${inv.inviterName} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${inv.groupName}ã€`,
    icon: <TeamOutlined style={{ color: '#108ee9' }} />,
    btn: (
      <Button type="primary" size="small" onClick={() => enterGroup(inv.groupId)}>
        ç«‹å³åŠ å…¥
      </Button>
    ),
  });
  
  // Element Plus
  ElNotification({
    title: 'ç¾¤èŠé‚€è¯·',
    message: h('div', [
      h('span', `${inv.inviterName} é‚€è¯·æ‚¨åŠ å…¥ã€Œ${inv.groupName}ã€`),
      h('el-button', { onClick: () => enterGroup(inv.groupId) }, 'ç«‹å³åŠ å…¥')
    ]),
    type: 'info',
  });
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`ç¾¤èŠé‚€è¯·é€šçŸ¥æ¥å£æ–‡æ¡£.md`** - å®Œæ•´çš„APIæ–‡æ¡£
2. **`ç¾¤èŠæ¥å£å®Œæ•´æ–‡æ¡£.md`** - æ‰€æœ‰ç¾¤èŠæ¥å£
3. **`WebSocketæ¶ˆæ¯æ ¼å¼è¯´æ˜.md`** - WebSocketæ¶ˆæ¯ç»“æ„
4. **`äº‹åŠ¡å›æ»šé—®é¢˜-ç«‹å³ä¿®å¤æŒ‡å—.md`** - WebSocketç›¸å…³ä¿®å¤

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

âœ… **WebSocket å®æ—¶æ¨é€**
- åˆ›å»ºç¾¤èŠæ—¶è‡ªåŠ¨æ¨é€
- åŒ…å«å®Œæ•´çš„ç¾¤èŠå’Œé‚€è¯·äººä¿¡æ¯

âœ… **é‚€è¯·åˆ—è¡¨æŸ¥è¯¢**
- è·å–æœ€è¿‘7å¤©çš„é‚€è¯·
- è‡ªåŠ¨è¿‡æ»¤è‡ªå·±åˆ›å»ºçš„ç¾¤

âœ… **æ ‡è®°å·²è¯»**
- æ”¯æŒå•ä¸ªç¾¤èŠæ ‡è®°

### ä½¿ç”¨æ­¥éª¤

1. âœ… é‡å¯åç«¯æœåŠ¡
2. âœ… å‰ç«¯æ³¨å†Œ WebSocket ç›‘å¬å™¨
3. âœ… æµ‹è¯•åˆ›å»ºç¾¤èŠ
4. âœ… éªŒè¯æ”¶åˆ°æ¨é€é€šçŸ¥

### ç«‹å³å¯ç”¨

æ‰€æœ‰ä»£ç å·²ç¼–è¯‘é€šè¿‡ï¼Œæ¥å£å·²å¯ç”¨ï¼

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-12-10  
**ç¼–è¯‘çŠ¶æ€**ï¼šâœ… BUILD SUCCESS  
**æ¥å£çŠ¶æ€**ï¼šâœ… å¯ç”¨  
**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
