# 服务器部署指南

> 域名：www.amapmcpserver.xyz  
> 最后更新：2025-11-05

---

## ✅ 已完成的配置

### 1. CORS 跨域配置（已适配你的域名）
- ✅ 支持 `https://www.amapmcpserver.xyz`
- ✅ 支持 `https://amapmcpserver.xyz`（不带 www）
- ✅ 保留本地开发支持（`http://localhost:*`）

### 2. 代码无需修改
- ✅ CORS 配置已经包含你的域名
- ✅ 支持 HTTPS（生产环境）
- ✅ 支持 HTTP（本地开发）

---

## 📋 部署前需要确认的配置

### 1. 数据库配置（重要！）

打开 `src/main/resources/application.properties`，修改以下配置：

```properties
# 当前配置（本地开发）
spring.datasource.url=jdbc:mysql://localhost:3306/gd_mcp?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&autoReconnect=true&useUnicode=true&characterEncoding=utf8
spring.datasource.username=root
spring.datasource.password=123456
```

**服务器部署时，请修改为：**

```properties
# 选项1：如果 MySQL 在同一台服务器上
spring.datasource.url=jdbc:mysql://localhost:3306/gd_mcp?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&autoReconnect=true&useUnicode=true&characterEncoding=utf8
spring.datasource.username=你的数据库用户名
spring.datasource.password=你的数据库密码

# 选项2：如果 MySQL 在其他服务器上（如云数据库）
spring.datasource.url=jdbc:mysql://数据库服务器IP:3306/gd_mcp?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&autoReconnect=true&useUnicode=true&characterEncoding=utf8
spring.datasource.username=你的数据库用户名
spring.datasource.password=你的数据库密码

# 选项3：如果使用云数据库（如阿里云RDS、腾讯云等）
spring.datasource.url=jdbc:mysql://rm-xxxxx.mysql.rds.aliyuncs.com:3306/gd_mcp?useSSL=true&serverTimezone=UTC&allowPublicKeyRetrieval=true&autoReconnect=true&useUnicode=true&characterEncoding=utf8
spring.datasource.username=你的数据库用户名
spring.datasource.password=你的数据库密码
```

### 2. 服务器端口配置

```properties
# 当前配置
server.port=8081

# 部署选项：
# - 如果使用 Nginx 反向代理，保持 8081
# - 如果直接暴露服务，建议改为 80 或 8080
server.port=8081
```

### 3. 确认数据库已创建

在服务器上的 MySQL 中执行：

```sql
CREATE DATABASE IF NOT EXISTS gd_mcp 
  CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;
```

---

## 🚀 部署步骤

### 方式一：使用 Maven 打包部署（推荐）

#### 1. 在本地打包

```bash
# 清理并打包
mvn clean package -DskipTests

# 打包完成后，会在 target 目录下生成 jar 文件
# 文件名类似：auth-system-1.0-SNAPSHOT.jar
```

#### 2. 上传到服务器

将 `target/auth-system-1.0-SNAPSHOT.jar` 上传到服务器，例如：

```bash
# 使用 scp 上传（在本地执行）
scp target/auth-system-1.0-SNAPSHOT.jar root@你的服务器IP:/root/backend/

# 或使用 FTP 工具（如 FileZilla）上传
```

#### 3. 在服务器上运行

```bash
# SSH 登录服务器
ssh root@你的服务器IP

# 进入目录
cd /root/backend/

# 运行 jar 包
java -jar auth-system-1.0-SNAPSHOT.jar

# 或在后台运行（推荐）
nohup java -jar auth-system-1.0-SNAPSHOT.jar > app.log 2>&1 &

# 查看日志
tail -f app.log
```

### 方式二：在服务器上直接编译运行

#### 1. 上传源代码

将整个项目上传到服务器

#### 2. 在服务器上编译运行

```bash
# 安装 Maven（如果没有）
yum install -y maven  # CentOS/RHEL
apt install -y maven  # Ubuntu/Debian

# 进入项目目录
cd /root/backend/gd/

# 运行
mvn spring-boot:run

# 或打包后运行
mvn clean package -DskipTests
java -jar target/auth-system-1.0-SNAPSHOT.jar
```

---

## 🔧 Nginx 反向代理配置（推荐）

如果你使用 Nginx 作为反向代理，配置如下：

### 1. 创建 Nginx 配置文件

```bash
# 创建配置文件
nano /etc/nginx/conf.d/backend.conf
```

### 2. 配置内容

```nginx
# 后端 API 配置
server {
    listen 80;
    server_name www.amapmcpserver.xyz amapmcpserver.xyz;

    # 如果配置了 SSL 证书，使用以下配置
    # listen 443 ssl;
    # ssl_certificate /path/to/your/certificate.crt;
    # ssl_certificate_key /path/to/your/private.key;

    # API 请求转发到后端
    location /api/ {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '$http_origin' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            return 204;
        }
    }
}
```

### 3. 重启 Nginx

```bash
# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

---

## 📱 前端配置

### 前端 API 基础地址配置

在你的前端项目中，修改 API 基础地址：

```javascript
// 开发环境（本地）
const API_BASE_URL = 'http://localhost:8081';

// 生产环境（服务器）
// 选项1：如果使用 Nginx 反向代理（推荐）
const API_BASE_URL = 'https://www.amapmcpserver.xyz';

// 选项2：如果后端直接暴露（需要开放 8081 端口）
const API_BASE_URL = 'https://www.amapmcpserver.xyz:8081';

// 或使用环境变量
const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? 'https://www.amapmcpserver.xyz'
  : 'http://localhost:8081';
```

### 前端请求示例

```javascript
// 登录请求
fetch(`${API_BASE_URL}/api/auth/login`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  credentials: 'include', // 重要：允许携带凭证
  body: JSON.stringify({
    username: 'testuser',
    password: 'password123',
    userType: 'user'
  })
})
.then(response => response.json())
.then(data => {
  console.log('登录成功:', data);
  localStorage.setItem('token', data.data.token);
});
```

---

## 🔒 使用 HTTPS（推荐）

### 1. 申请 SSL 证书

免费 SSL 证书推荐：
- Let's Encrypt（certbot）
- 云服务商免费 SSL（阿里云、腾讯云等）

### 2. 配置 SSL

使用 certbot 自动配置：

```bash
# 安装 certbot
yum install -y certbot python3-certbot-nginx  # CentOS
apt install -y certbot python3-certbot-nginx  # Ubuntu

# 自动配置 SSL
certbot --nginx -d www.amapmcpserver.xyz -d amapmcpserver.xyz

# 自动续期（添加到 crontab）
echo "0 0 1 * * certbot renew --quiet" | crontab -
```

---

## ✅ 验证部署成功

### 1. 检查后端是否启动

```bash
# 检查进程
ps aux | grep java

# 检查端口
netstat -tulpn | grep 8081

# 检查日志
tail -f app.log
```

### 2. 测试 API 接口

```bash
# 测试健康检查
curl http://localhost:8081/api/auth/check-auto-login

# 或从外部访问
curl https://www.amapmcpserver.xyz/api/auth/check-auto-login
```

### 3. 前端测试

在浏览器访问前端，测试登录功能是否正常。

---

## 📊 部署清单

部署前请确认：

- [ ] 已修改 `application.properties` 中的数据库配置
- [ ] 数据库已创建（`gd_mcp`）
- [ ] 服务器已安装 Java 17（`java -version`）
- [ ] 服务器已安装 Maven（如果需要编译）
- [ ] 已打包 jar 文件或上传源代码
- [ ] 已配置 Nginx 反向代理（如果使用）
- [ ] 已申请并配置 SSL 证书（推荐）
- [ ] 防火墙已开放相应端口（8081 或 80/443）
- [ ] 前端已配置正确的 API 地址

---

## 🔥 常见问题

### 1. 端口被占用

```bash
# 查看占用端口的进程
lsof -i :8081

# 停止进程
kill -9 进程ID
```

### 2. 前端跨域错误

**原因**：前端域名不在 CORS 白名单中

**解决**：已经配置好，支持 `https://www.amapmcpserver.xyz` 和 `https://amapmcpserver.xyz`

### 3. 数据库连接失败

```bash
# 检查 MySQL 是否运行
systemctl status mysql

# 检查数据库是否存在
mysql -u root -p -e "SHOW DATABASES;"

# 测试数据库连接
mysql -u 用户名 -p -h 数据库地址 gd_mcp
```

### 4. 服务启动后立即停止

查看日志找到错误原因：

```bash
# 查看完整日志
cat app.log

# 或在前台运行查看错误
java -jar auth-system-1.0-SNAPSHOT.jar
```

---

## 🎯 部署后访问地址

根据你的配置：

**使用 Nginx 反向代理（推荐）：**
- 前端：`https://www.amapmcpserver.xyz`
- 后端 API：`https://www.amapmcpserver.xyz/api/...`

**后端直接暴露（需要开放 8081 端口）：**
- 前端：`https://www.amapmcpserver.xyz`
- 后端 API：`https://www.amapmcpserver.xyz:8081/api/...`

---

## 📞 技术支持

如果部署过程中遇到问题，请提供：
1. 错误日志（`app.log` 或控制台输出）
2. 配置文件内容（脱敏后）
3. 服务器环境信息（系统版本、Java 版本等）

---

**祝部署顺利！** 🎉

