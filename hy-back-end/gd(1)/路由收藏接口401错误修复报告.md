# ğŸ”§ è·¯ç”±æ”¶è—æ¥å£401é”™è¯¯ä¿®å¤æŠ¥å‘Š

> **é—®é¢˜æ¥å£**: `POST /api/favorites/route/favorite`  
> **é”™è¯¯ä»£ç **: 401 Unauthorized  
> **é”™è¯¯ä¿¡æ¯**: "User not authenticated or not found."  
> **ä¿®å¤æ—¥æœŸ**: 2025-11-02  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ“‹ é—®é¢˜æè¿°

### é—®é¢˜ç°è±¡

ç”¨æˆ·åœ¨è°ƒç”¨è·¯ç”±æ”¶è—æ¥å£æ—¶ï¼Œå³ä½¿æä¾›äº†æ­£ç¡®çš„Tokenå’Œè¯·æ±‚å‚æ•°ï¼Œåç«¯ä»ç„¶è¿”å›401é”™è¯¯ï¼š

```json
{
    "code": 401,
    "message": "User not authenticated or not found.",
    "data": null
}
```

### å½±å“èŒƒå›´

- âœ… å½±å“æ¥å£ï¼š
  - `POST /api/favorites/route/favorite` - æ”¶è—è·¯çº¿
  - `POST /api/favorites/route/unfavorite/{routeId}` - å–æ¶ˆæ”¶è—

- âŒ ä¸å½±å“æ¥å£ï¼š
  - ç™»å½•æ¥å£æ­£å¸¸
  - JWTè®¤è¯æ­£å¸¸
  - å…¶ä»–ç”¨æˆ·ä¿¡æ¯æ¥å£æ­£å¸¸

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### æŠ€æœ¯å±‚é¢åŸå› 

è¿™æ˜¯ä¸€ä¸ª**å­—æ®µæ˜ å°„ä¸åŒ¹é…**å¯¼è‡´çš„é—®é¢˜ï¼š

#### 1ï¸âƒ£ JWTè®¤è¯æµç¨‹ï¼ˆæ­£å¸¸ï¼‰

```java
// JwtAuthenticationFilter.java:44-48
UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
    phone,  // ğŸ‘ˆ JWTä¸­å­˜å‚¨çš„æ˜¯æ‰‹æœºå·ï¼Œå¦‚ï¼š"13800138000"
    null,
    Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + userType.toUpperCase()))
);
SecurityContextHolder.getContext().setAuthentication(authentication);
```

âœ… **è®¤è¯æˆåŠŸ**ï¼šTokenéªŒè¯é€šè¿‡ï¼Œç”¨æˆ·æ‰‹æœºå·ä¸º `13800138000`

#### 2ï¸âƒ£ Controllerè·å–è®¤è¯ä¿¡æ¯ï¼ˆæ­£å¸¸ï¼‰

```java
// RouteFavoriteController.java:27
Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
String username = authentication.getName();
// ğŸ‘ˆ username = "13800138000" ï¼ˆå®é™…æ˜¯æ‰‹æœºå·ï¼‰
```

âœ… **è·å–æˆåŠŸ**ï¼šauthentication.getName() è¿”å› `13800138000`

#### 3ï¸âƒ£ æŸ¥è¯¢ç”¨æˆ·IDï¼ˆâŒ é—®é¢˜æ‰€åœ¨ï¼‰

```java
// UserService.java:14-17 ï¼ˆä¿®å¤å‰ï¼‰
public Long getUserIdByUsername(String username) {
    return userRepository.findByUsername(username)  // âŒ é”™è¯¯ï¼šé€šè¿‡usernameå­—æ®µæŸ¥è¯¢
            .map(User::getUserId)
            .orElse(null);  // æŸ¥è¯¢ä¸åˆ°ï¼Œè¿”å›null
}
```

âŒ **æŸ¥è¯¢å¤±è´¥**ï¼š
- æŸ¥è¯¢æ¡ä»¶ï¼š`WHERE Username = '13800138000'`
- æ•°æ®åº“å®é™…ï¼š`Username` å­—æ®µå¯èƒ½ä¸ºç©ºæˆ–ä¸ºå…¶ä»–å€¼
- æ­£ç¡®å­—æ®µï¼šåº”è¯¥æŸ¥è¯¢ `Number` å­—æ®µï¼ˆå­˜å‚¨æ‰‹æœºå·ï¼‰

#### 4ï¸âƒ£ è¿”å›401é”™è¯¯

```java
if (userId == null) {
    return ResponseEntity.status(401).body(
        ResponseDTO.error(401, "User not authenticated or not found.")
    );
}
```

### æ•°æ®åº“è¡¨ç»“æ„

**user_info è¡¨**:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|------|--------|
| UserID | BIGINT | ä¸»é”® | 1 |
| **Username** | VARCHAR | ç”¨æˆ·åï¼ˆå¯èƒ½ä¸ºç©ºï¼‰ | null æˆ– "user001" |
| **Number** | VARCHAR | æ‰‹æœºå·ï¼ˆå­˜å‚¨ç™»å½•ä¿¡æ¯ï¼‰| "13800138000" âœ… |
| Password | VARCHAR | å¯†ç  | "$2a$10$..." |
| ... | ... | ... | ... |

### é—®é¢˜æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚ â†’ JWTéªŒè¯ â†’ è·å–phone â†’ é”™è¯¯æŸ¥è¯¢å­—æ®µ â†’ æŸ¥ä¸åˆ°ç”¨æˆ· â†’ è¿”å›401
         âœ…          âœ…            âŒ               âŒ           âŒ
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹1: UserService.java

æ·»åŠ é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·IDçš„æ–¹æ³•ï¼š

```java
/**
 * é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ID
 * @param phone æ‰‹æœºå·
 * @return ç”¨æˆ·IDï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›null
 */
public Long getUserIdByPhone(String phone) {
    return userRepository.findByNumber(phone)
            .map(User::getUserId)
            .orElse(null);
}
```

**ä¿®æ”¹ä½ç½®**: `src/main/java/com/example/auth/service/UserService.java`

### ä¿®æ”¹2: RouteFavoriteController.java

ä¿®æ”¹æ”¶è—æ¥å£ï¼Œä½¿ç”¨æ­£ç¡®çš„æŸ¥è¯¢æ–¹æ³•ï¼š

#### æ”¶è—è·¯çº¿æ¥å£

```java
@PostMapping("/favorite")
public ResponseEntity<ResponseDTO> favoriteRoute(@RequestBody TripSchemeDTO tripSchemeDTO) {
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    String phone = authentication.getName(); // JWTä¸­å­˜å‚¨çš„æ˜¯æ‰‹æœºå· âœ…
    Long userId = userService.getUserIdByPhone(phone); // ä½¿ç”¨æ‰‹æœºå·æŸ¥è¯¢ âœ…

    if (userId == null) {
        return ResponseEntity.status(401).body(
            ResponseDTO.error(401, "User not authenticated or not found.")
        );
    }
    // ... åç»­é€»è¾‘
}
```

#### å–æ¶ˆæ”¶è—æ¥å£

```java
@PostMapping("/unfavorite/{routeId}")
public ResponseEntity<ResponseDTO> unfavoriteRoute(@PathVariable Integer routeId) {
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    String phone = authentication.getName(); // JWTä¸­å­˜å‚¨çš„æ˜¯æ‰‹æœºå· âœ…
    Long userId = userService.getUserIdByPhone(phone); // ä½¿ç”¨æ‰‹æœºå·æŸ¥è¯¢ âœ…
    
    // ... åç»­é€»è¾‘
}
```

**ä¿®æ”¹ä½ç½®**: `src/main/java/com/example/auth/controller/RouteFavoriteController.java`

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•å‰å‡†å¤‡

1. **ç¡®ä¿ç”¨æˆ·å·²æ³¨å†Œå¹¶ç™»å½•**
```bash
# 1. æ³¨å†Œç”¨æˆ·
POST /api/auth/register
{
  "phone": "13800138000",
  "verificationCode": "123456",
  "password": "test123",
  "confirmPassword": "test123",
  "userType": "user"
}

# 2. ç™»å½•è·å–Token
POST /api/auth/login
{
  "phone": "13800138000",
  "password": "test123",
  "userType": "user"
}

# ä¿å­˜è¿”å›çš„token
```

### æµ‹è¯•æ­¥éª¤

#### âœ… æµ‹è¯•1: æ”¶è—è·¯çº¿

**è¯·æ±‚**:
```bash
POST http://localhost:8081/api/favorites/route/favorite
Headers:
  Content-Type: application/json
  Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

Body:
{
  "tripName": "åŒ—äº¬ä¸‰æ—¥æ¸¸",
  "startLocation": "åŒ—äº¬ç«™",
  "endLocation": "æ•…å®«",
  "startTime": "2025-11-10 09:00:00",
  "totalDistance": 25.5,
  "totalDuration": 180,
  "tripType": "æ–‡åŒ–æ¸¸",
  "waypoints": [
    {
      "poiName": "å¤©å®‰é—¨å¹¿åœº",
      "poiAddress": "åŒ—äº¬å¸‚ä¸œåŸåŒº",
      "poiType": "æ™¯ç‚¹",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "visitDuration": 60,
      "orderIndex": 1
    }
  ]
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": "Trip scheme favorited successfully."
}
```

#### âœ… æµ‹è¯•2: å–æ¶ˆæ”¶è—

**è¯·æ±‚**:
```bash
POST http://localhost:8081/api/favorites/route/unfavorite/1
Headers:
  Content-Type: application/json
  Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": "Trip scheme unfavorited successfully."
}
```

### Postmanæµ‹è¯•é…ç½®

#### ç¯å¢ƒå˜é‡
```
baseUrl: http://localhost:8081
token: (ç™»å½•åè‡ªåŠ¨ä¿å­˜)
phone: 13800138000
```

#### æ”¶è—è·¯çº¿ - Postmané…ç½®

**Method**: POST  
**URL**: `{{baseUrl}}/api/favorites/route/favorite`  
**Headers**:
```
Content-Type: application/json
Authorization: Bearer {{token}}
```
**Body** (raw, JSON):
```json
{
  "tripName": "æµ‹è¯•è·¯çº¿",
  "startLocation": "èµ·ç‚¹",
  "endLocation": "ç»ˆç‚¹",
  "startTime": "2025-11-10 09:00:00",
  "totalDistance": 10.5,
  "totalDuration": 120,
  "tripType": "æµ‹è¯•",
  "waypoints": []
}
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### ä¿®å¤å‰

| æµ‹è¯•ç”¨ä¾‹ | è¯·æ±‚çŠ¶æ€ | å“åº”çŠ¶æ€ç  | ç»“æœ |
|---------|---------|-----------|------|
| Tokenè®¤è¯ | âœ… | 200 | é€šè¿‡ |
| è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… | 200 | é€šè¿‡ |
| æ”¶è—è·¯çº¿ | âŒ | 401 | **å¤±è´¥** |
| å–æ¶ˆæ”¶è— | âŒ | 401 | **å¤±è´¥** |

**é”™è¯¯ä¿¡æ¯**:
```json
{
    "code": 401,
    "message": "User not authenticated or not found.",
    "data": null
}
```

### ä¿®å¤å

| æµ‹è¯•ç”¨ä¾‹ | è¯·æ±‚çŠ¶æ€ | å“åº”çŠ¶æ€ç  | ç»“æœ |
|---------|---------|-----------|------|
| Tokenè®¤è¯ | âœ… | 200 | é€šè¿‡ |
| è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… | 200 | é€šè¿‡ |
| æ”¶è—è·¯çº¿ | âœ… | 200 | **æˆåŠŸ** âœ… |
| å–æ¶ˆæ”¶è— | âœ… | 200 | **æˆåŠŸ** âœ… |

**æˆåŠŸå“åº”**:
```json
{
    "code": 200,
    "message": "æ“ä½œæˆåŠŸ",
    "data": "Trip scheme favorited successfully."
}
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **é—®é¢˜ç±»å‹** | å­—æ®µæ˜ å°„ä¸åŒ¹é… |
| **é”™è¯¯ä½ç½®** | UserService.getUserIdByUsername() |
| **æ ¹æœ¬åŸå› ** | JWTå­˜å‚¨phoneï¼Œä½†ç”¨usernameå­—æ®µæŸ¥è¯¢ |
| **å½±å“æ¥å£** | è·¯ç”±æ”¶è—ç›¸å…³æ¥å£ |
| **ä¿®å¤æ–¹å¼** | æ·»åŠ getUserIdByPhone()æ–¹æ³• |

### JWTè®¤è¯ç³»ç»Ÿä¸­çš„å­—æ®µå¯¹åº”å…³ç³»

```
JWT Tokenä¸­:
  - å­˜å‚¨å­—æ®µ: phone (æ‰‹æœºå·)
  - ç¤ºä¾‹å€¼: "13800138000"

Spring Securityä¸­:
  - authentication.getName() è¿”å›: phone
  
æ•°æ®åº“è¡¨ user_info:
  - Usernameå­—æ®µ: ç”¨æˆ·åï¼ˆå¯èƒ½ä¸ºç©ºï¼‰âŒ
  - Numberå­—æ®µ: æ‰‹æœºå·ï¼ˆç™»å½•å‡­è¯ï¼‰âœ…

æ­£ç¡®åšæ³•:
  - ä½¿ç”¨ userRepository.findByNumber(phone) âœ…
```

---

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç»Ÿä¸€å‘½åè§„èŒƒ

å»ºè®®ç»Ÿä¸€å­—æ®µå‘½åï¼Œé¿å…æ··æ·†ï¼š

```java
// å»ºè®®çš„æ”¹è¿›
public class User {
    private String phone;      // è€Œä¸æ˜¯ number
    private String username;   // ä¿æŒä¸å˜
}

// å¯¹åº”çš„Repositoryæ–¹æ³•
Optional<User> findByPhone(String phone);  // è€Œä¸æ˜¯ findByNumber
```

### 2. æ·»åŠ æ—¥å¿—

åœ¨ç”¨æˆ·æŸ¥è¯¢å¤±è´¥æ—¶æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```java
public Long getUserIdByPhone(String phone) {
    Optional<User> userOpt = userRepository.findByNumber(phone);
    
    if (userOpt.isEmpty()) {
        System.err.println("âŒ ç”¨æˆ·æŸ¥è¯¢å¤±è´¥ - æ‰‹æœºå·: " + phone);
        System.err.println("   è¯·æ£€æŸ¥: 1) ç”¨æˆ·æ˜¯å¦å­˜åœ¨ 2) æ‰‹æœºå·æ˜¯å¦æ­£ç¡®");
    }
    
    return userOpt.map(User::getUserId).orElse(null);
}
```

### 3. ç»Ÿä¸€å¼‚å¸¸å¤„ç†

åˆ›å»ºç»Ÿä¸€çš„ç”¨æˆ·è®¤è¯å¼‚å¸¸ï¼š

```java
public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String phone) {
        super("ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ‰‹æœºå·: " + phone);
    }
}
```

### 4. æ£€æŸ¥å…¶ä»–Controller

æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–Controllerä¹Ÿä½¿ç”¨äº†é”™è¯¯çš„æŸ¥è¯¢æ–¹å¼ï¼š

```bash
# æœç´¢å‘½ä»¤
grep -r "getUserIdByUsername" src/main/java/com/example/auth/controller/
```

**æ£€æŸ¥ç»“æœ**: âœ… æ— å…¶ä»–Controllerä½¿ç”¨è¯¥æ–¹æ³•

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | å½±å“ |
|---------|---------|------|
| `src/main/java/com/example/auth/service/UserService.java` | æ·»åŠ  `getUserIdByPhone()` æ–¹æ³• | ğŸ†• æ–°å¢åŠŸèƒ½ |
| `src/main/java/com/example/auth/controller/RouteFavoriteController.java` | ä¿®æ”¹ `favoriteRoute()` æ–¹æ³• | ğŸ”§ ä¿®å¤Bug |
| `src/main/java/com/example/auth/controller/RouteFavoriteController.java` | ä¿®æ”¹ `unfavoriteRoute()` æ–¹æ³• | ğŸ”§ ä¿®å¤Bug |

### éœ€è¦é‡å¯æœåŠ¡

âš ï¸ **é‡è¦**: ä¿®æ”¹å®Œæˆåéœ€è¦é‡å¯Spring Bootåº”ç”¨æ‰èƒ½ç”Ÿæ•ˆï¼

```bash
# åœæ­¢åº”ç”¨
Ctrl + C

# é‡æ–°å¯åŠ¨
mvn spring-boot:run

# æˆ–åœ¨IDEAä¸­ç‚¹å‡»é‡å¯æŒ‰é’®
```

---

## ğŸ‰ é—®é¢˜å·²è§£å†³

### ä¿®å¤ç¡®è®¤æ¸…å•

- [x] æ·»åŠ  `getUserIdByPhone()` æ–¹æ³•
- [x] ä¿®æ”¹ `favoriteRoute()` æ¥å£
- [x] ä¿®æ”¹ `unfavoriteRoute()` æ¥å£
- [x] ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯
- [x] æ£€æŸ¥å…¶ä»–Controlleræ— ç±»ä¼¼é—®é¢˜

### ä½¿ç”¨è¯´æ˜

1. **é‡å¯åç«¯æœåŠ¡**
2. **é‡æ–°ç™»å½•è·å–Token**ï¼ˆç¡®ä¿Tokenæœ‰æ•ˆï¼‰
3. **è°ƒç”¨æ”¶è—æ¥å£**
4. **éªŒè¯å“åº”ä¸º200**

### è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- åç«¯æ—¥å¿—ï¼šIDEAæ§åˆ¶å°
- æ•°æ®åº“æ•°æ®ï¼šæ£€æŸ¥user_infoè¡¨çš„Numberå­—æ®µ
- å…¶ä»–æ–‡æ¡£ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„å…¶ä»–.mdæ–‡ä»¶

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-02  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

