# èŠå¤©åŠŸèƒ½é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šWebSocketè¿æ¥å¤±è´¥
**é”™è¯¯ç°è±¡**ï¼š
```
ChatPage.jsx:147 WebSocketæœªè¿æ¥ï¼Œä»…ä½¿ç”¨HTTPå‘é€æ¶ˆæ¯
```

**åŸå› åˆ†æ**ï¼š
- å‰ç«¯WebSocketé…ç½®ä»ç„¶ä½¿ç”¨é”™è¯¯çš„ç«¯å£ï¼ˆ8080ï¼‰
- åç«¯å®é™…è¿è¡Œåœ¨8082ç«¯å£
- éœ€è¦ä¿®æ”¹å‰ç«¯WebSocketæœåŠ¡é…ç½®

### é—®é¢˜2ï¼šæ¶ˆæ¯å‘é€å¤„ç†é”™è¯¯
**é”™è¯¯ç°è±¡**ï¼š
```javascript
å‘é€æ¶ˆæ¯å¤±è´¥: TypeError: Cannot read properties of null (reading 'messageId')
at handleSendMessage (ChatPage.jsx:152:29)
```

**åŸå› åˆ†æ**ï¼š
- HTTP APIè°ƒç”¨æˆåŠŸï¼š`{code: 200, message: 'æ¶ˆæ¯å‘é€æˆåŠŸ', data: null, success: true}`
- ä½†åç«¯è¿”å›çš„`data`å­—æ®µä¸º`null`ï¼Œå‰ç«¯ä»£ç å°è¯•è®¿é—®`data.messageId`æ—¶å‡ºé”™
- å‰ç«¯ä»£ç æ²¡æœ‰æ­£ç¡®å¤„ç†åç«¯è¿”å›`data: null`çš„æƒ…å†µ

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤å‰ç«¯WebSocketé…ç½®

**æ­¥éª¤1ï¼šæ‰¾åˆ°WebSocketæœåŠ¡æ–‡ä»¶**
åœ¨å‰ç«¯é¡¹ç›®ä¸­æ‰¾åˆ°ä»¥ä¸‹å¯èƒ½çš„æ–‡ä»¶ï¼š
- `src/services/WebSocketService.js`
- `src/utils/websocket.js`
- `src/api/websocket.js`
- æˆ–è€…åœ¨ç»„ä»¶ä¸­ç›´æ¥ä½¿ç”¨WebSocketçš„åœ°æ–¹

**æ­¥éª¤2ï¼šä¿®æ”¹WebSocketè¿æ¥URL**
å°†æ‰€æœ‰WebSocketè¿æ¥ä»ï¼š
```javascript
// âŒ é”™è¯¯é…ç½®
ws://localhost:8080/ws/chat/native?userId=1
```
æ”¹ä¸ºï¼š
```javascript
// âœ… æ­£ç¡®é…ç½®  
ws://localhost:8082/ws/chat/native?userId=1
```

**æ­¥éª¤3ï¼šæ£€æŸ¥Viteä»£ç†é…ç½®**
å¦‚æœä½¿ç”¨Viteå¼€å‘æœåŠ¡å™¨ï¼Œæ£€æŸ¥`vite.config.js`ä¸­çš„ä»£ç†é…ç½®ï¼š
```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8082',  // ç¡®ä¿æ˜¯8082ç«¯å£
        changeOrigin: true
      },
      '/ws': {
        target: 'ws://localhost:8082',    // WebSocketä»£ç†ä¹Ÿè¦8082
        ws: true,
        changeOrigin: true
      }
    }
  }
})
```

### æ–¹æ¡ˆ2ï¼šä¿®å¤æ¶ˆæ¯å‘é€å¤„ç†é€»è¾‘

**é—®é¢˜å®šä½**ï¼š
åç«¯APIè¿”å›æ ¼å¼ï¼š
```json
{
  "code": 200,
  "message": "æ¶ˆæ¯å‘é€æˆåŠŸ", 
  "data": null,
  "success": true
}
```

å‰ç«¯ä»£ç å°è¯•è®¿é—®`data.messageId`ï¼Œä½†`data`ä¸º`null`å¯¼è‡´é”™è¯¯ã€‚

**ä¿®å¤æ–¹æ¡ˆAï¼šä¿®æ”¹åç«¯è¿”å›æ ¼å¼**
ä¿®æ”¹åç«¯æ¶ˆæ¯å‘é€APIï¼Œè¿”å›å®Œæ•´çš„æ¶ˆæ¯ä¿¡æ¯ï¼š

```java
// åœ¨ UserChatController.sendMessage æ–¹æ³•ä¸­
@PostMapping("/messages/send")
public Result<MessageDTO> sendMessage(@RequestBody SendMessageRequest request) {
    try {
        MessageDTO message = chatService.sendMessage(request);
        return Result.success("æ¶ˆæ¯å‘é€æˆåŠŸ", message);  // è¿”å›æ¶ˆæ¯å¯¹è±¡è€Œä¸æ˜¯null
    } catch (Exception e) {
        return Result.error("æ¶ˆæ¯å‘é€å¤±è´¥: " + e.getMessage());
    }
}
```

**ä¿®å¤æ–¹æ¡ˆBï¼šä¿®æ”¹å‰ç«¯å¤„ç†é€»è¾‘**
åœ¨å‰ç«¯`ChatPage.jsx`ä¸­æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼š

```javascript
// åœ¨ handleSendMessage æ–¹æ³•ä¸­
const handleSendMessage = async () => {
    try {
        const response = await sendMessage({
            senderId: currentUserId,
            receiverId: selectedFriend.userId,
            messageType: 'text',
            content: messageContent,
            replyToMessageId: replyToMessage?.messageId || null
        });
        
        if (response.success) {
            // âœ… æ·»åŠ ç©ºå€¼æ£€æŸ¥
            const messageId = response.data?.messageId || Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶ID
            
            // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
            const newMessage = {
                messageId: messageId,
                senderId: currentUserId,
                receiverId: selectedFriend.userId,
                content: messageContent,
                messageType: 'text',
                timestamp: new Date().toISOString(),
                status: 'sent'
            };
            
            // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
            setMessages(prev => [...prev, newMessage]);
            setMessageContent('');
            setReplyToMessage(null);
        }
    } catch (error) {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    }
};
```

## ğŸ”§ æ¨èä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®å¤WebSocketè¿æ¥ï¼ˆç«‹å³æ‰§è¡Œï¼‰

1. **åœ¨å‰ç«¯é¡¹ç›®ä¸­æœç´¢WebSocketç›¸å…³ä»£ç **ï¼š
   ```bash
   # åœ¨å‰ç«¯é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
   grep -r "ws://localhost:8080" src/
   grep -r "WebSocket" src/
   ```

2. **ä¿®æ”¹æ‰€æœ‰8080ç«¯å£ä¸º8082**

3. **é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨**

### ç¬¬äºŒæ­¥ï¼šä¿®å¤æ¶ˆæ¯å‘é€é€»è¾‘

**é€‰æ‹©æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šä¿®æ”¹åç«¯è¿”å›å®Œæ•´æ¶ˆæ¯ä¿¡æ¯
- ä¼˜ç‚¹ï¼šå‰ç«¯å¯ä»¥è·å¾—å®Œæ•´çš„æ¶ˆæ¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨ç”Ÿæˆçš„IDå’Œæ—¶é—´æˆ³
- ç¼ºç‚¹ï¼šéœ€è¦ä¿®æ”¹åç«¯ä»£ç 

**é€‰æ‹©æ–¹æ¡ˆB**ï¼šå‰ç«¯æ·»åŠ å®¹é”™å¤„ç†
- ä¼˜ç‚¹ï¼šä¸éœ€è¦ä¿®æ”¹åç«¯
- ç¼ºç‚¹ï¼šå‰ç«¯éœ€è¦ç”Ÿæˆä¸´æ—¶IDï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä¿®å¤ç»“æœ

1. **WebSocketè¿æ¥æµ‹è¯•**ï¼š
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹Networkæ ‡ç­¾é¡µçš„WSè¿æ¥
   - åº”è¯¥çœ‹åˆ°æˆåŠŸçš„WebSocketè¿æ¥

2. **æ¶ˆæ¯å‘é€æµ‹è¯•**ï¼š
   - å‘é€æµ‹è¯•æ¶ˆæ¯
   - æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯
   - éªŒè¯æ¶ˆæ¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

## ğŸš€ å¿«é€ŸéªŒè¯å‘½ä»¤

**æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€**ï¼š
```bash
curl http://localhost:8082/api/user-chat/messages/send -X POST \
  -H "Content-Type: application/json" \
  -d '{"senderId":1,"receiverId":3,"messageType":"text","content":"æµ‹è¯•æ¶ˆæ¯"}'
```

**æ£€æŸ¥WebSocketè¿æ¥**ï¼š
ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°ï¼š
```javascript
const ws = new WebSocket('ws://localhost:8082/ws/chat/native?userId=1');
ws.onopen = () => console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
ws.onerror = (e) => console.error('âŒ WebSocketè¿æ¥å¤±è´¥', e);
```

## ğŸ“ ä¿®å¤åçš„é¢„æœŸç»“æœ

1. **WebSocketè¿æ¥æˆåŠŸ**ï¼š
   ```
   ğŸ”Œ è¿æ¥WebSocket: ws://localhost:8082/ws/chat/native?userId=1
   âœ… WebSocketè¿æ¥æˆåŠŸ
   ```

2. **æ¶ˆæ¯å‘é€æˆåŠŸ**ï¼š
   ```
   ğŸ“¨ æ¶ˆæ¯å‘é€æˆåŠŸ
   âœ… æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©åˆ—è¡¨
   ```

3. **å®æ—¶æ¶ˆæ¯æ¨é€**ï¼š
   - å‘é€æ–¹ç«‹å³çœ‹åˆ°æ¶ˆæ¯
   - æ¥æ”¶æ–¹é€šè¿‡WebSocketå®æ—¶æ”¶åˆ°æ¶ˆæ¯

---

**æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä¿®å¤åï¼ŒèŠå¤©åŠŸèƒ½åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œï¼** ğŸ‰
