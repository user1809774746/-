# 获取群成员头像接口文档

> **版本**：v1.0  
> **更新时间**：2025-12-10  
> **基础URL**：`http://localhost:8082/api/group`

---

## 接口概述

### 功能说明
根据群聊ID获取该群所有成员的头像信息，包括用户ID、用户名、昵称、头像（Base64编码）、群内昵称和角色。

### 使用场景
- 群聊界面显示成员头像列表
- 群成员选择器（@成员功能）
- 群成员管理界面
- 群组名片显示

---

## 接口详情

### 基本信息

- **接口地址**：`GET /api/group/{groupId}/member-avatars`
- **权限要求**：需要登录，且必须是该群成员
- **请求方式**：GET
- **返回格式**：JSON

### 请求参数

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| groupId | Long | ✅ | 群聊ID |

#### 查询参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | ✅ | 请求用户的ID（用于验证权限） |

---

## 请求示例

### cURL

```bash
curl -X GET "http://localhost:8082/api/group/1/member-avatars?userId=1" \
  -H "Authorization: Bearer <your_token>" \
  -H "Content-Type: application/json"
```

### JavaScript (Axios)

```javascript
const getGroupMemberAvatars = async (groupId, userId) => {
  try {
    const response = await axios.get(
      `/api/group/${groupId}/member-avatars`,
      {
        params: { userId },
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      }
    );
    
    if (response.data.code === 200) {
      console.log('群成员头像:', response.data.data);
      return response.data.data;
    }
  } catch (error) {
    console.error('获取失败:', error);
  }
};

// 使用
const avatars = await getGroupMemberAvatars(1, 1);
```

### Java (Spring RestTemplate)

```java
String url = "http://localhost:8082/api/group/{groupId}/member-avatars?userId={userId}";
Map<String, Object> params = new HashMap<>();
params.put("groupId", 1L);
params.put("userId", 1L);

ResponseEntity<Result> response = restTemplate.getForEntity(url, Result.class, params);
List<GroupMemberAvatarDTO> avatars = (List<GroupMemberAvatarDTO>) response.getBody().getData();
```

---

## 响应格式

### 成功响应

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "userId": 1,
      "username": "zhang_san",
      "nickname": "zhang_san",
      "avatar": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD...",
      "groupNickname": "群主-张三",
      "memberRole": "owner"
    },
    {
      "userId": 2,
      "username": "li_si",
      "nickname": "li_si",
      "avatar": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD...",
      "groupNickname": "管理员-李四",
      "memberRole": "admin"
    },
    {
      "userId": 3,
      "username": "wang_wu",
      "nickname": "wang_wu",
      "avatar": null,
      "groupNickname": null,
      "memberRole": "member"
    }
  ]
}
```

### 错误响应

#### 1. 非群成员访问

```json
{
  "code": 500,
  "message": "您不是该群成员",
  "data": null
}
```

#### 2. 群不存在

```json
{
  "code": 500,
  "message": "获取群成员头像失败: ...",
  "data": null
}
```

---

## 响应字段说明

### GroupMemberAvatarDTO

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| userId | Long | 用户ID | 1 |
| username | String | 用户名 | "zhang_san" |
| nickname | String | 用户昵称（当前使用username） | "zhang_san" |
| avatar | String | 用户头像（Base64编码的图片） | "data:image/jpeg;base64,..." |
| groupNickname | String | 群内昵称（如果设置） | "群主-张三" |
| memberRole | String | 成员角色 | "owner"/"admin"/"member" |

### 成员角色说明

| 角色值 | 说明 | 权限 |
|--------|------|------|
| owner | 群主 | 所有管理权限 |
| admin | 管理员 | 部分管理权限 |
| member | 普通成员 | 基本权限 |

### 头像字段说明

- **格式**：Base64编码的Data URL
- **前缀**：`data:image/jpeg;base64,`
- **内容**：JPEG图片的Base64字符串
- **为null情况**：用户未设置头像

---

## 前端使用示例

### React 示例

#### 1. 获取并显示群成员头像

```jsx
import React, { useState, useEffect } from 'react';
import axios from 'axios';

function GroupMemberAvatars({ groupId, currentUserId }) {
  const [members, setMembers] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchMemberAvatars();
  }, [groupId]);

  const fetchMemberAvatars = async () => {
    try {
      setLoading(true);
      const response = await axios.get(
        `/api/group/${groupId}/member-avatars`,
        { params: { userId: currentUserId } }
      );
      
      if (response.data.code === 200) {
        setMembers(response.data.data);
      }
    } catch (error) {
      console.error('获取群成员头像失败:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div>加载中...</div>;

  return (
    <div className="member-avatars">
      <h3>群成员 ({members.length})</h3>
      <div className="avatar-grid">
        {members.map(member => (
          <div key={member.userId} className="member-item">
            <img 
              src={member.avatar || '/default-avatar.png'} 
              alt={member.nickname}
              className="avatar"
            />
            <div className="member-info">
              <span className="name">
                {member.groupNickname || member.nickname}
              </span>
              {member.memberRole === 'owner' && (
                <span className="badge">群主</span>
              )}
              {member.memberRole === 'admin' && (
                <span className="badge">管理员</span>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

export default GroupMemberAvatars;
```

#### 2. 成员选择器（@功能）

```jsx
import React, { useState, useEffect } from 'react';

function MentionMemberSelector({ groupId, currentUserId, onSelect }) {
  const [members, setMembers] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    fetchMembers();
  }, [groupId]);

  const fetchMembers = async () => {
    const response = await axios.get(
      `/api/group/${groupId}/member-avatars`,
      { params: { userId: currentUserId } }
    );
    if (response.data.code === 200) {
      setMembers(response.data.data);
    }
  };

  const filteredMembers = members.filter(m => 
    (m.groupNickname || m.nickname || '').toLowerCase()
      .includes(searchTerm.toLowerCase())
  );

  return (
    <div className="mention-selector">
      <input 
        type="text"
        placeholder="搜索成员..."
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
      />
      <div className="member-list">
        {filteredMembers.map(member => (
          <div 
            key={member.userId}
            className="member-option"
            onClick={() => onSelect(member)}
          >
            <img src={member.avatar || '/default-avatar.png'} />
            <span>{member.groupNickname || member.nickname}</span>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Vue 3 示例

```vue
<template>
  <div class="group-members">
    <h3>群成员 ({{ members.length }})</h3>
    
    <div v-if="loading">加载中...</div>
    
    <div v-else class="avatar-list">
      <div 
        v-for="member in members" 
        :key="member.userId"
        class="member-card"
      >
        <el-avatar 
          :size="60" 
          :src="member.avatar || '/default-avatar.png'"
        />
        <div class="member-info">
          <span class="name">
            {{ member.groupNickname || member.nickname }}
          </span>
          <el-tag v-if="member.memberRole === 'owner'" type="danger" size="small">
            群主
          </el-tag>
          <el-tag v-if="member.memberRole === 'admin'" type="warning" size="small">
            管理员
          </el-tag>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import axios from 'axios';

const props = defineProps({
  groupId: Number,
  currentUserId: Number
});

const members = ref([]);
const loading = ref(true);

const fetchMemberAvatars = async () => {
  try {
    loading.value = true;
    const response = await axios.get(
      `/api/group/${props.groupId}/member-avatars`,
      { params: { userId: props.currentUserId } }
    );
    
    if (response.data.code === 200) {
      members.value = response.data.data;
    }
  } catch (error) {
    console.error('获取失败:', error);
  } finally {
    loading.value = false;
  }
};

onMounted(() => {
  fetchMemberAvatars();
});
</script>

<style scoped>
.avatar-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 16px;
}

.member-card {
  text-align: center;
}
</style>
```

---

## 优化建议

### 1. 前端缓存

```javascript
// 使用 localStorage 缓存成员头像
const CACHE_KEY = 'group_member_avatars_';
const CACHE_DURATION = 5 * 60 * 1000; // 5分钟

const getCachedAvatars = (groupId) => {
  const cached = localStorage.getItem(CACHE_KEY + groupId);
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < CACHE_DURATION) {
      return data;
    }
  }
  return null;
};

const setCacheAvatars = (groupId, data) => {
  localStorage.setItem(CACHE_KEY + groupId, JSON.stringify({
    data,
    timestamp: Date.now()
  }));
};

// 使用
const fetchMemberAvatars = async (groupId, userId) => {
  // 先尝试从缓存获取
  const cached = getCachedAvatars(groupId);
  if (cached) {
    return cached;
  }
  
  // 缓存未命中，从服务器获取
  const response = await axios.get(
    `/api/group/${groupId}/member-avatars`,
    { params: { userId } }
  );
  
  if (response.data.code === 200) {
    setCacheAvatars(groupId, response.data.data);
    return response.data.data;
  }
};
```

### 2. 懒加载头像

```javascript
// 只在需要时加载头像
const LazyAvatar = ({ src, alt }) => {
  const [loaded, setLoaded] = useState(false);
  const imgRef = useRef(null);

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !loaded) {
          setLoaded(true);
        }
      },
      { threshold: 0.1 }
    );

    if (imgRef.current) {
      observer.observe(imgRef.current);
    }

    return () => observer.disconnect();
  }, []);

  return (
    <img 
      ref={imgRef}
      src={loaded ? src : '/placeholder.png'}
      alt={alt}
      loading="lazy"
    />
  );
};
```

### 3. 批量显示优化

```javascript
// 分批次渲染大量成员
const MemberList = ({ members }) => {
  const [displayCount, setDisplayCount] = useState(20);
  
  const loadMore = () => {
    setDisplayCount(prev => prev + 20);
  };
  
  return (
    <div>
      {members.slice(0, displayCount).map(member => (
        <MemberAvatar key={member.userId} member={member} />
      ))}
      
      {displayCount < members.length && (
        <button onClick={loadMore}>
          加载更多 ({members.length - displayCount} 人)
        </button>
      )}
    </div>
  );
};
```

---

## 性能说明

### 数据量级
- 单个成员数据大小：约 10-50 KB（取决于头像大小）
- 推荐群成员数：≤ 200人
- 超过200人的群建议分页加载

### 响应时间
- 小群（< 50人）：< 500ms
- 中群（50-200人）：500ms - 2s
- 大群（> 200人）：建议使用分页接口

### Base64头像说明
- **优点**：无需额外请求，一次性获取所有数据
- **缺点**：响应体较大，不适合大量成员的群
- **建议**：成员数超过50人时，考虑使用URL方式返回头像

---

## 注意事项

### 1. 权限验证
- 必须是群成员才能获取成员头像
- 非群成员会收到 "您不是该群成员" 错误

### 2. 头像处理
- 头像以Base64格式返回，可直接用于`<img src="...">`
- 未设置头像的用户，`avatar`字段为`null`
- 前端需要提供默认头像处理

### 3. 群内昵称
- `groupNickname`可能为`null`（未设置）
- 显示时优先使用`groupNickname`，其次使用`nickname`

### 4. 数据实时性
- 数据不是实时的，建议前端定期刷新（如5分钟）
- 成员变动时需要重新请求接口

---

## 错误码说明

| 错误码 | 说明 | 解决方法 |
|--------|------|---------|
| 200 | 成功 | - |
| 401 | 未登录 | 重新登录获取token |
| 403 | 无权限 | 确认是否为群成员 |
| 404 | 群不存在 | 检查groupId是否正确 |
| 500 | 服务器错误 | 查看后端日志 |

---

## 后端日志

### 正常日志

```
2025-12-10 17:00:00  INFO  获取群成员头像: groupId=1, requestUserId=1
2025-12-10 17:00:00  INFO  找到 4 个活跃成员
2025-12-10 17:00:00  DEBUG 添加成员头像: userId=1, hasAvatar=true
2025-12-10 17:00:00  DEBUG 添加成员头像: userId=2, hasAvatar=true
2025-12-10 17:00:00  DEBUG 添加成员头像: userId=3, hasAvatar=false
2025-12-10 17:00:00  DEBUG 添加成员头像: userId=4, hasAvatar=true
2025-12-10 17:00:00  INFO  成功获取 4 个成员头像
```

### 异常日志

```
2025-12-10 17:00:00  WARN  用户不是群成员: userId=999, groupId=1
2025-12-10 17:00:00  ERROR 获取群成员头像失败: groupId=1
```

---

## 测试用例

### Postman 测试

#### 测试1：正常获取

```
GET http://localhost:8082/api/group/1/member-avatars?userId=1
Authorization: Bearer <token>
```

**预期响应**：返回成员列表，code=200

#### 测试2：非群成员访问

```
GET http://localhost:8082/api/group/1/member-avatars?userId=999
```

**预期响应**：`{"code": 500, "message": "您不是该群成员"}`

#### 测试3：群不存在

```
GET http://localhost:8082/api/group/99999/member-avatars?userId=1
```

**预期响应**：返回错误信息

---

## 常见问题

### Q1: 头像数据太大怎么办？

**A**: 有以下解决方案：
1. 后端压缩图片质量
2. 使用缩略图
3. 改为URL方式返回，头像单独请求
4. 实现分页接口

### Q2: 如何显示默认头像？

```javascript
// 方案1：使用 || 运算符
<img src={member.avatar || '/default-avatar.png'} />

// 方案2：onError事件
<img 
  src={member.avatar} 
  onError={(e) => e.target.src = '/default-avatar.png'}
/>

// 方案3：组件封装
const Avatar = ({ src }) => {
  return <img src={src || getDefaultAvatar()} />;
};
```

### Q3: 如何按角色排序显示？

```javascript
const sortedMembers = members.sort((a, b) => {
  const roleOrder = { owner: 1, admin: 2, member: 3 };
  return roleOrder[a.memberRole] - roleOrder[b.memberRole];
});
```

### Q4: 如何实现成员搜索？

```javascript
const searchMembers = (members, keyword) => {
  return members.filter(m => {
    const displayName = m.groupNickname || m.nickname || '';
    return displayName.toLowerCase().includes(keyword.toLowerCase());
  });
};
```

---

## 相关接口

- **获取群成员列表（完整信息）**：`GET /api/group/{groupId}/members`
- **获取群聊信息**：`GET /api/group/{groupId}/info`
- **获取我的群列表**：`GET /api/group/my-groups`

---

## 更新日志

### v1.0 (2025-12-10)

**新增功能**：
- ✅ 实现获取群成员头像接口
- ✅ 支持Base64格式返回头像
- ✅ 包含成员角色和群内昵称
- ✅ 权限验证（仅群成员可访问）

---

**文档创建时间**：2025-12-10  
**编译状态**：✅ BUILD SUCCESS  
**接口状态**：✅ 可用  
**测试状态**：⏳ 待测试
