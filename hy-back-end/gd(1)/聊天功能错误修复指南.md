# 聊天功能错误修复指南

## 🚨 当前错误分析

### 错误1：WebSocket连接失败
```
WebSocket connection to 'ws://localhost:8082/ws/chat/native?userId=test' failed
```

**问题原因**：
- 前端传递了`userId=test`（字符串）
- 后端期望数字格式的用户ID
- 导致`NumberFormatException`

**解决方案**：
修改前端WebSocket连接，使用正确的数字用户ID：
```javascript
// ❌ 错误：
ws://localhost:8082/ws/chat/native?userId=test

// ✅ 正确：
ws://localhost:8082/ws/chat/native?userId=1
```

### 错误2：HTTP 500内部服务器错误
```
POST /api/user-chat/messages/send 500 (Internal Server Error)
```

**可能原因**：
1. 数据库中不存在用户ID 1或3
2. 数据库连接问题
3. 消息表结构问题

## 🔧 修复步骤

### 第一步：检查数据库数据

运行诊断SQL脚本：
```bash
mysql -u root -p123456 gd_mcp < debug_chat_issues.sql
```

或者在数据库客户端中执行：
```sql
-- 检查用户是否存在
SELECT user_id, username, number FROM user_info WHERE user_id IN (1, 3);

-- 检查消息表是否存在
SHOW TABLES LIKE 'messages';
DESCRIBE messages;
```

### 第二步：修复前端WebSocket配置

在前端聊天页面中找到WebSocket连接代码，修改：

```javascript
// 找到类似这样的代码：
const ws = new WebSocket(`ws://localhost:8082/ws/chat/native?userId=test`);

// 修改为：
const ws = new WebSocket(`ws://localhost:8082/ws/chat/native?userId=${actualUserId}`);
```

确保`actualUserId`是从用户认证信息中获取的真实数字ID。

### 第三步：创建测试用户（如果不存在）

如果数据库中没有用户ID 1和3，创建测试用户：

```sql
-- 插入测试用户
INSERT INTO user_info (user_id, username, number, password, created_at) VALUES 
(1, 'testuser1', '13800138001', '$2a$10$encrypted_password', NOW()),
(3, 'testuser3', '13800138003', '$2a$10$encrypted_password', NOW())
ON DUPLICATE KEY UPDATE username=VALUES(username);

-- 创建好友关系
INSERT INTO friendship (user_id, friend_id, status, created_at) VALUES 
(1, 3, 'accepted', NOW()),
(3, 1, 'accepted', NOW())
ON DUPLICATE KEY UPDATE status='accepted';
```

### 第四步：验证消息表结构

确保messages表存在且结构正确：

```sql
CREATE TABLE IF NOT EXISTS messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    conversation_id BIGINT NOT NULL,
    sender_id BIGINT NOT NULL,
    message_type ENUM('TEXT', 'IMAGE', 'VOICE', 'VIDEO', 'FILE', 'SYSTEM') NOT NULL,
    content TEXT,
    file_url VARCHAR(500),
    file_name VARCHAR(255),
    file_size BIGINT,
    reply_to_message_id BIGINT,
    status ENUM('SENT', 'DELIVERED', 'READ', 'RECALLED') DEFAULT 'SENT',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    recalled_at TIMESTAMP NULL,
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_sender_id (sender_id),
    INDEX idx_created_at (created_at)
);
```

## 🧪 测试步骤

### 1. 测试WebSocket连接

在浏览器控制台运行：
```javascript
const ws = new WebSocket('ws://localhost:8082/ws/chat/native?userId=1');
ws.onopen = () => console.log('✅ WebSocket连接成功');
ws.onerror = (e) => console.error('❌ WebSocket连接失败:', e);
ws.onmessage = (e) => console.log('📨 收到消息:', e.data);
```

### 2. 测试消息发送API

使用curl测试：
```bash
curl -X POST http://localhost:8082/api/user-chat/messages/send \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 3,
    "messageType": "text",
    "content": "测试消息"
  }'
```

### 3. 检查后端日志

观察后端控制台输出，查看详细错误信息：
- 用户验证是否通过
- 数据库操作是否成功
- WebSocket连接日志

## 🎯 预期结果

修复后应该看到：

1. **WebSocket连接成功**：
   ```
   ✅ WebSocket连接成功
   ```

2. **消息发送成功**：
   ```json
   {
     "code": 200,
     "message": "消息发送成功",
     "data": {
       "messageId": 1,
       "senderId": 1,
       "receiverId": 3,
       "content": "测试消息",
       "messageType": "text",
       "sentTime": "2025-11-18 15:58:00"
     }
   }
   ```

3. **前端正常显示**：
   - 消息立即显示在聊天界面
   - 不再出现JavaScript错误
   - WebSocket状态显示为已连接

## 📞 如果问题仍然存在

1. **检查数据库连接**：确保MySQL服务正在运行
2. **检查用户权限**：确保数据库用户有足够权限
3. **查看完整错误日志**：在后端控制台查看详细堆栈跟踪
4. **重启服务**：重启后端服务以应用所有更改

---

**按照以上步骤修复后，聊天功能应该完全正常！** 🎉
