# ç¾¤èŠæ¶ˆæ¯åŠŸèƒ½å¿«é€Ÿä½¿ç”¨æŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¡¨ âœ…
- **æ–‡ä»¶**ï¼š`group_messages_table.sql`
- **è¡¨å**ï¼š`group_messages`
- **åŠŸèƒ½**ï¼šå­˜å‚¨ç¾¤èŠæ¶ˆæ¯ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ç­‰å¤šç§ç±»å‹

### 2. åç«¯å®ç° âœ…
- **å®ä½“ç±»**ï¼š`GroupMessage.java`
- **Repository**ï¼š`GroupMessageRepository.java`
- **Service**ï¼š`GroupChatServiceImpl.java`ï¼ˆå·²æ›´æ–°ï¼‰
- **æ¥å£**ï¼š
  - âœ… è·å–ç¾¤èŠæ¶ˆæ¯è®°å½•
  - âœ… æœç´¢ç¾¤èŠæ¶ˆæ¯
  - âœ… å‘é€ç¾¤æ¶ˆæ¯ï¼ˆå·²æ›´æ–°ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼‰

### 3. æ–‡æ¡£ âœ…
- **å®Œæ•´æ–‡æ¡£**ï¼š`ç¾¤èŠæ¶ˆæ¯è®°å½•æ¥å£æ–‡æ¡£.md`
- **åŒ…å«å†…å®¹**ï¼š
  - API æ¥å£è¯¦ç»†è¯´æ˜
  - è¯·æ±‚/å“åº”ç¤ºä¾‹
  - å‰ç«¯é›†æˆä»£ç ï¼ˆReact + Vueï¼‰
  - å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸš€ ç«‹å³ä½¿ç”¨ï¼ˆ3æ­¥éª¤ï¼‰

### æ­¥éª¤1ï¼šæ‰§è¡Œæ•°æ®åº“è„šæœ¬

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd E:\BE-HaoY\hy-back-end\hy-back-end\gd(1)

# æ‰§è¡ŒSQLè„šæœ¬ï¼ˆè¾“å…¥MySQLå¯†ç ï¼‰
mysql -u root -p gd_mcp < group_messages_table.sql
```

**é¢„æœŸç»“æœ**ï¼š
```
Query OK, 0 rows affected
Table 'group_messages' created successfully
```

### æ­¥éª¤2ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# å¦‚æœæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢ï¼ˆCtrl+Cï¼‰

# å¯åŠ¨æœåŠ¡
mvn spring-boot:run
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
Started Application in X.XXX seconds
```

### æ­¥éª¤3ï¼šæµ‹è¯•æ¥å£

#### ä½¿ç”¨æµè§ˆå™¨æˆ– Postman æµ‹è¯•

```
GET http://localhost:8082/api/group/1/messages?userId=1&page=1&size=20
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": []  // å¯èƒ½æ˜¯ç©ºæ•°ç»„ï¼ˆè¿˜æ²¡æœ‰æ¶ˆæ¯ï¼‰
}
```

---

## ğŸ“‹ æ¥å£åˆ—è¡¨

### 1. è·å–ç¾¤èŠæ¶ˆæ¯è®°å½•

```
GET /api/group/{groupId}/messages?userId={userId}&page={page}&size={size}
```

**å‚æ•°**ï¼š
- `groupId`ï¼šç¾¤IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
- `userId`ï¼šå½“å‰ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
- `page`ï¼šé¡µç ï¼Œé»˜è®¤1
- `size`ï¼šæ¯é¡µå¤§å°ï¼Œé»˜è®¤20

**ç¤ºä¾‹**ï¼š
```bash
curl -X GET "http://localhost:8082/api/group/1/messages?userId=1&page=1&size=20" \
  -H "Authorization: Bearer <token>"
```

### 2. æœç´¢ç¾¤èŠæ¶ˆæ¯

```
GET /api/group/{groupId}/messages/search?userId={userId}&keyword={keyword}&page={page}&size={size}
```

**å‚æ•°**ï¼š
- `groupId`ï¼šç¾¤IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
- `userId`ï¼šå½“å‰ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
- `keyword`ï¼šæœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼‰
- `page`ï¼šé¡µç ï¼Œé»˜è®¤1
- `size`ï¼šæ¯é¡µå¤§å°ï¼Œé»˜è®¤20

**ç¤ºä¾‹**ï¼š
```bash
curl -X GET "http://localhost:8082/api/group/1/messages/search?userId=1&keyword=æŠ€æœ¯&page=1&size=20" \
  -H "Authorization: Bearer <token>"
```

### 3. å‘é€ç¾¤æ¶ˆæ¯

```
POST /api/group/{groupId}/send-message
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "senderId": 1,
  "messageType": "text",
  "content": "å¤§å®¶å¥½ï¼"
}
```

**ç¤ºä¾‹**ï¼š
```bash
curl -X POST "http://localhost:8082/api/group/1/send-message" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "senderId": 1,
    "messageType": "text",
    "content": "å¤§å®¶å¥½ï¼"
  }'
```

---

## ğŸ’» å‰ç«¯é›†æˆ

### React å¿«é€Ÿç¤ºä¾‹

```javascript
import axios from 'axios';

// è·å–æ¶ˆæ¯åˆ—è¡¨
const getMessages = async (groupId, userId, page = 1) => {
  const response = await axios.get(`/api/group/${groupId}/messages`, {
    params: { userId, page, size: 20 }
  });
  return response.data.data;
};

// æœç´¢æ¶ˆæ¯
const searchMessages = async (groupId, userId, keyword) => {
  const response = await axios.get(`/api/group/${groupId}/messages/search`, {
    params: { userId, keyword, page: 1, size: 20 }
  });
  return response.data.data;
};

// ä½¿ç”¨
const messages = await getMessages(1, 1, 1);
console.log('æ¶ˆæ¯åˆ—è¡¨:', messages);

const results = await searchMessages(1, 1, 'æŠ€æœ¯');
console.log('æœç´¢ç»“æœ:', results);
```

### Vue 3 å¿«é€Ÿç¤ºä¾‹

```javascript
import { ref } from 'vue';
import axios from 'axios';

export function useGroupMessages(groupId, userId) {
  const messages = ref([]);
  const loading = ref(false);

  const fetchMessages = async (page = 1) => {
    loading.value = true;
    try {
      const response = await axios.get(`/api/group/${groupId}/messages`, {
        params: { userId, page, size: 20 }
      });
      messages.value = response.data.data;
    } catch (error) {
      console.error('è·å–æ¶ˆæ¯å¤±è´¥:', error);
    } finally {
      loading.value = false;
    }
  };

  const searchMessages = async (keyword) => {
    loading.value = true;
    try {
      const response = await axios.get(`/api/group/${groupId}/messages/search`, {
        params: { userId, keyword, page: 1, size: 20 }
      });
      messages.value = response.data.data;
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error);
    } finally {
      loading.value = false;
    }
  };

  return {
    messages,
    loading,
    fetchMessages,
    searchMessages
  };
}
```

---

## ğŸ” éªŒè¯åŠŸèƒ½

### 1. éªŒè¯æ•°æ®åº“è¡¨

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
DESC group_messages;

-- æ£€æŸ¥ç´¢å¼•
SHOW INDEX FROM group_messages;
```

### 2. éªŒè¯æ¥å£å¯ç”¨æ€§

```bash
# æ£€æŸ¥åç«¯æ—¥å¿—
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š
# Mapped "{[/api/group/{groupId}/messages],methods=[GET]}"
```

### 3. å‘é€æµ‹è¯•æ¶ˆæ¯

```bash
# 1. å…ˆå‘é€ä¸€æ¡æ¶ˆæ¯
curl -X POST "http://localhost:8082/api/group/1/send-message" \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "messageType": "text",
    "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"
  }'

# 2. ç„¶åè·å–æ¶ˆæ¯åˆ—è¡¨
curl "http://localhost:8082/api/group/1/messages?userId=1&page=1&size=20"

# åº”è¯¥èƒ½çœ‹åˆ°åˆšæ‰å‘é€çš„æ¶ˆæ¯
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### group_messages è¡¨

```sql
CREATE TABLE `group_messages` (
  `message_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯ID',
  `group_id` BIGINT NOT NULL COMMENT 'ç¾¤èŠID',
  `sender_id` BIGINT NOT NULL COMMENT 'å‘é€è€…ç”¨æˆ·ID',
  `message_type` ENUM('text', 'image', 'voice', 'video', 'file', 'location', 'link', 'system') 
    DEFAULT 'text' COMMENT 'æ¶ˆæ¯ç±»å‹',
  `content` TEXT COMMENT 'æ¶ˆæ¯å†…å®¹',
  `media_url` VARCHAR(500) DEFAULT NULL COMMENT 'åª’ä½“æ–‡ä»¶URL',
  `file_name` VARCHAR(255) DEFAULT NULL COMMENT 'æ–‡ä»¶å',
  `media_size` BIGINT DEFAULT NULL COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  `sent_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘é€æ—¶é—´',
  `is_recalled` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å·²æ’¤å›',
  
  PRIMARY KEY (`message_id`),
  KEY `idx_group_id` (`group_id`),
  KEY `idx_group_time` (`group_id`, `sent_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¾¤èŠæ¶ˆæ¯è¡¨';
```

---

## ğŸ¯ ä¸»è¦ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **æ¶ˆæ¯å­˜å‚¨**
   - ä¿å­˜åˆ°ä¸“é—¨çš„ `group_messages` è¡¨
   - æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
   - æ”¯æŒæ¶ˆæ¯æ’¤å›

2. **æ¶ˆæ¯æŸ¥è¯¢**
   - åˆ†é¡µæŸ¥è¯¢å†å²æ¶ˆæ¯
   - æŒ‰æ—¶é—´å€’åºæ’åˆ—
   - è‡ªåŠ¨è¿‡æ»¤å·²æ’¤å›æ¶ˆæ¯

3. **æ¶ˆæ¯æœç´¢**
   - å…³é”®è¯æœç´¢
   - ä»…æœç´¢æ–‡æœ¬æ¶ˆæ¯
   - æ”¯æŒåˆ†é¡µ

4. **æ¶ˆæ¯æ¨é€**
   - é€šè¿‡ WebSocket å®æ—¶æ¨é€
   - æ¨é€ç»™æ‰€æœ‰ç¾¤æˆå‘˜ï¼ˆé™¤å‘é€è€…ï¼‰
   - æ›´æ–°æœªè¯»è®¡æ•°

### ğŸ”„ ä¸å…¶ä»–åŠŸèƒ½çš„é›†æˆ

- âœ… **ç¾¤èŠç®¡ç†**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç¾¤æˆå‘˜
- âœ… **æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥ç¦è¨€çŠ¶æ€
- âœ… **WebSocket**ï¼šå®æ—¶æ¶ˆæ¯æ¨é€
- âœ… **æœªè¯»ç»Ÿè®¡**ï¼šè‡ªåŠ¨æ›´æ–°æœªè¯»è®¡æ•°

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: è¡¨åˆ›å»ºå¤±è´¥ï¼Ÿ

**æ£€æŸ¥**ï¼š
```sql
-- æ£€æŸ¥ group_chats è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆå¤–é”®ä¾èµ–ï¼‰
SHOW TABLES LIKE 'group_chats';

-- æ£€æŸ¥ user_info è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆå¤–é”®ä¾èµ–ï¼‰
SHOW TABLES LIKE 'user_info';
```

**è§£å†³**ï¼šå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå…ˆæ‰§è¡Œ `group_chat_tables.sql`

### Q2: æ¥å£è¿”å›"æ‚¨ä¸æ˜¯è¯¥ç¾¤æˆå‘˜"ï¼Ÿ

**åŸå› **ï¼šç”¨æˆ·ä¸åœ¨ç¾¤é‡Œ

**è§£å†³**ï¼š
```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ç¾¤é‡Œ
SELECT * FROM group_members 
WHERE group_id = 1 AND user_id = 1 AND member_status = 'active';

-- å¦‚æœä¸åœ¨ï¼Œå…ˆåŠ å…¥ç¾¤
INSERT INTO group_members (group_id, user_id, member_role, member_status)
VALUES (1, 1, 'member', 'active');
```

### Q3: æœç´¢æ²¡æœ‰ç»“æœï¼Ÿ

**åŸå› **ï¼šå¯èƒ½æ²¡æœ‰åŒ¹é…çš„æ¶ˆæ¯

**æ£€æŸ¥**ï¼š
```sql
-- æŸ¥çœ‹ç¾¤é‡Œæœ‰å“ªäº›æ¶ˆæ¯
SELECT message_id, content, sender_id, sent_time 
FROM group_messages 
WHERE group_id = 1 AND message_type = 'text' AND is_recalled = 0
ORDER BY sent_time DESC
LIMIT 10;
```

### Q4: ç¼–è¯‘å¤±è´¥ï¼Ÿ

**æ£€æŸ¥å¾ªç¯ä¾èµ–**ï¼šå·²ä½¿ç”¨ `@Lazy` æ³¨è§£è§£å†³

**é‡æ–°ç¼–è¯‘**ï¼š
```bash
mvn clean compile -DskipTests
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`ç¾¤èŠæ¶ˆæ¯è®°å½•æ¥å£æ–‡æ¡£.md`** - å®Œæ•´çš„APIæ–‡æ¡£
2. **`group_messages_table.sql`** - æ•°æ®åº“è¡¨åˆ›å»ºè„šæœ¬
3. **`ç¾¤èŠæ¥å£å®Œæ•´æ–‡æ¡£.md`** - æ‰€æœ‰ç¾¤èŠæ¥å£çš„æ±‡æ€»
4. **`WebSocketæ¶ˆæ¯æ ¼å¼è¯´æ˜.md`** - WebSocketæ¶ˆæ¯æ ¼å¼

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°

- âœ… æ•°æ®åº“è¡¨è®¾è®¡å’Œåˆ›å»º
- âœ… åç«¯å®ä½“ç±»å’ŒRepository
- âœ… è·å–æ¶ˆæ¯åˆ—è¡¨æ¥å£
- âœ… æœç´¢æ¶ˆæ¯æ¥å£
- âœ… å‘é€æ¶ˆæ¯æ¥å£ï¼ˆå·²æ›´æ–°ï¼‰
- âœ… å®Œæ•´çš„æ¥å£æ–‡æ¡£
- âœ… å‰ç«¯é›†æˆç¤ºä¾‹

### ç«‹å³å¯ç”¨

1. æ‰§è¡Œ SQL è„šæœ¬
2. é‡å¯åç«¯æœåŠ¡
3. å‰ç«¯è°ƒç”¨æ¥å£

### ä¸‹ä¸€æ­¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰

- æ¶ˆæ¯æ’¤å›åŠŸèƒ½
- æ¶ˆæ¯å¼•ç”¨å›å¤
- @æåŠåŠŸèƒ½
- æ¶ˆæ¯è¡¨æƒ…ååº”
- æ¶ˆæ¯ç½®é¡¶åŠŸèƒ½
- å¯Œæ–‡æœ¬æ¶ˆæ¯
- è¯­éŸ³/è§†é¢‘é€šè¯è®°å½•

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-12-10  
**çŠ¶æ€**ï¼šâœ… å®Œæˆå¹¶å¯ç”¨  
**ç¼–è¯‘çŠ¶æ€**ï¼šâœ… æˆåŠŸ
