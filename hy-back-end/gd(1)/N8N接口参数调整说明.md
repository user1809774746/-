# ğŸ“ N8Næ¥å£å‚æ•°è°ƒæ•´è¯´æ˜

> **ä¿®æ”¹æ—¥æœŸ**: 2025-11-02  
> **ä¿®æ”¹å†…å®¹**: è°ƒæ•´n8n webhookä¼ é€’çš„å‚æ•°  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

### ä¿®æ”¹å‰

**ä¼ é€’ç»™n8nçš„æ•°æ®**:
```json
{
  "sessionId": "abc123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸",
  "userId": "user123"  âŒ ä¸éœ€è¦ä¼ é€’
}
```

### ä¿®æ”¹å

**ä¼ é€’ç»™n8nçš„æ•°æ®**:
```json
{
  "sessionId": "abc123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
}
```

**userIdçš„å¤„ç†**:
- âœ… ä¿å­˜åˆ°æ•°æ®åº“ `chat_history` è¡¨
- âŒ ä¸ä¼ é€’ç»™n8n webhook

---

## ğŸ”§ ä»£ç ä¿®æ”¹è¯¦æƒ…

### ChatService.java

**ä¿®æ”¹ä½ç½®**: ç¬¬56-60è¡Œ

**ä¿®æ”¹å‰**:
```java
Map<String, Object> payload = Map.of(
    "message", request.getMessage(),
    "sessionId", request.getSessionId(),
    "userId", request.getUserId()  // âŒ ä¼ é€’ç»™n8n
);
```

**ä¿®æ”¹å**:
```java
Map<String, Object> payload = Map.of(
    "sessionId", request.getSessionId(),
    "message", request.getMessage()
);
System.out.println("ğŸ“¤ å‘é€ç»™n8nçš„æ•°æ®: " + payload);
```

### å®Œæ•´çš„æ•°æ®æµ

```
å‰ç«¯è¯·æ±‚
  â†“
{
  "sessionId": "abc123",
  "userId": "user123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
}
  â†“
åç«¯æ¥æ”¶ (ChatController)
  â†“
ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“ âœ…
  â””â”€ sessionId: abc123
  â””â”€ userId: user123  âœ… å­˜å…¥æ•°æ®åº“
  â””â”€ message: å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸
  â†“
è°ƒç”¨n8n webhook (åªä¼ 2ä¸ªå‚æ•°)
  â†“
{
  "sessionId": "abc123",  âœ… ä¼ é€’ç»™n8n
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"  âœ… ä¼ é€’ç»™n8n
}
  â†“
n8nå¤„ç†å¹¶è¿”å›
  â†“
{
  "text": "å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸..."
}
  â†“
ä¿å­˜AIå›å¤åˆ°æ•°æ®åº“ âœ…
  â””â”€ sessionId: abc123
  â””â”€ userId: user123  âœ… å­˜å…¥æ•°æ®åº“
  â””â”€ message: å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸...
  â†“
è¿”å›ç»™å‰ç«¯
```

---

## ğŸ“Š å‚æ•°å¯¹æ¯”è¡¨

| å‚æ•° | å‰ç«¯ä¼ é€’ | åç«¯æ¥æ”¶ | å­˜å…¥æ•°æ®åº“ | ä¼ ç»™n8n |
|------|---------|---------|-----------|---------|
| sessionId | âœ… | âœ… | âœ… | âœ… |
| userId | âœ… | âœ… | âœ… | âŒ |
| message | âœ… | âœ… | âœ… | âœ… |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

#### 1. é‡å¯åç«¯æœåŠ¡

```bash
# åœ¨IDEAä¸­é‡å¯Spring Bootåº”ç”¨
```

#### 2. å‘é€æµ‹è¯•æ¶ˆæ¯

**Postmané…ç½®**:
```
Method: POST
URL: http://localhost:8081/api/chat/send

Headers:
Content-Type: application/json

Body (raw, JSON):
{
  "sessionId": "abc123",
  "userId": "user123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
}
```

#### 3. æŸ¥çœ‹åç«¯æ—¥å¿—

**é¢„æœŸæ—¥å¿—**:
```
=== å‘é€èŠå¤©æ¶ˆæ¯ ===
SessionId: abc123
UserId: user123  âœ… æ˜¾ç¤ºæ”¶åˆ°userId
Message: å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸
n8né…ç½®: å·²å¯ç”¨
n8n URL: https://a001.app.n8n.cloud/...
âœ… ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“
â³ æ­£åœ¨è°ƒç”¨n8n webhook...
ğŸ“¤ å‘é€ç»™n8nçš„æ•°æ®: {sessionId=abc123, message=å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸}
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                     âœ… åªåŒ…å«sessionIdå’Œmessageï¼Œæ²¡æœ‰userId
âœ… n8nå“åº”æˆåŠŸ: å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸...
âœ… AIå›å¤å·²ä¿å­˜åˆ°æ•°æ®åº“
===================
```

**å…³é”®éªŒè¯ç‚¹**:
- âœ… æ—¥å¿—æ˜¾ç¤ºæ”¶åˆ°äº† `UserId: user123`
- âœ… å‘é€ç»™n8nçš„æ•°æ®åªåŒ…å« `sessionId` å’Œ `message`
- âœ… æ²¡æœ‰ `userId` ä¼ é€’ç»™n8n

#### 4. æ£€æŸ¥æ•°æ®åº“

```sql
-- æŸ¥è¯¢æœ€æ–°çš„èŠå¤©è®°å½•
SELECT * FROM chat_history ORDER BY created_at DESC LIMIT 2;

-- é¢„æœŸç»“æœï¼š
-- è®°å½•1: user_id=user123, message=å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸
-- è®°å½•2: user_id=user123, message=å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸...
```

**éªŒè¯**:
- âœ… `user_id` å­—æ®µå·²æ­£ç¡®ä¿å­˜
- âœ… ä¸¤æ¡è®°å½•ï¼ˆç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ï¼‰éƒ½åŒ…å« `user_id`

---

## ğŸ¯ ä¿®æ”¹åŸå› 

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

#### 1. **æ•°æ®éš”ç¦»**

- **æ•°æ®åº“**: éœ€è¦ `userId` æ¥è®°å½•æ˜¯å“ªä¸ªç”¨æˆ·çš„èŠå¤©è®°å½•
- **n8n**: ä¸éœ€è¦çŸ¥é“å…·ä½“çš„ç”¨æˆ·IDï¼Œåªéœ€è¦ä¼šè¯IDæ¥ä¿æŒä¸Šä¸‹æ–‡

#### 2. **éšç§ä¿æŠ¤**

- å‡å°‘ä¼ é€’ç»™ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆn8nï¼‰çš„ç”¨æˆ·ä¿¡æ¯
- `sessionId` è¶³ä»¥è¯†åˆ«å¯¹è¯ä¸Šä¸‹æ–‡

#### 3. **ç®€åŒ–n8né…ç½®**

- n8n workflowä¸éœ€è¦å¤„ç† `userId`
- åªå…³æ³¨å¯¹è¯å†…å®¹å’Œä¼šè¯ç®¡ç†

---

## ğŸ“„ APIæ–‡æ¡£æ›´æ–°

### POST /api/chat/send

#### è¯·æ±‚å‚æ•°

```json
{
  "sessionId": "string (å¿…å¡«)",
  "userId": "string (å¿…å¡«)",
  "message": "string (å¿…å¡«)"
}
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç”¨é€” |
|------|------|------|------|------|
| sessionId | String | âœ… | ä¼šè¯ID | ç”¨äºä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆä¼ ç»™n8nï¼‰ |
| userId | String | âœ… | ç”¨æˆ·ID | ç”¨äºè®°å½•èŠå¤©å½’å±ï¼ˆä»…æ•°æ®åº“ï¼‰ |
| message | String | âœ… | æ¶ˆæ¯å†…å®¹ | ç”¨æˆ·çš„èŠå¤©æ¶ˆæ¯ï¼ˆä¼ ç»™n8nï¼‰ |

#### ä¼ é€’ç»™n8nçš„æ•°æ®

```json
{
  "sessionId": "abc123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
}
```

**æ³¨æ„**: `userId` ä¸ä¼šä¼ é€’ç»™n8nï¼Œä»…ç”¨äºåç«¯æ•°æ®åº“å­˜å‚¨ã€‚

#### æˆåŠŸå“åº”

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "reply": "å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸ï¼š\nç¬¬ä¸€å¤©...",
    "sessionId": "abc123"
  }
}
```

---

## ğŸ” å‰åç«¯å¯¹æ¥è¯´æ˜

### å‰ç«¯è°ƒç”¨æ–¹å¼ï¼ˆä¸å˜ï¼‰

å‰ç«¯è°ƒç”¨æ–¹å¼**ä¿æŒä¸å˜**ï¼Œä»ç„¶ä¼ é€’ä¸‰ä¸ªå‚æ•°ï¼š

```javascript
// å‰ç«¯ä»£ç ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
const response = await fetch('/api/chat/send', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    sessionId: "abc123",
    userId: "user123",      // âœ… å‰ç«¯ä»ç„¶ä¼ é€’
    message: "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
  })
});
```

### åç«¯å¤„ç†é€»è¾‘ï¼ˆå·²è°ƒæ•´ï¼‰

```java
// åç«¯ä»£ç ï¼ˆå·²ä¿®æ”¹ï¼‰
public String sendMessage(ChatRequest request) {
    // 1. æ¥æ”¶æ‰€æœ‰å‚æ•°
    String sessionId = request.getSessionId();
    String userId = request.getUserId();
    String message = request.getMessage();
    
    // 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«userIdï¼‰
    ChatMessage userMsg = new ChatMessage();
    userMsg.setSessionId(sessionId);
    userMsg.setUserId(userId);  // âœ… å­˜å…¥æ•°æ®åº“
    userMsg.setMessage(message);
    chatRepository.save(userMsg);
    
    // 3. è°ƒç”¨n8nï¼ˆåªä¼ sessionIdå’Œmessageï¼‰
    Map<String, Object> payload = Map.of(
        "sessionId", sessionId,  // âœ… ä¼ ç»™n8n
        "message", message       // âœ… ä¼ ç»™n8n
        // userId ä¸ä¼ ç»™n8n âŒ
    );
    
    // 4. ä¿å­˜AIå›å¤ï¼ˆåŒ…å«userIdï¼‰
    ChatMessage aiMsg = new ChatMessage();
    aiMsg.setSessionId(sessionId);
    aiMsg.setUserId(userId);  // âœ… å­˜å…¥æ•°æ®åº“
    aiMsg.setMessage(reply);
    chatRepository.save(aiMsg);
    
    return reply;
}
```

---

## ğŸ“ n8n Workflowé…ç½®å»ºè®®

### n8næ¥æ”¶çš„æ•°æ®æ ¼å¼

```json
{
  "sessionId": "abc123",
  "message": "å¸®æˆ‘è§„åˆ’ä¸€ä¸‹å»äº¬éƒ½çš„ä¸‰æ—¥æ¸¸"
}
```

### n8nåº”è¯¥è¿”å›çš„æ ¼å¼

```json
{
  "text": "å¥½çš„ï¼Œä¸ºæ‚¨è§„åˆ’äº¬éƒ½ä¸‰æ—¥æ¸¸ï¼š\nç¬¬ä¸€å¤©ï¼šæŠµè¾¾äº¬éƒ½..."
}
```

### n8n WorkflowèŠ‚ç‚¹é…ç½®ç¤ºä¾‹

**WebhookèŠ‚ç‚¹**:
- HTTP Method: POST
- æ¥æ”¶å‚æ•°: `sessionId`, `message`

**å¤„ç†èŠ‚ç‚¹**:
- ä½¿ç”¨ `{{ $json.sessionId }}` è·å–ä¼šè¯ID
- ä½¿ç”¨ `{{ $json.message }}` è·å–ç”¨æˆ·æ¶ˆæ¯

**å“åº”èŠ‚ç‚¹**:
- è¿”å›æ ¼å¼: `{ "text": "AIå›å¤å†…å®¹" }`

---

## âœ… ä¿®æ”¹ç¡®è®¤æ¸…å•

### ä»£ç å±‚é¢

- [x] ä¿®æ”¹ `ChatService.java` ä¸­çš„ payload
- [x] ç§»é™¤ä¼ é€’ç»™n8nçš„ `userId` å‚æ•°
- [x] ä¿æŒæ•°æ®åº“å­˜å‚¨çš„ `userId`
- [x] æ·»åŠ æ—¥å¿—æ˜¾ç¤ºå‘é€ç»™n8nçš„æ•°æ®
- [x] ä»£ç ç¼–è¯‘é€šè¿‡

### æµ‹è¯•å±‚é¢

- [ ] é‡å¯åç«¯æœåŠ¡
- [ ] å‘é€æµ‹è¯•æ¶ˆæ¯
- [ ] éªŒè¯åç«¯æ—¥å¿—
- [ ] æ£€æŸ¥n8næ”¶åˆ°çš„æ•°æ®
- [ ] éªŒè¯æ•°æ®åº“è®°å½•

### æ–‡æ¡£å±‚é¢

- [x] åˆ›å»ºä¿®æ”¹è¯´æ˜æ–‡æ¡£
- [x] æ›´æ–°APIæ–‡æ¡£
- [x] è¯´æ˜è®¾è®¡åŸå› 

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹å˜

**ä¸€å¥è¯**: `userId` åªç”¨äºæ•°æ®åº“ï¼Œä¸ä¼ ç»™n8nã€‚

### ä¼˜ç‚¹

1. **éšç§ä¿æŠ¤** - å‡å°‘ä¼ é€’ç»™ç¬¬ä¸‰æ–¹çš„ç”¨æˆ·ä¿¡æ¯
2. **ç®€åŒ–n8n** - n8n workflowä¸éœ€è¦å¤„ç†userId
3. **æ•°æ®å®Œæ•´** - æ•°æ®åº“ä»ç„¶ä¿å­˜å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
4. **å‘åå…¼å®¹** - å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹

### ä¼ é€’æµç¨‹

```
å‰ç«¯ â†’ åç«¯:
  sessionId âœ…
  userId âœ…
  message âœ…

åç«¯ â†’ æ•°æ®åº“:
  sessionId âœ…
  userId âœ…
  message âœ…

åç«¯ â†’ n8n:
  sessionId âœ…
  message âœ…
  userId âŒ (ä¸ä¼ é€’)

n8n â†’ åç«¯:
  text âœ…

åç«¯ â†’ æ•°æ®åº“:
  sessionId âœ…
  userId âœ…
  reply âœ…
```

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**: 2025-11-02  
**ä¿®æ”¹çŠ¶æ€**: âœ… å·²å®Œæˆ  
**éœ€è¦é‡å¯**: âœ… æ˜¯  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

