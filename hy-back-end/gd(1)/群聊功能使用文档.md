# ç¾¤èŠåŠŸèƒ½ä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ•°æ®åº“è¡¨ç»“æ„](#æ•°æ®åº“è¡¨ç»“æ„)
3. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
4. [WebSocketå®æ—¶é€šä¿¡](#websocketå®æ—¶é€šä¿¡)
5. [å‰ç«¯é›†æˆç¤ºä¾‹](#å‰ç«¯é›†æˆç¤ºä¾‹)
6. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„ç”¨æˆ·ç¾¤èŠåŠŸèƒ½ï¼Œæ”¯æŒï¼š
- âœ… åˆ›å»ºç¾¤èŠï¼ˆæ™®é€šåˆ›å»º/æ‹‰å¥½å‹å»ºç¾¤ï¼‰
- âœ… ç¾¤æˆå‘˜ç®¡ç†ï¼ˆé‚€è¯·ã€è¸¢å‡ºã€è®¾ç½®ç®¡ç†å‘˜ï¼‰
- âœ… å®æ—¶ç¾¤æ¶ˆæ¯æ¨é€ï¼ˆåŸºäºWebSocketï¼‰
- âœ… ç¾¤æ¶ˆæ¯å·²è¯»/æœªè¯»ç®¡ç†
- âœ… ç¾¤èŠæƒé™æ§åˆ¶ï¼ˆç¦è¨€ã€å…¨å‘˜ç¦è¨€ã€åŠ ç¾¤å®¡æ‰¹ï¼‰
- âœ… ç¾¤å…¬å‘Šå‘å¸ƒ
- âœ… å…¥ç¾¤ç”³è¯·å®¡æ‰¹

---

## æ•°æ®åº“è¡¨ç»“æ„

### 1. group_chats - ç¾¤èŠåŸºç¡€ä¿¡æ¯è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| group_id | BIGINT | ç¾¤èŠIDï¼ˆä¸»é”®ï¼‰ |
| group_name | VARCHAR(100) | ç¾¤åç§° |
| group_avatar | VARCHAR(500) | ç¾¤å¤´åƒURL |
| group_description | TEXT | ç¾¤æè¿° |
| creator_id | BIGINT | ç¾¤åˆ›å»ºè€…IDï¼ˆç¾¤ä¸»ï¼‰ |
| max_members | INT | æœ€å¤§æˆå‘˜æ•°ï¼ˆé»˜è®¤200ï¼‰ |
| current_members | INT | å½“å‰æˆå‘˜æ•° |
| group_type | ENUM | ç¾¤ç±»å‹ï¼šnormal/announcement/private |
| join_approval | TINYINT(1) | æ˜¯å¦éœ€è¦åŠ ç¾¤å®¡æ‰¹ |
| allow_member_invite | TINYINT(1) | æ˜¯å¦å…è®¸æˆå‘˜é‚€è¯· |
| mute_all | TINYINT(1) | æ˜¯å¦å…¨å‘˜ç¦è¨€ |
| status | ENUM | ç¾¤çŠ¶æ€ï¼šactive/disbanded/frozen |
| created_time | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_time | DATETIME | æ›´æ–°æ—¶é—´ |

### 2. group_members - ç¾¤æˆå‘˜å…³ç³»è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | BIGINT | ä¸»é”®ID |
| group_id | BIGINT | ç¾¤èŠID |
| user_id | BIGINT | ç”¨æˆ·ID |
| member_role | VARCHAR(20) | è§’è‰²ï¼šowner/admin/member |
| group_nickname | VARCHAR(50) | ç¾¤å†…æ˜µç§° |
| is_muted | TINYINT(1) | æ˜¯å¦è¢«ç¦è¨€ |
| mute_until | DATETIME | ç¦è¨€åˆ°æœŸæ—¶é—´ |
| join_time | DATETIME | åŠ ç¾¤æ—¶é—´ |
| last_read_time | DATETIME | æœ€åé˜…è¯»æ—¶é—´ |
| unread_count | INT | æœªè¯»æ¶ˆæ¯æ•° |
| member_status | VARCHAR(20) | çŠ¶æ€ï¼šactive/left/kicked/banned |
| inviter_id | BIGINT | é‚€è¯·äººID |

### 3. group_join_requests - å…¥ç¾¤ç”³è¯·è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | BIGINT | ä¸»é”®ID |
| group_id | BIGINT | ç¾¤èŠID |
| applicant_id | BIGINT | ç”³è¯·äººID |
| inviter_id | BIGINT | é‚€è¯·äººID |
| request_type | VARCHAR(20) | ç±»å‹ï¼šapply/invite |
| request_message | VARCHAR(200) | ç”³è¯·/é‚€è¯·æ¶ˆæ¯ |
| request_status | VARCHAR(20) | çŠ¶æ€ï¼špending/approved/rejected/expired |
| handled_time | DATETIME | å¤„ç†æ—¶é—´ |

### 4. group_announcements - ç¾¤å…¬å‘Šè¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | BIGINT | ä¸»é”®ID |
| group_id | BIGINT | ç¾¤èŠID |
| publisher_id | BIGINT | å‘å¸ƒè€…ID |
| title | VARCHAR(100) | å…¬å‘Šæ ‡é¢˜ |
| content | TEXT | å…¬å‘Šå†…å®¹ |
| is_pinned | TINYINT(1) | æ˜¯å¦ç½®é¡¶ |
| announcement_status | VARCHAR(20) | çŠ¶æ€ï¼šactive/deleted |

---

## APIæ¥å£æ–‡æ¡£

### åŸºç¡€URL
```
http://localhost:8082/api/group
```

### 1. åˆ›å»ºç¾¤èŠ

**æ¥å£åœ°å€**ï¼š`POST /api/group/create`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "creatorId": 1,
  "groupName": "æŠ€æœ¯äº¤æµç¾¤",
  "groupDescription": "åˆ†äº«æŠ€æœ¯ç»éªŒ",
  "groupAvatar": "https://example.com/avatar.jpg",
  "maxMembers": 200,
  "groupType": "normal",
  "joinApproval": true,
  "allowInvite": true,
  "initialMembers": [2, 3, 4]
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "ç¾¤èŠåˆ›å»ºæˆåŠŸ",
  "data": {
    "groupId": 1,
    "groupName": "æŠ€æœ¯äº¤æµç¾¤",
    "groupAvatar": "https://example.com/avatar.jpg",
    "currentMembers": 4,
    "maxMembers": 200,
    "createdTime": "2025-12-10T14:30:00"
  }
}
```

---

### 2. æ‹‰å¥½å‹å»ºç¾¤

**æ¥å£åœ°å€**ï¼š`POST /api/group/create-with-friends`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "creatorId": 1,
  "groupName": "æˆ‘ä»¬çš„ç¾¤èŠ",
  "groupDescription": "æœ‹å‹ä»¬çš„èŠå¤©ç¾¤",
  "friendIds": [2, 3, 4, 5]
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "ç¾¤èŠåˆ›å»ºæˆåŠŸ",
  "data": {
    "groupId": 2,
    "groupName": "æˆ‘ä»¬çš„ç¾¤èŠ",
    "currentMembers": 5,
    "maxMembers": 200
  }
}
```

---

### 3. è·å–ç¾¤èŠä¿¡æ¯

**æ¥å£åœ°å€**ï¼š`GET /api/group/{groupId}/info`

**è¯·æ±‚å‚æ•°**ï¼š
- `userId`: ç”¨æˆ·IDï¼ˆqueryå‚æ•°ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "groupId": 1,
    "groupName": "æŠ€æœ¯äº¤æµç¾¤",
    "groupAvatar": "https://example.com/avatar.jpg",
    "groupDescription": "åˆ†äº«æŠ€æœ¯ç»éªŒ",
    "creatorId": 1,
    "currentMembers": 10,
    "maxMembers": 200,
    "groupType": "normal",
    "status": "active"
  }
}
```

---

### 4. é‚€è¯·ç”¨æˆ·å…¥ç¾¤

**æ¥å£åœ°å€**ï¼š`POST /api/group/{groupId}/invite`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "inviterId": 1,
  "userIds": [6, 7, 8],
  "inviteMessage": "æ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„ç¾¤èŠ"
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "é‚€è¯·å·²å‘é€ï¼Œå…±é‚€è¯·3äºº",
  "data": null
}
```

---

### 5. è·å–ç¾¤æˆå‘˜åˆ—è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/group/{groupId}/members`

**è¯·æ±‚å‚æ•°**ï¼š
- `userId`: ç”¨æˆ·IDï¼ˆqueryå‚æ•°ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "groupId": 1,
      "userId": 1,
      "userName": "å¼ ä¸‰",
      "avatar": "https://example.com/avatar1.jpg",
      "memberRole": "owner",
      "groupNickname": "ç¾¤ä¸»",
      "isMuted": false,
      "joinTime": "2025-12-10T10:00:00"
    },
    {
      "id": 2,
      "groupId": 1,
      "userId": 2,
      "userName": "æå››",
      "avatar": "https://example.com/avatar2.jpg",
      "memberRole": "member",
      "groupNickname": null,
      "isMuted": false,
      "joinTime": "2025-12-10T10:05:00"
    }
  ]
}
```

---

### 6. å‘é€ç¾¤æ¶ˆæ¯

**æ¥å£åœ°å€**ï¼š`POST /api/group/{groupId}/send-message`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "senderId": 1,
  "messageType": "text",
  "content": "å¤§å®¶å¥½ï¼",
  "replyToMessageId": null
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "ç¾¤æ¶ˆæ¯å‘é€æˆåŠŸ",
  "data": {
    "messageId": 12345,
    "senderId": 1,
    "groupId": 1,
    "messageType": "text",
    "content": "å¤§å®¶å¥½ï¼",
    "sentTime": "2025-12-10T14:35:00",
    "status": "sent"
  }
}
```

---

### 7. è·å–æˆ‘çš„ç¾¤èŠåˆ—è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/group/my-groups`

**è¯·æ±‚å‚æ•°**ï¼š
- `userId`: ç”¨æˆ·IDï¼ˆqueryå‚æ•°ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "groupId": 1,
      "groupName": "æŠ€æœ¯äº¤æµç¾¤",
      "groupAvatar": "https://example.com/avatar.jpg",
      "currentMembers": 10,
      "unreadCount": 5,
      "memberRole": "owner",
      "createdTime": "2025-12-10T10:00:00"
    },
    {
      "groupId": 2,
      "groupName": "æ—…æ¸¸çˆ±å¥½è€…",
      "groupAvatar": "https://example.com/avatar2.jpg",
      "currentMembers": 15,
      "unreadCount": 0,
      "memberRole": "member",
      "createdTime": "2025-12-09T15:00:00"
    }
  ]
}
```

---

### 8. æ ‡è®°ç¾¤æ¶ˆæ¯å·²è¯»

**æ¥å£åœ°å€**ï¼š`POST /api/group/{groupId}/mark-read`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "userId": 1
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "ç¾¤æ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»",
  "data": null
}
```

---

## WebSocketå®æ—¶é€šä¿¡

### è¿æ¥æ–¹å¼

#### 1. åŸç”ŸWebSocketè¿æ¥
```javascript
const ws = new WebSocket('ws://localhost:8082/api/ws/chat/native?userId=1');

ws.onopen = () => {
    console.log('WebSocketè¿æ¥æˆåŠŸ');
};

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleMessage(data);
};

ws.onerror = (error) => {
    console.error('WebSocketé”™è¯¯:', error);
};

ws.onclose = () => {
    console.log('WebSocketè¿æ¥å…³é—­');
};
```

#### 2. SockJSè¿æ¥ï¼ˆæ”¯æŒé™çº§ï¼‰
```javascript
import SockJS from 'sockjs-client';

const socket = new SockJS('http://localhost:8082/api/ws/chat');

socket.onopen = () => {
    console.log('è¿æ¥æˆåŠŸ');
};

socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleMessage(data);
};
```

---

### WebSocketæ¶ˆæ¯æ ¼å¼

#### å‘é€æ¶ˆæ¯æ ¼å¼

**1. å‘é€ç¾¤æ¶ˆæ¯**
```json
{
  "type": "send_message",
  "data": {
    "groupId": 1,
    "messageType": "text",
    "content": "å¤§å®¶å¥½ï¼"
  },
  "timestamp": 1702200000000,
  "requestId": "req_12345"
}
```

**2. å¿ƒè·³æ¶ˆæ¯**
```json
{
  "type": "heartbeat",
  "data": {},
  "timestamp": 1702200000000
}
```

**3. æ­£åœ¨è¾“å…¥**
```json
{
  "type": "typing",
  "data": {
    "targetId": 1,
    "targetType": "group",
    "isTyping": true
  }
}
```

---

#### æ¥æ”¶æ¶ˆæ¯æ ¼å¼

**1. æ–°ç¾¤æ¶ˆæ¯é€šçŸ¥**
```json
{
  "type": "new_group_message",
  "data": {
    "messageId": 12345,
    "senderId": 2,
    "senderName": "æå››",
    "senderAvatar": "https://example.com/avatar2.jpg",
    "groupId": 1,
    "messageType": "text",
    "content": "å¤§å®¶å¥½ï¼",
    "sentTime": "2025-12-10T14:35:00"
  },
  "success": true,
  "timestamp": 1702200000000
}
```

**2. ç¾¤é‚€è¯·é€šçŸ¥**
```json
{
  "type": "group_invitation",
  "data": {
    "groupId": 1,
    "groupName": "æŠ€æœ¯äº¤æµç¾¤",
    "groupAvatar": "https://example.com/avatar.jpg",
    "inviterId": 5,
    "inviterName": "ç‹äº”"
  },
  "success": true,
  "timestamp": 1702200000000
}
```

**3. æ¶ˆæ¯å‘é€æˆåŠŸå“åº”**
```json
{
  "type": "send_message_success",
  "data": {
    "messageId": 12345,
    "senderId": 1,
    "groupId": 1,
    "content": "å¤§å®¶å¥½ï¼",
    "sentTime": "2025-12-10T14:35:00",
    "status": "sent"
  },
  "success": true,
  "message": "æ¶ˆæ¯å‘é€æˆåŠŸ",
  "timestamp": 1702200000000
}
```

**4. å¿ƒè·³å“åº”**
```json
{
  "type": "heartbeat_response",
  "success": true,
  "timestamp": 1702200000000
}
```

**5. é”™è¯¯æ¶ˆæ¯**
```json
{
  "type": "error",
  "message": "æ‚¨å·²è¢«ç¦è¨€",
  "success": false,
  "timestamp": 1702200000000
}
```

---

## å‰ç«¯é›†æˆç¤ºä¾‹

### Vue 3 é›†æˆç¤ºä¾‹

```vue
<template>
  <div class="group-chat">
    <!-- ç¾¤èŠåˆ—è¡¨ -->
    <div class="group-list">
      <div 
        v-for="group in groupList" 
        :key="group.groupId"
        @click="selectGroup(group)"
        class="group-item"
      >
        <img :src="group.groupAvatar" class="group-avatar" />
        <div class="group-info">
          <div class="group-name">{{ group.groupName }}</div>
          <div class="member-count">{{ group.currentMembers }}äºº</div>
        </div>
        <span v-if="group.unreadCount > 0" class="unread-badge">
          {{ group.unreadCount }}
        </span>
      </div>
    </div>

    <!-- èŠå¤©çª—å£ -->
    <div class="chat-window" v-if="currentGroup">
      <div class="chat-header">
        <h3>{{ currentGroup.groupName }}</h3>
        <button @click="showMembers">æˆå‘˜åˆ—è¡¨</button>
      </div>

      <div class="message-list" ref="messageList">
        <div 
          v-for="msg in messages" 
          :key="msg.messageId"
          :class="['message-item', msg.senderId === currentUserId ? 'mine' : 'others']"
        >
          <img :src="msg.senderAvatar" class="avatar" />
          <div class="message-content">
            <div class="sender-name">{{ msg.senderName }}</div>
            <div class="content">{{ msg.content }}</div>
            <div class="time">{{ formatTime(msg.sentTime) }}</div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <input 
          v-model="inputMessage" 
          @keyup.enter="sendMessage"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
        />
        <button @click="sendMessage">å‘é€</button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';
import axios from 'axios';

const currentUserId = ref(1);
const groupList = ref([]);
const currentGroup = ref(null);
const messages = ref([]);
const inputMessage = ref('');
let websocket = null;

// åˆå§‹åŒ–
onMounted(() => {
  loadGroupList();
  connectWebSocket();
});

// åŠ è½½ç¾¤èŠåˆ—è¡¨
const loadGroupList = async () => {
  try {
    const response = await axios.get(`/api/group/my-groups?userId=${currentUserId.value}`);
    if (response.data.code === 200) {
      groupList.value = response.data.data;
    }
  } catch (error) {
    console.error('åŠ è½½ç¾¤èŠåˆ—è¡¨å¤±è´¥:', error);
  }
};

// è¿æ¥WebSocket
const connectWebSocket = () => {
  websocket = new WebSocket(`ws://localhost:8082/api/ws/chat/native?userId=${currentUserId.value}`);
  
  websocket.onopen = () => {
    console.log('WebSocketè¿æ¥æˆåŠŸ');
    startHeartbeat();
  };
  
  websocket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleWebSocketMessage(data);
  };
  
  websocket.onerror = (error) => {
    console.error('WebSocketé”™è¯¯:', error);
  };
  
  websocket.onclose = () => {
    console.log('WebSocketè¿æ¥å…³é—­');
    // é‡è¿é€»è¾‘
    setTimeout(connectWebSocket, 3000);
  };
};

// å¤„ç†WebSocketæ¶ˆæ¯
const handleWebSocketMessage = (data) => {
  switch (data.type) {
    case 'new_group_message':
      // æ–°ç¾¤æ¶ˆæ¯
      if (currentGroup.value && data.data.groupId === currentGroup.value.groupId) {
        messages.value.push(data.data);
        scrollToBottom();
      }
      // æ›´æ–°æœªè¯»æ•°
      updateUnreadCount(data.data.groupId);
      break;
      
    case 'group_invitation':
      // ç¾¤é‚€è¯·é€šçŸ¥
      console.log('æ”¶åˆ°ç¾¤é‚€è¯·:', data.data);
      loadGroupList(); // åˆ·æ–°ç¾¤åˆ—è¡¨
      break;
      
    case 'send_message_success':
      // æ¶ˆæ¯å‘é€æˆåŠŸ
      console.log('æ¶ˆæ¯å‘é€æˆåŠŸ:', data.data);
      break;
      
    case 'heartbeat_response':
      // å¿ƒè·³å“åº”
      break;
      
    case 'error':
      // é”™è¯¯æ¶ˆæ¯
      alert(data.message);
      break;
  }
};

// å‘é€å¿ƒè·³
const startHeartbeat = () => {
  setInterval(() => {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
      websocket.send(JSON.stringify({
        type: 'heartbeat',
        data: {},
        timestamp: Date.now()
      }));
    }
  }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
};

// é€‰æ‹©ç¾¤èŠ
const selectGroup = async (group) => {
  currentGroup.value = group;
  messages.value = [];
  
  // æ ‡è®°æ¶ˆæ¯å·²è¯»
  await markAsRead(group.groupId);
  
  // åŠ è½½ç¾¤èŠè®°å½•
  await loadGroupMessages(group.groupId);
};

// å‘é€æ¶ˆæ¯
const sendMessage = () => {
  if (!inputMessage.value.trim() || !currentGroup.value) return;
  
  const message = {
    type: 'send_message',
    data: {
      groupId: currentGroup.value.groupId,
      messageType: 'text',
      content: inputMessage.value
    },
    timestamp: Date.now(),
    requestId: `req_${Date.now()}`
  };
  
  websocket.send(JSON.stringify(message));
  
  // æ·»åŠ åˆ°æœ¬åœ°æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¹è§‚æ›´æ–°ï¼‰
  messages.value.push({
    messageId: Date.now(),
    senderId: currentUserId.value,
    groupId: currentGroup.value.groupId,
    content: inputMessage.value,
    sentTime: new Date().toISOString(),
    status: 'sending'
  });
  
  inputMessage.value = '';
  scrollToBottom();
};

// åŠ è½½ç¾¤èŠè®°å½•
const loadGroupMessages = async (groupId) => {
  try {
    const response = await axios.get(`/api/group/${groupId}/messages`, {
      params: {
        userId: currentUserId.value,
        page: 1,
        size: 50
      }
    });
    
    if (response.data.code === 200) {
      messages.value = response.data.data;
      scrollToBottom();
    }
  } catch (error) {
    console.error('åŠ è½½ç¾¤èŠè®°å½•å¤±è´¥:', error);
  }
};

// æ ‡è®°å·²è¯»
const markAsRead = async (groupId) => {
  try {
    await axios.post(`/api/group/${groupId}/mark-read`, {
      userId: currentUserId.value
    });
    
    // æ›´æ–°æœ¬åœ°æœªè¯»æ•°
    const group = groupList.value.find(g => g.groupId === groupId);
    if (group) {
      group.unreadCount = 0;
    }
  } catch (error) {
    console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
  }
};

// æ›´æ–°æœªè¯»æ•°
const updateUnreadCount = (groupId) => {
  const group = groupList.value.find(g => g.groupId === groupId);
  if (group && (!currentGroup.value || currentGroup.value.groupId !== groupId)) {
    group.unreadCount = (group.unreadCount || 0) + 1;
  }
};

// æ»šåŠ¨åˆ°åº•éƒ¨
const scrollToBottom = () => {
  setTimeout(() => {
    const messageList = document.querySelector('.message-list');
    if (messageList) {
      messageList.scrollTop = messageList.scrollHeight;
    }
  }, 100);
};

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (time) => {
  return new Date(time).toLocaleTimeString('zh-CN', {
    hour: '2-digit',
    minute: '2-digit'
  });
};

// æ¸…ç†
onUnmounted(() => {
  if (websocket) {
    websocket.close();
  }
});
</script>

<style scoped>
.group-chat {
  display: flex;
  height: 100vh;
}

.group-list {
  width: 300px;
  border-right: 1px solid #eee;
  overflow-y: auto;
}

.group-item {
  display: flex;
  align-items: center;
  padding: 12px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}

.group-item:hover {
  background-color: #f5f5f5;
}

.group-avatar {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  margin-right: 12px;
}

.unread-badge {
  background-color: #ff4d4f;
  color: white;
  border-radius: 10px;
  padding: 2px 8px;
  font-size: 12px;
  margin-left: auto;
}

.chat-window {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 16px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.message-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.message-item {
  display: flex;
  margin-bottom: 16px;
}

.message-item.mine {
  flex-direction: row-reverse;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin: 0 8px;
}

.message-content {
  max-width: 60%;
}

.sender-name {
  font-size: 12px;
  color: #999;
  margin-bottom: 4px;
}

.content {
  background-color: #f0f0f0;
  padding: 8px 12px;
  border-radius: 8px;
  word-break: break-word;
}

.message-item.mine .content {
  background-color: #1890ff;
  color: white;
}

.time {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.input-area {
  display: flex;
  padding: 16px;
  border-top: 1px solid #eee;
}

.input-area input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  margin-right: 8px;
}

.input-area button {
  padding: 8px 24px;
  background-color: #1890ff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
</style>
```

---

### React é›†æˆç¤ºä¾‹

```jsx
import React, { useState, useEffect, useRef } from 'react';
import axios from 'axios';

const GroupChat = () => {
  const [currentUserId] = useState(1);
  const [groupList, setGroupList] = useState([]);
  const [currentGroup, setCurrentGroup] = useState(null);
  const [messages, setMessages] = useState([]);
  const [inputMessage, setInputMessage] = useState('');
  const websocketRef = useRef(null);
  const messageListRef = useRef(null);

  useEffect(() => {
    loadGroupList();
    connectWebSocket();

    return () => {
      if (websocketRef.current) {
        websocketRef.current.close();
      }
    };
  }, []);

  const loadGroupList = async () => {
    try {
      const response = await axios.get(`/api/group/my-groups?userId=${currentUserId}`);
      if (response.data.code === 200) {
        setGroupList(response.data.data);
      }
    } catch (error) {
      console.error('åŠ è½½ç¾¤èŠåˆ—è¡¨å¤±è´¥:', error);
    }
  };

  const connectWebSocket = () => {
    const ws = new WebSocket(`ws://localhost:8082/api/ws/chat/native?userId=${currentUserId}`);
    
    ws.onopen = () => {
      console.log('WebSocketè¿æ¥æˆåŠŸ');
      startHeartbeat(ws);
    };
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      handleWebSocketMessage(data);
    };
    
    ws.onerror = (error) => {
      console.error('WebSocketé”™è¯¯:', error);
    };
    
    ws.onclose = () => {
      console.log('WebSocketè¿æ¥å…³é—­');
      setTimeout(connectWebSocket, 3000);
    };
    
    websocketRef.current = ws;
  };

  const handleWebSocketMessage = (data) => {
    switch (data.type) {
      case 'new_group_message':
        if (currentGroup && data.data.groupId === currentGroup.groupId) {
          setMessages(prev => [...prev, data.data]);
          scrollToBottom();
        }
        updateUnreadCount(data.data.groupId);
        break;
      case 'group_invitation':
        console.log('æ”¶åˆ°ç¾¤é‚€è¯·:', data.data);
        loadGroupList();
        break;
      case 'error':
        alert(data.message);
        break;
    }
  };

  const startHeartbeat = (ws) => {
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'heartbeat',
          data: {},
          timestamp: Date.now()
        }));
      }
    }, 30000);
  };

  const selectGroup = async (group) => {
    setCurrentGroup(group);
    setMessages([]);
    await markAsRead(group.groupId);
    await loadGroupMessages(group.groupId);
  };

  const sendMessage = () => {
    if (!inputMessage.trim() || !currentGroup) return;
    
    const message = {
      type: 'send_message',
      data: {
        groupId: currentGroup.groupId,
        messageType: 'text',
        content: inputMessage
      },
      timestamp: Date.now(),
      requestId: `req_${Date.now()}`
    };
    
    websocketRef.current.send(JSON.stringify(message));
    
    setMessages(prev => [...prev, {
      messageId: Date.now(),
      senderId: currentUserId,
      content: inputMessage,
      sentTime: new Date().toISOString()
    }]);
    
    setInputMessage('');
    scrollToBottom();
  };

  const loadGroupMessages = async (groupId) => {
    try {
      const response = await axios.get(`/api/group/${groupId}/messages`, {
        params: { userId: currentUserId, page: 1, size: 50 }
      });
      
      if (response.data.code === 200) {
        setMessages(response.data.data);
        scrollToBottom();
      }
    } catch (error) {
      console.error('åŠ è½½ç¾¤èŠè®°å½•å¤±è´¥:', error);
    }
  };

  const markAsRead = async (groupId) => {
    try {
      await axios.post(`/api/group/${groupId}/mark-read`, {
        userId: currentUserId
      });
      
      setGroupList(prev => prev.map(g => 
        g.groupId === groupId ? { ...g, unreadCount: 0 } : g
      ));
    } catch (error) {
      console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
    }
  };

  const updateUnreadCount = (groupId) => {
    if (!currentGroup || currentGroup.groupId !== groupId) {
      setGroupList(prev => prev.map(g => 
        g.groupId === groupId ? { ...g, unreadCount: (g.unreadCount || 0) + 1 } : g
      ));
    }
  };

  const scrollToBottom = () => {
    setTimeout(() => {
      if (messageListRef.current) {
        messageListRef.current.scrollTop = messageListRef.current.scrollHeight;
      }
    }, 100);
  };

  return (
    <div className="group-chat">
      <div className="group-list">
        {groupList.map(group => (
          <div 
            key={group.groupId}
            className="group-item"
            onClick={() => selectGroup(group)}
          >
            <img src={group.groupAvatar} className="group-avatar" />
            <div className="group-info">
              <div className="group-name">{group.groupName}</div>
              <div className="member-count">{group.currentMembers}äºº</div>
            </div>
            {group.unreadCount > 0 && (
              <span className="unread-badge">{group.unreadCount}</span>
            )}
          </div>
        ))}
      </div>

      {currentGroup && (
        <div className="chat-window">
          <div className="chat-header">
            <h3>{currentGroup.groupName}</h3>
          </div>

          <div className="message-list" ref={messageListRef}>
            {messages.map(msg => (
              <div 
                key={msg.messageId}
                className={`message-item ${msg.senderId === currentUserId ? 'mine' : 'others'}`}
              >
                <img src={msg.senderAvatar} className="avatar" />
                <div className="message-content">
                  <div className="sender-name">{msg.senderName}</div>
                  <div className="content">{msg.content}</div>
                  <div className="time">{new Date(msg.sentTime).toLocaleTimeString()}</div>
                </div>
              </div>
            ))}
          </div>

          <div className="input-area">
            <input 
              value={inputMessage}
              onChange={(e) => setInputMessage(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
              placeholder="è¾“å…¥æ¶ˆæ¯..."
            />
            <button onClick={sendMessage}>å‘é€</button>
          </div>
        </div>
      )}
    </div>
  );
};

export default GroupChat;
```

---

## æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“åˆå§‹åŒ–
åœ¨ä½¿ç”¨ç¾¤èŠåŠŸèƒ½å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œæ•°æ®åº“è„šæœ¬ï¼š
```bash
mysql -u root -p gd_mcp < group_chat_tables.sql
```

### 2. WebSocketè¿æ¥
- ç¡®ä¿URLå‚æ•°ä¸­åŒ…å«æ­£ç¡®çš„`userId`
- å»ºè®®å®ç°æ–­çº¿é‡è¿æœºåˆ¶
- å®šæ—¶å‘é€å¿ƒè·³æ¶ˆæ¯ä¿æŒè¿æ¥

### 3. æ¶ˆæ¯æ¨é€
- ç¾¤æ¶ˆæ¯ä¼šæ¨é€ç»™æ‰€æœ‰åœ¨çº¿çš„ç¾¤æˆå‘˜ï¼ˆé™¤å‘é€è€…ï¼‰
- ç¦»çº¿ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æ•°ä¼šè‡ªåŠ¨ç´¯è®¡
- ç”¨æˆ·ä¸Šçº¿åå¯é€šè¿‡APIè·å–æœªè¯»æ¶ˆæ¯

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- ç¾¤èŠè®°å½•é‡‡ç”¨åˆ†é¡µåŠ è½½
- å¤§ç¾¤ï¼ˆ>100äººï¼‰å»ºè®®é™åˆ¶æ¶ˆæ¯å‘é€é¢‘ç‡
- åª’ä½“æ¶ˆæ¯å»ºè®®ä½¿ç”¨CDNåŠ é€Ÿ

### 5. å®‰å…¨å»ºè®®
- æ‰€æœ‰APIæ¥å£åº”è¯¥æ·»åŠ ç”¨æˆ·èº«ä»½éªŒè¯
- WebSocketè¿æ¥åº”è¯¥éªŒè¯ç”¨æˆ·Token
- æ•æ„Ÿæ“ä½œï¼ˆè¸¢äººã€ç¦è¨€ï¼‰éœ€è¦éªŒè¯æƒé™
- é˜²æ­¢SQLæ³¨å…¥å’ŒXSSæ”»å‡»

### 6. é”™è¯¯å¤„ç†
- å‰ç«¯åº”è¯¥å¤„ç†æ‰€æœ‰å¯èƒ½çš„é”™è¯¯å“åº”
- WebSocketæ–­çº¿åè‡ªåŠ¨é‡è¿
- æ¶ˆæ¯å‘é€å¤±è´¥åº”è¯¥æœ‰é‡è¯•æœºåˆ¶

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åç«¯æœåŠ¡
```bash
cd hy-back-end
mvn spring-boot:run
```

### 2. æµ‹è¯•APIï¼ˆä½¿ç”¨Postmanæˆ–curlï¼‰
```bash
# åˆ›å»ºç¾¤èŠ
curl -X POST http://localhost:8082/api/group/create-with-friends \
  -H "Content-Type: application/json" \
  -d '{
    "creatorId": 1,
    "groupName": "æµ‹è¯•ç¾¤èŠ",
    "friendIds": [2, 3, 4]
  }'

# è·å–æˆ‘çš„ç¾¤èŠåˆ—è¡¨
curl http://localhost:8082/api/group/my-groups?userId=1
```

### 3. æµ‹è¯•WebSocketï¼ˆä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°ï¼‰
```javascript
const ws = new WebSocket('ws://localhost:8082/api/ws/chat/native?userId=1');

ws.onmessage = (event) => {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', JSON.parse(event.data));
};

// å‘é€ç¾¤æ¶ˆæ¯
ws.send(JSON.stringify({
    type: 'send_message',
    data: {
        groupId: 1,
        messageType: 'text',
        content: 'æµ‹è¯•æ¶ˆæ¯'
    },
    timestamp: Date.now()
}));
```

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. åç«¯æ—¥å¿—ï¼š`logs/spring.log`
2. æ•°æ®åº“çŠ¶æ€ï¼šæ£€æŸ¥è¡¨æ•°æ®æ˜¯å¦æ­£ç¡®
3. WebSocketè¿æ¥ï¼šæ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

**ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
