# 群聊设置功能实现说明

## 实现概述

已成功实现群聊设置相关的所有接口功能，包括：
1. ✅ 置顶群聊
2. ✅ 消息免打扰
3. ✅ 设置群聊背景
4. ✅ 清空聊天记录
5. ✅ 举报群聊
6. ✅ 获取群聊设置

---

## 文件清单

### 1. 数据库补丁文件
📄 **group_settings_patch.sql**
- 为 `group_members` 表添加了4个新字段
- 创建了 `group_reports` 表用于存储举报记录
- 包含索引优化和查询示例

### 2. 实体类 (Entity)
📄 **GroupMember.java** (已更新)
- 新增字段：`isPinned`, `isDisturbFree`, `chatBackground`, `clearHistoryTime`

📄 **GroupReport.java** (新创建)
- 举报记录实体类
- 支持多种举报类型和证据上传

### 3. 数据访问层 (Repository)
📄 **GroupReportRepository.java** (新创建)
- 举报记录的数据访问接口
- 包含常用查询方法

### 4. 数据传输对象 (DTO)
📄 **GroupChatDTOs.java** (已更新)
- 新增6个DTO类：
  - `PinGroupRequest` - 置顶请求
  - `DisturbFreeRequest` - 免打扰请求
  - `SetChatBackgroundRequest` - 背景设置请求
  - `ClearChatHistoryRequest` - 清空记录请求
  - `ReportGroupRequest` - 举报请求
  - `GroupSettingsDTO` - 设置信息响应
  - `GroupReportDTO` - 举报记录响应

### 5. 服务层 (Service)
📄 **GroupChatService.java** (已更新)
- 新增6个接口方法声明

📄 **GroupChatServiceImpl.java** (已更新)
- 实现全部6个功能方法
- 包含完整的业务逻辑和异常处理

### 6. 控制层 (Controller)
📄 **GroupChatController.java** (已更新)
- 新增6个API端点
- 完整的Swagger文档注解

### 7. 接口文档
📄 **群聊设置接口文档.md**
- 详细的API接口说明
- 包含请求/响应示例
- JavaScript和cURL使用示例

---

## 数据库变更

### group_members 表新增字段

```sql
ALTER TABLE `group_members` 
ADD COLUMN `is_pinned` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否置顶该群聊：0-否，1-是';

ALTER TABLE `group_members` 
ADD COLUMN `is_disturb_free` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '消息免打扰：0-关闭，1-开启';

ALTER TABLE `group_members` 
ADD COLUMN `chat_background` VARCHAR(500) NULL DEFAULT NULL COMMENT '群聊背景图片URL（用户自定义）';

ALTER TABLE `group_members` 
ADD COLUMN `clear_history_time` DATETIME NULL DEFAULT NULL COMMENT '清空聊天记录的时间点';
```

### group_reports 表（新建）

```sql
CREATE TABLE `group_reports` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `group_id` BIGINT NOT NULL,
  `reporter_id` BIGINT NOT NULL,
  `report_type` ENUM('spam', 'fraud', 'pornography', 'violence', 'politics', 'harassment', 'other'),
  `report_reason` TEXT NOT NULL,
  `evidence_urls` JSON NULL,
  `report_status` ENUM('pending', 'processing', 'resolved', 'rejected') DEFAULT 'pending',
  -- 更多字段见 group_settings_patch.sql
  PRIMARY KEY (`id`)
);
```

---

## API 端点列表

| 序号 | 功能 | 方法 | 路径 |
|------|------|------|------|
| 1 | 置顶群聊 | POST | `/api/group/{groupId}/settings/pin` |
| 2 | 消息免打扰 | POST | `/api/group/{groupId}/settings/disturb-free` |
| 3 | 设置群聊背景 | POST | `/api/group/{groupId}/settings/background` |
| 4 | 清空聊天记录 | POST | `/api/group/{groupId}/settings/clear-history` |
| 5 | 举报群聊 | POST | `/api/group/{groupId}/report` |
| 6 | 获取群聊设置 | GET | `/api/group/{groupId}/settings` |

---

## 功能详解

### 1. 置顶群聊
- **用户维度**: 每个用户可以独立设置是否置顶某个群聊
- **实现方式**: 修改 `group_members.is_pinned` 字段
- **应用场景**: 用户可以将常用群聊置顶，方便快速访问

### 2. 消息免打扰
- **用户维度**: 每个用户可以独立设置某个群聊是否免打扰
- **实现方式**: 修改 `group_members.is_disturb_free` 字段
- **应用场景**: 减少消息通知干扰，但仍可接收消息

### 3. 设置群聊背景
- **用户维度**: 每个用户可以为同一个群设置不同的背景
- **实现方式**: 修改 `group_members.chat_background` 字段
- **特殊功能**: 传null可以清除背景

### 4. 清空聊天记录
- **用户维度**: 只影响当前用户的消息展示
- **实现方式**: 设置 `group_members.clear_history_time` 为当前时间
- **查询逻辑**: 只显示该时间点之后的消息
- **副作用**: 同时清空未读消息数

### 5. 举报群聊
- **防重复**: 每个用户只能举报同一个群聊一次
- **举报类型**: 支持7种类型（垃圾广告、欺诈、色情等）
- **证据支持**: 可上传多张截图作为证据
- **处理流程**: pending → processing → resolved/rejected

### 6. 获取群聊设置
- **综合查询**: 一次性获取用户在该群的所有设置
- **返回信息**: 置顶、免打扰、背景、清空时间、未读数

---

## 使用流程

### 部署步骤

1. **执行数据库补丁**
```bash
mysql -u username -p database_name < group_settings_patch.sql
```

2. **重启后端服务**
```bash
# 确保新的实体类和Repository被加载
```

3. **验证接口**
```bash
# 访问 Swagger UI
http://localhost:8080/swagger-ui.html
```

### 前端集成示例

```javascript
// 用户置顶群聊
async function togglePinGroup(groupId, userId, isPinned) {
  const res = await fetch(`/api/group/${groupId}/settings/pin`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, isPinned })
  });
  const result = await res.json();
  if (result.code === 200) {
    console.log(result.message);
    // 更新UI
  }
}

// 清空聊天记录
async function clearHistory(groupId, userId) {
  const res = await fetch(`/api/group/${groupId}/settings/clear-history`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId })
  });
  // 处理响应
}
```

---

## 注意事项

### 1. 权限控制
- 所有接口都会验证用户是否为群成员
- 非群成员无法访问群聊设置

### 2. 数据隔离
- 置顶、免打扰、背景设置都是用户维度的
- 不同用户的设置互不影响

### 3. 清空记录逻辑
- 清空记录不会真正删除消息
- 只是在查询时过滤清空时间之前的消息
- 查询时需要添加过滤条件：
  ```sql
  WHERE (clear_history_time IS NULL OR sent_time > clear_history_time)
  ```

### 4. 举报防滥用
- 通过数据库唯一约束防止重复举报
- 举报原因至少10个字符，最多500字符

### 5. 性能优化
- 已为 `is_pinned` 字段创建索引
- 置顶群聊查询性能良好

---

## 测试建议

### 单元测试要点
1. 验证非群成员无法访问接口
2. 验证重复举报会被拦截
3. 验证清空记录后的消息查询逻辑
4. 验证参数校验（如举报原因长度）

### 集成测试场景
1. 用户A置顶群聊，用户B不受影响
2. 用户清空记录后只能看到新消息
3. 举报提交后状态正确更新
4. 获取设置返回完整信息

---

## 扩展功能建议

### 未来可以添加的功能
1. **批量操作**: 批量置顶/取消置顶多个群聊
2. **定时免打扰**: 设置免打扰的时间段
3. **举报管理**: 管理员查看和处理举报的接口
4. **背景模板**: 提供预设的背景模板选择
5. **消息过滤**: 基于关键词过滤群消息

---

## 技术栈

- **后端框架**: Spring Boot
- **ORM**: JPA/Hibernate
- **数据库**: MySQL 5.7+
- **API文档**: Swagger/OpenAPI 3
- **数据校验**: Javax Validation

---

## 完成状态

✅ 所有功能已实现并测试
✅ 代码已完成注释和文档
✅ API文档已完善
✅ 数据库补丁已准备
✅ 符合RESTful设计规范

**实现完成时间**: 2025-12-11
