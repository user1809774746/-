# æ•°æ®åº“é—®é¢˜è¯Šæ–­ä¸ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ” é—®é¢˜è¯Šæ–­æ€»ç»“

### åŸå§‹é”™è¯¯
```
POST /api/user-chat/messages/send 500 (Internal Server Error)
```

### è¯Šæ–­è¿‡ç¨‹

#### âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
1. **ç”¨æˆ·æ•°æ®**ï¼š
   - UserID 1 å­˜åœ¨ (æ‰‹æœºå·: 18831231517) âœ…
   - UserID 3 å­˜åœ¨ (æ‰‹æœºå·: 15831835101) âœ…

2. **å¥½å‹å…³ç³»**ï¼š
   - user_id=1, friend_id=3, status='accepted' âœ…
   - å¥½å‹å…³ç³»æ­£å¸¸

#### âŒ å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼šMessageå®ä½“ç¼ºå°‘receiverIdå­—æ®µ
**æ•°æ®åº“è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE messages (
    sender_id bigint NOT NULL,
    receiver_id bigint NOT NULL,  -- âš ï¸ æ•°æ®åº“æœ‰è¿™ä¸ªå­—æ®µ
    ...
)
```

**åç«¯å®ä½“ï¼ˆä¿®å¤å‰ï¼‰**ï¼š
```java
public class Message {
    private Long senderId;
    // âŒ ç¼ºå°‘receiverIdå­—æ®µï¼
}
```

**åæœ**ï¼š
- JPAæ— æ³•è®¾ç½®receiver_idå­—æ®µ
- è¿åNOT NULLçº¦æŸ
- å¯¼è‡´500é”™è¯¯

### é—®é¢˜2ï¼šmessage_typeå’Œstatuså­—æ®µç±»å‹ä¸åŒ¹é…

**æ•°æ®åº“è¡¨ç»“æ„**ï¼š
```sql
message_type enum('text','image','video','audio'...) -- å°å†™enumå€¼
status varchar(255) NOT NULL -- varcharç±»å‹ï¼Œä¸æ˜¯enum
```

**åç«¯å®ä½“ï¼ˆä¿®å¤å‰ï¼‰**ï¼š
```java
@Enumerated(EnumType.STRING)
private MessageType messageType; // enum: TEXT, IMAGE, VOICE...

@Enumerated(EnumType.STRING)  
private MessageStatus status; // enum: SENT, DELIVERED...
```

**åæœ**ï¼š
- JPAä¼šå­˜å‚¨å¤§å†™enumåï¼ˆ"TEXT"ï¼‰ï¼Œä½†æ•°æ®åº“æœŸæœ›å°å†™ï¼ˆ"text"ï¼‰
- statuså­—æ®µç±»å‹ä¸åŒ¹é…

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ·»åŠ receiverIdå­—æ®µ
```java
@Column(name = "receiver_id", nullable = false)
private Long receiverId;
```

### ä¿®å¤2ï¼šå°†messageTypeå’Œstatusæ”¹ä¸ºStringç±»å‹
```java
@Column(name = "message_type", nullable = false)
private String messageType; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²

@Column(name = "status", nullable = false)
private String status = "sent"; // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œé»˜è®¤"sent"
```

### ä¿®å¤3ï¼šæ›´æ–°ChatServiceImplå‘é€æ¶ˆæ¯é€»è¾‘
```java
// åˆ›å»ºæ¶ˆæ¯å®ä½“
Message message = new Message();
message.setConversationId(conversationId);
message.setSenderId(request.getSenderId());
message.setReceiverId(request.getReceiverId()); // âœ… è®¾ç½®receiverId
message.setContent(request.getContent());
message.setMessageType(request.getMessageType().toLowerCase()); // âœ… ä½¿ç”¨å°å†™
message.setReplyToMessageId(request.getReplyToMessageId());
message.setStatus("sent"); // âœ… ä½¿ç”¨å°å†™å­—ç¬¦ä¸²
```

## ğŸ”§ å·²å®Œæˆçš„ä¿®å¤

1. âœ… **Message.java** - æ·»åŠ receiverIdå­—æ®µ
2. âœ… **Message.java** - å°†messageTypeä»enumæ”¹ä¸ºString
3. âœ… **Message.java** - å°†statusä»enumæ”¹ä¸ºString
4. âœ… **ChatServiceImpl.java** - åœ¨sendMessageä¸­è®¾ç½®receiverId
5. âœ… **ChatServiceImpl.java** - ä½¿ç”¨å°å†™messageTypeå€¼
6. âœ… **ChatServiceImpl.java** - ä½¿ç”¨å°å†™statuså­—ç¬¦ä¸²å€¼
7. âœ… **ChatServiceImpl.java** - ä¿®å¤MessageDTOæ„å»ºé€»è¾‘

## ğŸš€ æµ‹è¯•éªŒè¯

### é‡å¯åç«¯æœåŠ¡
ä¿®å¤å®Œæˆåï¼Œéœ€è¦é‡å¯åç«¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ï¼š
```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
mvn spring-boot:run
```

### æµ‹è¯•æ¶ˆæ¯å‘é€
```bash
curl -X POST http://localhost:8082/api/user-chat/messages/send \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": 1,
    "receiverId": 3,
    "messageType": "text",
    "content": "ä½ å¥½ï¼"
  }'
```

### é¢„æœŸç»“æœ
```json
{
  "code": 200,
  "message": "æ¶ˆæ¯å‘é€æˆåŠŸ",
  "data": {
    "messageId": 1,
    "senderId": 1,
    "receiverId": 3,
    "content": "ä½ å¥½ï¼",
    "messageType": "text",
    "sentTime": "2025-11-18 16:05:00",
    "isRead": false
  }
}
```

## ğŸ“ æ•°æ®åº“å­—æ®µå¯¹ç…§è¡¨

| æ•°æ®åº“å­—æ®µ | ç±»å‹ | Javaå­—æ®µ | Javaç±»å‹ | è¯´æ˜ |
|----------|------|---------|---------|------|
| id | bigint | id | Long | ä¸»é”® |
| conversation_id | bigint | conversationId | Long | ä¼šè¯ID |
| sender_id | bigint | senderId | Long | å‘é€è€…ID |
| receiver_id | bigint | receiverId | Long | âœ… æ–°æ·»åŠ  |
| message_type | enum | messageType | String | âœ… æ”¹ä¸ºString |
| content | text | content | String | æ¶ˆæ¯å†…å®¹ |
| status | varchar | status | String | âœ… æ”¹ä¸ºString |
| created_at | timestamp | createdAt | LocalDateTime | åˆ›å»ºæ—¶é—´ |

## ğŸ¯ å…³é”®æ”¹è¿›

1. **å®Œæ•´çš„å­—æ®µæ˜ å°„** - æ‰€æœ‰æ•°æ®åº“å¿…å¡«å­—æ®µéƒ½æœ‰å¯¹åº”çš„Javaå­—æ®µ
2. **ç±»å‹ä¸€è‡´æ€§** - Javaç±»å‹ä¸æ•°æ®åº“ç±»å‹å®Œå…¨åŒ¹é…
3. **æ­£ç¡®çš„é»˜è®¤å€¼** - statusé»˜è®¤ä¸º"sent"ï¼ˆå°å†™ï¼‰
4. **è‰¯å¥½çš„æ—¥å¿—è®°å½•** - å‘é€æˆåŠŸæ—¶è®°å½•messageId

## ğŸ“ åç»­å»ºè®®

1. **æ·»åŠ å­—æ®µéªŒè¯** - åœ¨Serviceå±‚éªŒè¯messageTypeçš„æœ‰æ•ˆå€¼
2. **æšä¸¾å¸¸é‡ç±»** - åˆ›å»ºMessageTypeConstantsç±»å®šä¹‰æœ‰æ•ˆçš„message_typeå€¼
3. **å•å…ƒæµ‹è¯•** - ä¸ºsendMessageæ–¹æ³•æ·»åŠ å•å…ƒæµ‹è¯•

---

**ä¿®å¤å®Œæˆï¼é‡å¯åç«¯æœåŠ¡åï¼ŒèŠå¤©åŠŸèƒ½åº”è¯¥å®Œå…¨æ­£å¸¸ï¼** ğŸ‰
