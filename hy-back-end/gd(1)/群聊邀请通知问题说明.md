# 群聊邀请通知问题说明

> **问题**：创建群聊时选择了好友，但好友没有收到进群提示  
> **时间**：2025-12-10  
> **状态**：⚠️ 需要后端修复

---

## 🐛 问题描述

**用户操作流程**：
1. 用户A 打开群聊页面
2. 点击"创建群聊"
3. 选择好友B、C、D
4. 输入群名称，点击创建
5. 创建成功

**预期结果**：
- ✅ 用户A 看到创建成功提示
- ✅ 用户A 的群聊列表显示新群聊
- ❌ **用户B、C、D 应该收到弹窗通知："您被邀请加入群聊：XXX"**
- ❌ **用户B、C、D 的群聊列表应该自动刷新显示新群聊**

**实际结果**：
- ✅ 用户A 创建成功
- ❌ 用户B、C、D 没有收到任何通知
- ❌ 用户B、C、D 的群聊列表没有更新

---

## 🔍 问题根因

### 后端缺少 WebSocket 推送逻辑

根据群聊接口文档，`POST /api/group/create-with-friends` 接口在创建群聊成功后，**应该主动向所有被邀请的好友发送 WebSocket 通知**，但目前后端没有实现这个功能。

### 前端已完成的工作

前端已经完成以下准备工作：

1. ✅ **WebSocket 连接已建立**
   - 用户登录后自动连接 WebSocket
   - 可以接收和发送消息

2. ✅ **已注册监听器**
   - 监听 `group_invitation` 消息
   - 监听 `member_joined` 消息
   - 监听 `group_notification` 消息

3. ✅ **处理逻辑已完成**
   - 收到通知后弹出提示
   - 自动刷新群聊列表

**前端日志输出**（可在浏览器控制台查看）：
```
🔌 正在初始化WebSocket连接, 用户ID: 1
✅ WebSocket连接成功
✅ 已注册监听: GROUP_INVITATION
✅ 已注册监听: MEMBER_JOINED
✅ 已注册监听: GROUP_NOTIFICATION
🎯 WebSocket初始化完成，等待接收消息...
```

---

## 🔧 后端需要修复的内容

### 修复位置

**Java 后端文件**：`GroupChatController.java` 或 `GroupChatService.java`

**具体方法**：`createGroupWithFriends()` 方法

### 需要添加的逻辑

在创建群聊成功后，添加以下代码：

```java
@PostMapping("/create-with-friends")
public ResponseResult<GroupChatDTO> createGroupWithFriends(@RequestBody CreateGroupRequest request) {
    try {
        // 1. 创建群聊（现有逻辑）
        GroupChatDTO groupChat = groupChatService.createGroupWithFriends(
            request.getCreatorId(),
            request.getGroupName(),
            request.getGroupDescription(),
            request.getFriendIds()
        );
        
        // ⚠️ 2. 【需要添加】向所有被邀请的好友发送 WebSocket 通知
        if (request.getFriendIds() != null && !request.getFriendIds().isEmpty()) {
            for (Long friendId : request.getFriendIds()) {
                sendGroupInvitationNotification(friendId, groupChat, request.getCreatorId());
            }
        }
        
        return ResponseResult.success("群聊创建成功", groupChat);
    } catch (Exception e) {
        log.error("创建群聊失败", e);
        return ResponseResult.error("创建群聊失败: " + e.getMessage());
    }
}

/**
 * 发送群聊邀请通知
 */
private void sendGroupInvitationNotification(Long userId, GroupChatDTO groupChat, Long inviterId) {
    try {
        // 获取邀请人信息
        UserDTO inviter = userService.getUserById(inviterId);
        
        // 构建 WebSocket 消息
        Map<String, Object> notification = new HashMap<>();
        notification.put("type", "group_invitation");
        
        Map<String, Object> data = new HashMap<>();
        data.put("groupId", groupChat.getGroupId());
        data.put("groupName", groupChat.getGroupName());
        data.put("inviterId", inviterId);
        data.put("inviterName", inviter.getNickname() != null ? inviter.getNickname() : inviter.getUsername());
        
        notification.put("data", data);
        notification.put("success", true);
        notification.put("timestamp", System.currentTimeMillis());
        
        // 发送 WebSocket 消息
        webSocketHandler.sendMessageToUser(userId, notification);
        
        log.info("已向用户 {} 发送群聊邀请通知, 群聊ID: {}, 群名: {}", 
                 userId, groupChat.getGroupId(), groupChat.getGroupName());
    } catch (Exception e) {
        log.error("发送群聊邀请通知失败, userId: {}, groupId: {}", 
                  userId, groupChat.getGroupId(), e);
    }
}
```

---

## 📋 WebSocket 消息格式

### 发送给被邀请者的消息

**消息类型**：`group_invitation`

**完整格式**：
```json
{
  "type": "group_invitation",
  "data": {
    "groupId": 1,
    "groupName": "技术交流群",
    "inviterId": 1,
    "inviterName": "张三"
  },
  "success": true,
  "timestamp": 1702195200000
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | ✅ | 固定值: "group_invitation" |
| data.groupId | Long | ✅ | 群聊ID |
| data.groupName | String | ✅ | 群聊名称 |
| data.inviterId | Long | ✅ | 邀请人用户ID |
| data.inviterName | String | ✅ | 邀请人名称 |
| success | Boolean | ✅ | 固定值: true |
| timestamp | Long | ✅ | 时间戳 |

---

## 🧪 测试方法

### 1. 准备工作

- 准备两个测试账号：用户A（创建者）、用户B（被邀请者）
- 使用两个不同的浏览器或无痕模式
- 都登录到群聊页面

### 2. 测试步骤

**用户A（创建者）操作**：
1. 打开群聊页面
2. 打开浏览器控制台（F12）
3. 点击"创建群聊"
4. 选择用户B
5. 输入群名称"测试群"
6. 点击"创建"

**观察用户A控制台日志**：
```
🎯 开始创建群聊
📝 群名称: 测试群
👥 选择的好友ID列表: [2]
👥 选择的好友详情: [{id: 2, nickname: "用户B"}]
✅ 创建群聊响应: {code: 200, message: "群聊创建成功", data: {...}}
🎉 群聊创建成功！
📊 群聊信息: {groupId: 1, groupName: "测试群", ...}
⚠️ 后端应该已向以下用户ID发送WebSocket通知: [2]
```

**用户B（被邀请者）预期**：

**控制台应该显示**：
```
📬 收到群聊邀请通知 - 原始数据: {type: "group_invitation", data: {...}}
📬 解析后的邀请数据: {groupId: 1, groupName: "测试群", inviterId: 1, inviterName: "用户A"}
🎉 显示邀请通知: 您被邀请加入群聊：测试群\n邀请人：用户A
🔄 刷新群聊列表...
```

**浏览器应该显示**：
- 弹出提示框："您被邀请加入群聊：测试群\n邀请人：用户A"
- 群聊列表自动刷新，显示新群聊

### 3. 如果没有收到通知

**检查用户B的控制台**：

如果看到：
```
🔌 正在初始化WebSocket连接, 用户ID: 2
✅ WebSocket连接成功
✅ 已注册监听: GROUP_INVITATION
🎯 WebSocket初始化完成，等待接收消息...
```

但没有看到 `📬 收到群聊邀请通知`，说明：
- ✅ 前端准备工作已完成
- ❌ **后端没有发送 WebSocket 通知**

---

## 🔍 调试方法

### 后端日志检查

在后端添加日志，确认是否发送了 WebSocket 消息：

```java
log.info("开始创建群聊, 创建者: {}, 好友列表: {}", 
         request.getCreatorId(), request.getFriendIds());

// 创建群聊...

log.info("群聊创建成功, groupId: {}, 开始发送WebSocket通知", groupChat.getGroupId());

for (Long friendId : request.getFriendIds()) {
    log.info("正在向用户 {} 发送群聊邀请通知", friendId);
    sendGroupInvitationNotification(friendId, groupChat, request.getCreatorId());
    log.info("已向用户 {} 发送群聊邀请通知", friendId);
}
```

### WebSocket 连接检查

确保被邀请者的 WebSocket 连接是活跃的：

```java
// 检查用户是否在线
if (webSocketHandler.isUserOnline(userId)) {
    log.info("用户 {} 在线，发送通知", userId);
    webSocketHandler.sendMessageToUser(userId, notification);
} else {
    log.warn("用户 {} 不在线，无法发送WebSocket通知", userId);
    // 可以考虑保存离线消息到数据库
}
```

---

## 📊 完整流程图

```
用户A（创建者）                          后端                            用户B（被邀请者）
     |                                   |                                    |
     |-- 1. 创建群聊 -->                 |                                    |
     |    {groupName, friendIds:[B]}     |                                    |
     |                                   |                                    |
     |                          2. 保存到数据库                               |
     |                                   |                                    |
     |                          3. 返回群聊信息                               |
     |<-- {groupId, groupName} ---------|                                    |
     |                                   |                                    |
     |                          4. ⚠️ 发送WebSocket通知                      |
     |                                   |-- group_invitation --------------->|
     |                                   |    {groupId, groupName}            |
     |                                   |                                    |
     |                                   |                          5. 收到通知，弹窗提示
     |                                   |                                    |
     |                                   |                          6. 刷新群聊列表
     |                                   |<-- GET /my-groups -----------------|
     |                                   |                                    |
     |                                   |-- 返回群聊列表 ------------------>|
     |                                   |    [{groupId, groupName, ...}]    |
```

---

## ✅ 验收标准

修复完成后，需要满足以下条件：

1. ✅ 用户A 创建群聊成功
2. ✅ 用户B 立即收到浏览器弹窗通知
3. ✅ 用户B 的群聊列表自动刷新并显示新群聊
4. ✅ 用户B 可以进入群聊并发送消息
5. ✅ 后端日志显示已发送 WebSocket 通知
6. ✅ 前端控制台显示收到 `group_invitation` 消息

---

## 🚨 重要提示

### 必须在创建群聊时发送通知

不能依赖前端定时轮询或手动刷新，必须使用 WebSocket 实时推送通知。原因：

1. **用户体验**：实时通知比轮询更友好
2. **性能**：避免频繁的 API 请求
3. **准确性**：确保用户第一时间知道被邀请
4. **一致性**：与其他实时功能（如消息推送）保持一致

### 其他场景也需要发送通知

除了创建群聊，以下场景也需要发送 WebSocket 通知：

| 场景 | 消息类型 | 接收者 |
|------|---------|--------|
| 邀请新成员入群 | `group_invitation` | 被邀请者 |
| 新成员加入 | `member_joined` | 群内所有成员 |
| 成员退出 | `member_left` | 群内所有成员 |
| 群聊解散 | `group_notification` | 群内所有成员 |
| 踢出成员 | `group_notification` | 被踢者和其他成员 |
| 设置管理员 | `group_notification` | 被设置者 |

---

## 📝 相关文档

- [群聊接口完整文档.md](./群聊接口完整文档.md)
- [群聊问题修复说明.md](./群聊问题修复说明.md)
- [WebSocket消息格式说明.md](./WebSocket消息格式说明.md)

---

**问题状态**：⚠️ 等待后端修复  
**优先级**：🔴 高  
**预计修复时间**：1小时
