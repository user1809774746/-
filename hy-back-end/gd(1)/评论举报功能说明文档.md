# 评论举报功能说明文档

## 一、功能概述

评论举报功能允许登录用户对社区帖子下的不当评论发起举报。举报信息会被记录到后台数据库，状态标记为 `pending`，供后续管理员审核和处理。

当前版本实现的是：**用户侧的举报提交流程 + 后端落库**，管理员审核处理逻辑可以在此基础上扩展。

---

## 二、接口概览

- **接口地址**：`POST /api/post/comment/report`  
- **所属模块**：帖子/评论模块  
- **控制器**：`UserPostController.reportComment`  
- **服务类**：`UserPostService.reportComment`  
- **是否需登录**：是（必须携带有效登录态）

---

## 三、请求与返回

### 3.1 请求方式

- **HTTP Method**：`POST`
- **Content-Type**：`application/json`

### 3.2 请求体参数（`CommentReportRequest`）

```json
{
  "commentId": 123,                  // 必填，要举报的评论ID
  "reportReason": "辱骂他人",       // 必填，举报原因描述
  "reportType": "comment_inappropriate", // 选填，举报类型
  "reportEvidence": [ ... ]         // 选填，举报证据（图片/截图/说明等），将以JSON形式存库
}
```

字段说明：

- **commentId**  
  类型：Long  
  说明：被举报评论的唯一ID，必须是系统中已存在的评论。

- **reportReason**  
  类型：String  
  说明：用户填写的举报原因文本，不能为空。

- **reportType**  
  类型：String，选填  
  说明：举报分类标识，例如 `"spam"`、`"abuse"` 等。  
  当前逻辑：如果前端不传或传空，后端自动设置为 `"comment_inappropriate"`。

- **reportEvidence**  
  类型：可序列化为 JSON 的结构（通常为列表或对象）  
  说明：举报截图、链接等补充证据，后端使用 Jackson `ObjectMapper` 序列化后存入数据库。为空时不会影响举报主流程。

### 3.3 返回结果

- **成功示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": "评论举报已提交"
}
```

- **常见错误示例**

1. 未登录：

```json
{
  "code": 401,
  "message": "请先登录"
}
```

2. 缺少 `commentId`：

```json
{
  "code": 400,
  "message": "评论ID不能为空"
}
```

3. 缺少 `reportReason`：

```json
{
  "code": 400,
  "message": "举报原因不能为空"
}
```

4. 评论不存在：

```json
{
  "code": 400,
  "message": "评论不存在"
}
```

返回结构统一使用项目中的 `ResponseDTO` 封装。

---

## 四、后端处理流程

### 4.1 控制层（`UserPostController`）

方法：`public ResponseDTO reportComment(CommentReportRequest request, Authentication authentication)`

处理步骤：

1. 校验登录状态：未登录时返回 `401` + `"请先登录"`。
2. 校验请求体：
   - `request == null` 或 `request.getCommentId() == null`：返回 `400` + `"评论ID不能为空"`。
   - `reportReason` 为空：返回 `400` + `"举报原因不能为空"`。
3. 获取当前用户手机号：`String phone = authentication.getName();`
4. 调用 Service：`userPostService.reportComment(phone, request);`
5. 返回成功：`ResponseDTO.success("评论举报已提交")`。

### 4.2 服务层（`UserPostService.reportComment`）

方法签名：

```java
@Transactional
public void reportComment(String phone, CommentReportRequest request)
```

核心逻辑：

1. 参数再次校验：
   - `request == null || request.getCommentId() == null` 抛出 `"评论ID不能为空"`。
   - `reportReason` 为空抛出 `"举报原因不能为空"`。
2. 设置默认举报类型：`reportType` 为空时自动设为 `"comment_inappropriate"`。
3. 通过手机号获取举报人 `User reporter`，得到 `reporterId`。
4. 通过 `commentRepository.findById` 获取被举报评论，不存在则抛出 `"评论不存在"`。
5. 构造 `UserPostCommentReport`：
   - `commentId`、`postId`、`reporterId`、`reportedUserId`、`reportType`、`reportReason`。
   - `reportEvidence` 若非空，序列化为 JSON 字符串存库，序列化失败不会中断主流程。
6. 设置 `status = "pending"`，调用 `commentReportRepository.save(report)` 持久化。
7. 由 `@Transactional` 保证操作原子性。

---

## 五、数据存储说明

实体：`UserPostCommentReport`（评论举报表），当前使用字段包括：

- `commentId`：被举报的评论 ID
- `postId`：评论所属帖子 ID
- `reporterId`：举报人用户 ID
- `reportedUserId`：被举报用户 ID（评论作者）
- `reportType`：举报类型标识
- `reportReason`：举报原因文本
- `reportEvidence`：举报证据（JSON 字符串）
- `status`：举报处理状态，当前初始化为 `"pending"`

实际表结构以 `gd_mcp` 数据库中的 `user_post_comment_report` 表为准，上述字段与 Service 逻辑严格对应。

---

## 六、权限与校验策略

- 仅登录用户可举报：Controller 层强制校验登录态。
- 评论必须真实存在：通过 `commentRepository.findById` 验证。
- 必填项约束：
  - `commentId`、`reportReason` 为必须字段。
  - `reportType`、`reportEvidence` 为可选字段。

当前版本不限制同一用户对同一评论的多次举报，如需限制可在后续扩展逻辑中增加唯一性检查。

---

## 七、当前范围与后续扩展

### 7.1 已实现范围

- 用户可对评论发起举报。
- 后端完成鉴权、参数校验与举报记录落库，状态为 `pending`。

### 7.2 可扩展功能

- 管理员审核举报：
  - 举报列表分页查询接口。
  - 审核通过/驳回接口，更新 `status` 并对评论做相应处理（隐藏/删除等）。
- 防重复举报：限制同一用户对同一评论在 `pending` 状态下只能有一条举报记录。
- 自动风控：对同一评论举报次数达到阈值时自动隐藏或置为待审核。
- 通知机制：
  - 新举报提醒管理员。
  - 审核结果通知举报人/被举报人。
