# 数据库表结构修复说明

## 问题原因

**错误信息**: `Field 'title' doesn't have a default value`

**根本原因**: 
数据库中的 `user_travel_post` 表结构与代码中的 `UserTravelPost` 实体类不匹配。

当前 `user_travel_post` 表中包含了 `title`、`content`、`summary` 等帖子内容字段，但这些字段应该在 `travel_post` 主表中，而不是在关联表中。

## 架构设计

### 双表结构设计
- **travel_post 表**: 存储帖子的完整内容（title、content、summary等）
- **user_travel_post 表**: 只存储用户与帖子的关联关系和用户特定信息

### UserTravelPost 实体类字段（正确的）
- id
- travel_post_id (关联到travel_post表)
- publisher_id
- publisher_nickname
- publisher_avatar_url
- user_status
- is_original
- user_notes
- user_tags
- is_pinned
- user_category
- created_time
- updated_time
- user_published_time
- user_deleted_time

**注意**: 实体类中**没有** title、content、summary 等字段！

## 修复步骤

### 方法1: 执行SQL脚本修复（推荐）

1. 使用数据库管理工具（如 Navicat、MySQL Workbench、phpMyAdmin）连接到数据库

2. 执行以下SQL脚本: `fix_user_travel_post_table.sql`

```sql
-- 1. 备份现有数据
CREATE TABLE user_travel_post_backup AS SELECT * FROM user_travel_post;

-- 2. 删除旧表
DROP TABLE IF EXISTS user_travel_post;

-- 3. 创建正确的表结构
CREATE TABLE user_travel_post (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    
    -- 关联信息
    travel_post_id BIGINT NOT NULL COMMENT '关联的travel_post表ID',
    publisher_id BIGINT NOT NULL COMMENT '发布者用户ID',
    
    -- 发布者信息
    publisher_nickname VARCHAR(100) COMMENT '发布者昵称',
    publisher_avatar_url VARCHAR(500) COMMENT '发布者头像URL',
    
    -- 用户特定的状态和权限
    user_status VARCHAR(20) DEFAULT 'active' COMMENT '用户对此帖子的状态',
    is_original BOOLEAN DEFAULT TRUE COMMENT '是否原创',
    user_notes LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '用户备注',
    user_tags VARCHAR(500) COMMENT '用户自定义标签',
    is_pinned BOOLEAN DEFAULT FALSE COMMENT '是否置顶',
    user_category VARCHAR(50) COMMENT '用户自定义分类',
    
    -- 时间戳
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    user_published_time DATETIME COMMENT '用户发布时间',
    user_deleted_time DATETIME COMMENT '用户删除时间',
    
    -- 外键约束
    FOREIGN KEY (travel_post_id) REFERENCES travel_post(id) ON DELETE CASCADE,
    FOREIGN KEY (publisher_id) REFERENCES user_info(UserID) ON DELETE CASCADE,
    
    -- 索引
    UNIQUE INDEX idx_travel_post_publisher (travel_post_id, publisher_id),
    INDEX idx_publisher_status (publisher_id, user_status),
    INDEX idx_published_time (user_published_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 方法2: 手动删除不需要的字段

如果你想保留现有数据，可以只删除多余的字段：

```sql
-- 删除帖子内容相关的字段（这些字段应该在travel_post表中）
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS title;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS summary;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS content;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS content_type;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS post_type;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS category;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS cover_image;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS images;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS videos;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS attachments;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS destination_name;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS destination_city;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS destination_province;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS destination_country;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS locations;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_start_date;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_end_date;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_days;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_budget;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS actual_cost;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_season;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS travel_style;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS companion_type;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS tags;
ALTER TABLE user_travel_post DROP COLUMN IF EXISTS keywords;

-- 添加必需的字段（如果不存在）
ALTER TABLE user_travel_post ADD COLUMN IF NOT EXISTS travel_post_id BIGINT NOT NULL COMMENT '关联的travel_post表ID' AFTER id;

-- 添加索引
ALTER TABLE user_travel_post ADD INDEX IF NOT EXISTS idx_travel_post_id (travel_post_id);
ALTER TABLE user_travel_post ADD UNIQUE INDEX IF NOT EXISTS idx_travel_post_publisher (travel_post_id, publisher_id);
```

## 验证修复

执行SQL后，验证表结构：

```sql
DESCRIBE user_travel_post;
```

应该只看到以下字段：
- id
- travel_post_id
- publisher_id
- publisher_nickname
- publisher_avatar_url
- user_status
- is_original
- user_notes
- user_tags
- is_pinned
- user_category
- created_time
- updated_time
- user_published_time
- user_deleted_time

## 修复后重启应用

修复数据库表结构后，需要重启Spring Boot应用，以便Hibernate重新加载实体映射。

```bash
# 停止应用
# 然后重新启动
mvn spring-boot:run
```

## 测试

重启应用后，再次测试帖子发布功能，应该就能正常工作了。

