# 🚀 重启后端服务指南

## ⚠️ 重要提示

**你已经修改了代码，但后端服务还在使用旧代码！**

必须重新编译并重启服务，修复才能生效。

---

## 📋 完整修复流程

### 步骤 1：清理数据库中的问题数据（可选但推荐）

**目的**：清除数据库中已有的重复记录，避免遗留问题

1. 打开数据库管理工具（如 Navicat、DBeaver 或 MySQL Workbench）

2. 执行诊断查询：
```sql
-- 检查是否有重复记录
SELECT 
    user_id, 
    post_id, 
    COUNT(*) as record_count
FROM travel_post_favorite
GROUP BY user_id, post_id
HAVING COUNT(*) > 1;
```

3. 如果有结果，查看详细信息：
```sql
-- 查看帖子 2 的收藏记录（根据你的错误是帖子2）
SELECT * FROM travel_post_favorite 
WHERE post_id = 2 
ORDER BY user_id, favorite_time DESC;
```

4. 清理重复记录（请先备份！）：
```sql
-- 针对帖子 2 的快速修复：保留每个用户的最新记录，删除旧记录
DELETE FROM travel_post_favorite 
WHERE post_id = 2 
  AND id NOT IN (
    SELECT * FROM (
      SELECT MAX(id) 
      FROM travel_post_favorite 
      WHERE post_id = 2 
      GROUP BY user_id
    ) as temp
  );
```

**或者使用提供的脚本**：
```bash
# 使用 fix_favorite_duplicate_records.sql 脚本
# 在数据库管理工具中打开并执行相应的查询
```

---

### 步骤 2：停止当前运行的后端服务

**方法 A：如果在命令行运行**
- 按 `Ctrl + C` 停止服务

**方法 B：如果在 IDE（如 IntelliJ IDEA / Eclipse）中运行**
- 点击红色的停止按钮 ⏹️

**方法 C：如果作为后台服务运行**
```bash
# 查找 Java 进程
jps -l

# 或者
ps aux | grep java

# 杀死进程（假设进程 ID 是 12345）
kill -9 12345
```

---

### 步骤 3：重新编译项目

```bash
# 进入项目目录
cd "E:\BE_CXH_BUG\back-end\gd(1)"

# 清理并编译
mvn clean compile
```

**预期输出**：
```
[INFO] BUILD SUCCESS
[INFO] Total time: XX s
```

---

### 步骤 4：打包项目（可选）

```bash
# 打包成 JAR 文件
mvn clean package
```

或者如果你想跳过测试：
```bash
mvn clean package -DskipTests
```

---

### 步骤 5：启动后端服务

**方法 A：使用 Maven 运行**
```bash
mvn spring-boot:run
```

**方法 B：运行打包好的 JAR**
```bash
# JAR 文件通常在 target 目录下
java -jar target/auth-system-0.0.1-SNAPSHOT.jar
```

**方法 C：在 IDE 中运行**
- 找到 `AuthApplication.java`
- 右键 → Run 'AuthApplication'

---

### 步骤 6：验证服务启动成功

**检查日志**：
```
应该看到类似的输出：
Started AuthApplication in X.XXX seconds
Tomcat started on port(s): 8080
```

**测试接口**：
```bash
# 使用 curl 或 Postman 测试
curl http://localhost:8080/api/auth/test
```

---

### 步骤 7：前端测试收藏功能

1. 刷新前端页面
2. 测试收藏操作：
   - ✅ 点击收藏按钮
   - ✅ 再次点击收藏按钮（测试幂等性）
   - ✅ 取消收藏
   - ✅ 再次收藏（这是之前出错的场景）

**预期结果**：
- ✅ 不再有 `ConstraintViolationException` 错误
- ✅ 控制台显示日志：
  ```
  ✅ 帖子已在收藏列表中（幂等返回）
  或
  🔄 恢复之前取消的收藏
  或
  ➕ 创建新的收藏记录
  ```

---

## 🐛 如果还是报错

### 情况 1：编译错误

**错误示例**：
```
[ERROR] COMPILATION ERROR
[ERROR] symbol: class Optional
```

**解决方案**：
- 检查是否正确添加了 `import java.util.Optional;`
- 重新接受代码更改

---

### 情况 2：数据库连接错误

**错误示例**：
```
Could not open JDBC Connection
```

**解决方案**：
1. 检查 MySQL 是否运行
2. 检查 `application.properties` 中的数据库配置
3. 测试数据库连接

---

### 情况 3：端口被占用

**错误示例**：
```
Port 8080 is already in use
```

**解决方案**：
```bash
# Windows
netstat -ano | findstr :8080
taskkill /PID <进程ID> /F

# Linux/Mac
lsof -i :8080
kill -9 <进程ID>
```

---

### 情况 4：还是约束冲突错误

如果重启后还是报错，可能是：

**A. 代码没有正确更新**
```bash
# 检查文件修改时间
ls -lt src/main/java/com/example/auth/service/FavoriteService.java
```

**B. 使用了缓存的旧代码**
```bash
# 强制清理并重新编译
mvn clean
rm -rf target/
mvn compile
```

**C. 数据库中有特殊的约束**
```sql
-- 检查表结构
SHOW CREATE TABLE travel_post_favorite;

-- 应该看到：
-- UNIQUE KEY `uk_user_post` (`user_id`,`post_id`)
```

---

## 📊 验证修复成功的标志

### 后端日志应该显示：

✅ **首次收藏**：
```
➕ 创建新的收藏记录
```

✅ **重复收藏（幂等）**：
```
✅ 帖子已在收藏列表中（幂等返回）
```

✅ **取消后再收藏**：
```
🔄 恢复之前取消的收藏
```

### 前端应该：

- ✅ 不再显示约束冲突错误
- ✅ 收藏/取消操作流畅
- ✅ 刷新页面后状态正确

---

## 🔍 调试技巧

### 查看实时日志
```bash
# 如果使用 Spring Boot 运行
mvn spring-boot:run

# 日志会实时显示在控制台
# 注意观察带有 emoji 的日志：
# ✅ 🔄 ➕ ⚠️
```

### 增加日志级别
在 `application.properties` 中添加：
```properties
# 查看 SQL 执行
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# 查看应用日志
logging.level.com.example.auth=DEBUG
```

---

## 📝 快速命令参考

```bash
# 一键重启（清理+编译+运行）
cd "E:\BE_CXH_BUG\back-end\gd(1)" && mvn clean compile && mvn spring-boot:run

# 一键打包并运行
cd "E:\BE_CXH_BUG\back-end\gd(1)" && mvn clean package -DskipTests && java -jar target/*.jar

# 检查进程
jps -l | grep AuthApplication

# 强制停止所有 Java 进程（慎用！）
# taskkill /F /IM java.exe  # Windows
# pkill -9 java             # Linux/Mac
```

---

## ✅ 检查清单

在测试前，请确认：

- [ ] 已停止旧的后端服务
- [ ] 已重新编译项目（mvn clean compile）
- [ ] 编译成功（看到 BUILD SUCCESS）
- [ ] 已启动新的后端服务
- [ ] 看到 "Started AuthApplication" 日志
- [ ] 前端已刷新页面
- [ ] （可选）已清理数据库重复记录

---

**修复完成标志**：前端可以正常收藏/取消收藏，不再有约束冲突错误！🎉

