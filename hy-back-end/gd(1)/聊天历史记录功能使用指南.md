# 聊天历史记录功能使用指南

## 🎉 问题已解决

你遇到的问题：**消息发送成功保存到数据库，但刷新页面后消息消失**

**原因**：前端没有调用后端的历史记录接口，每次刷新都是空白开始

**解决方案**：我已经实现了`getChatHistory`接口，现在可以加载历史消息了！

## ✅ 后端已完成

### 实现的接口

**API地址**：`GET /api/user-chat/messages/history`

**请求参数**：
```javascript
{
  userId: 1,        // 当前用户ID
  friendId: 3,      // 好友ID
  page: 0,          // 页码（暂未使用）
  size: 100         // 每页数量（暂未使用）
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "获取聊天记录成功",
  "success": true,
  "data": [
    {
      "messageId": 5,
      "senderId": 1,
      "receiverId": 3,
      "content": "你好！",
      "messageType": "text",
      "sentTime": "2025-11-18T16:50:00",
      "senderName": "用户1",
      "isRead": false,
      "isRecalled": false
    },
    {
      "messageId": 4,
      "senderId": 3,
      "receiverId": 1,
      "content": "你好呀！",
      "messageType": "text",
      "sentTime": "2025-11-18T16:49:30",
      "senderName": "用户3",
      "isRead": false,
      "isRecalled": false
    }
  ]
}
```

**注意**：消息按时间倒序返回（最新的在前）

## 🔧 前端集成步骤

### Step 1: 添加API方法

在前端API配置文件中（通常是`src/api/config.js`或`src/api/chat.js`）添加：

```javascript
// 获取聊天历史记录
export const getChatHistory = async (userId, friendId, page = 0, size = 100) => {
  return await apiRequest('/api/user-chat/messages/history', {
    method: 'GET',
    params: {
      userId,
      friendId,
      page,
      size
    }
  });
};
```

### Step 2: 在ChatPage中调用

在`ChatPage.jsx`或相应的聊天组件中：

```javascript
import { getChatHistory } from '../api/config';

const ChatPage = () => {
  const [messages, setMessages] = useState([]);
  const [currentUserId, setCurrentUserId] = useState(null);
  const [selectedFriend, setSelectedFriend] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // 加载聊天历史
  const loadChatHistory = async (friendId) => {
    if (!currentUserId || !friendId) return;
    
    try {
      setLoading(true);
      console.log('📖 加载聊天历史:', currentUserId, friendId);
      
      const response = await getChatHistory(currentUserId, friendId);
      
      if (response.success && response.data) {
        // 消息是倒序的，需要反转成正序（旧消息在前）
        const historyMessages = response.data.reverse();
        setMessages(historyMessages);
        console.log('✅ 加载了', historyMessages.length, '条历史消息');
      }
    } catch (error) {
      console.error('❌ 加载聊天历史失败:', error);
    } finally {
      setLoading(false);
    }
  };
  
  // 当选择好友时，加载历史记录
  useEffect(() => {
    if (selectedFriend) {
      loadChatHistory(selectedFriend.userId);
    }
  }, [selectedFriend]);
  
  // ... 其他代码
};
```

### Step 3: 完整的消息处理逻辑

```javascript
const ChatPage = () => {
  const [messages, setMessages] = useState([]);
  const [ws, setWs] = useState(null);
  
  // 1. 组件加载时初始化
  useEffect(() => {
    initUserAndWebSocket();
  }, []);
  
  // 2. 初始化用户信息和WebSocket
  const initUserAndWebSocket = async () => {
    try {
      // 获取当前用户
      const userInfo = await getUserProfile();
      const userId = userInfo.data.userId;
      setCurrentUserId(userId);
      
      // 连接WebSocket
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat/native?userId=${userId}`;
      const websocket = new WebSocket(wsUrl);
      
      websocket.onopen = () => {
        console.log('✅ WebSocket连接成功');
      };
      
      websocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'new_message') {
          // 收到新消息，添加到列表
          setMessages(prev => [...prev, data.data]);
        }
      };
      
      setWs(websocket);
    } catch (error) {
      console.error('初始化失败:', error);
    }
  };
  
  // 3. 选择好友时加载历史记录
  const handleSelectFriend = async (friend) => {
    setSelectedFriend(friend);
    await loadChatHistory(friend.userId);
  };
  
  // 4. 发送消息
  const handleSendMessage = async (content) => {
    try {
      const response = await sendMessage({
        senderId: currentUserId,
        receiverId: selectedFriend.userId,
        messageType: 'text',
        content: content
      });
      
      if (response.success) {
        // 消息发送成功，添加到列表
        setMessages(prev => [...prev, response.data]);
      }
    } catch (error) {
      console.error('发送消息失败:', error);
    }
  };
  
  return (
    <div className="chat-page">
      {loading && <div>加载中...</div>}
      
      {/* 消息列表 */}
      <div className="messages">
        {messages.map(msg => (
          <div key={msg.messageId} className={msg.senderId === currentUserId ? 'my-message' : 'friend-message'}>
            <div className="sender">{msg.senderName}</div>
            <div className="content">{msg.content}</div>
            <div className="time">{formatTime(msg.sentTime)}</div>
          </div>
        ))}
      </div>
      
      {/* 输入框 */}
      <div className="input-area">
        <input 
          type="text" 
          onKeyPress={(e) => {
            if (e.key === 'Enter') {
              handleSendMessage(e.target.value);
              e.target.value = '';
            }
          }}
        />
      </div>
    </div>
  );
};
```

## 🚀 完整工作流程

### 页面加载时
1. ✅ 获取当前用户信息
2. ✅ 连接WebSocket
3. ✅ 显示好友列表

### 点击好友时
1. ✅ 调用`getChatHistory`加载历史消息
2. ✅ 显示所有历史消息
3. ✅ 等待新消息（WebSocket）

### 发送消息时
1. ✅ 调用`sendMessage` API
2. ✅ 消息保存到数据库
3. ✅ 立即显示在界面
4. ✅ WebSocket推送给对方

### 收到新消息时
1. ✅ WebSocket接收到`new_message`
2. ✅ 添加到消息列表
3. ✅ 实时显示

## 🧪 测试步骤

### 1. 重启后端服务
```bash
# 停止当前服务 (Ctrl+C)
mvn spring-boot:run
```

### 2. 测试API
```bash
# 测试获取历史记录
curl "http://localhost:8082/api/user-chat/messages/history?userId=1&friendId=3"
```

### 3. 前端测试
1. 打开聊天页面
2. 点击好友
3. 查看控制台：`📖 加载聊天历史`
4. 应该能看到之前发送的所有消息

### 4. 验证完整流程
1. 发送新消息 → 立即显示
2. 刷新页面 → 历史消息还在
3. 对方收到消息 → 实时显示
4. 刷新对方页面 → 历史消息还在

## 📝 API调用示例

### 在浏览器控制台测试

```javascript
// 获取用户1和用户3之间的聊天记录
fetch('http://localhost:8082/api/user-chat/messages/history?userId=1&friendId=3')
  .then(res => res.json())
  .then(data => {
    console.log('聊天记录:', data);
    console.log('共', data.data.length, '条消息');
  });
```

## ✅ 预期结果

修复后的体验：

**Before（修复前）**：
- ❌ 发送消息 → 显示
- ❌ 刷新页面 → 消息消失
- ❌ 数据库有数据，但前端看不到

**After（修复后）**：
- ✅ 发送消息 → 立即显示
- ✅ 刷新页面 → 历史消息加载
- ✅ 数据库和前端完全同步
- ✅ 对方实时收到消息

## 🎯 关键点总结

1. **后端已实现** - `getChatHistory`接口完成
2. **需要重启后端** - 应用新代码
3. **前端需要调用** - 在选择好友时加载历史
4. **消息顺序** - 后端返回倒序，前端需反转

---

**按照以上步骤集成后，刷新页面也能看到历史消息了！** 🎉
