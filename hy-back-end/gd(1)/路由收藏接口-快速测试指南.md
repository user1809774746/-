# ğŸš€ è·¯ç”±æ”¶è—æ¥å£ - å¿«é€Ÿæµ‹è¯•æŒ‡å—

> **é—®é¢˜**: 401é”™è¯¯ "User not authenticated or not found."  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤  
> **æµ‹è¯•æ—¶é—´**: 5åˆ†é’Ÿ

---

## âš¡ å¿«é€Ÿä¿®å¤æ­¥éª¤ï¼ˆ3æ­¥ï¼‰

### Step 1: é‡å¯åç«¯æœåŠ¡ â±ï¸ 30ç§’

```bash
# åœ¨IDEAä¸­ç‚¹å‡»åœæ­¢æŒ‰é’®ï¼Œç„¶åç‚¹å‡»å¯åŠ¨
# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œï¼š
Ctrl + C  # åœæ­¢
mvn spring-boot:run  # å¯åŠ¨
```

**ç­‰å¾…çœ‹åˆ°**:
```
Started AuthApplication in X.XXX seconds
```

### Step 2: é‡æ–°ç™»å½•è·å–Token â±ï¸ 1åˆ†é’Ÿ

**Postmané…ç½®**:

**Method**: POST  
**URL**: `http://localhost:8081/api/auth/login`  
**Body** (raw, JSON):
```json
{
  "phone": "13800138000",
  "password": "password123",
  "userType": "user"
}
```

**å¤åˆ¶è¿”å›çš„Token**:
```json
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9.eyJwaG9uZ...",  ğŸ‘ˆ å¤åˆ¶è¿™ä¸ª
    "userType": "user",
    "phone": "13800138000"
  }
}
```

### Step 3: æµ‹è¯•æ”¶è—æ¥å£ â±ï¸ 1åˆ†é’Ÿ

**Method**: POST  
**URL**: `http://localhost:8081/api/favorites/route/favorite`  
**Headers**:
```
Content-Type: application/json
Authorization: Bearer ç²˜è´´ä½ çš„token
```
**Body** (raw, JSON):
```json
{
  "tripName": "æµ‹è¯•è·¯çº¿",
  "startLocation": "èµ·ç‚¹A",
  "endLocation": "ç»ˆç‚¹B",
  "startTime": "2025-11-10 09:00:00",
  "totalDistance": 10.5,
  "totalDuration": 120,
  "tripType": "æµ‹è¯•",
  "waypoints": [
    {
      "poiName": "æ™¯ç‚¹1",
      "poiAddress": "åœ°å€1",
      "poiType": "æ™¯ç‚¹",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "visitDuration": 60,
      "orderIndex": 1
    }
  ]
}
```

### âœ… æˆåŠŸæ ‡å¿—

çœ‹åˆ°è¿™ä¸ªå“åº”å°±è¯´æ˜ä¿®å¤æˆåŠŸï¼š

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": "Trip scheme favorited successfully."
}
```

---

## ğŸ” è¿˜æ˜¯401é”™è¯¯ï¼Ÿæ’æŸ¥æ¸…å•

### âœ“ æ£€æŸ¥é¡¹1: Tokenæ˜¯å¦æ­£ç¡®

```bash
# æ£€æŸ¥Authorizationå¤´æ ¼å¼
âŒ é”™è¯¯: Authorization: eyJhbGciOiJIUzUxMiJ9...
âœ… æ­£ç¡®: Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
                                 ^^^^^^ æ³¨æ„æœ‰"Bearer "å‰ç¼€å’Œç©ºæ ¼
```

### âœ“ æ£€æŸ¥é¡¹2: ç”¨æˆ·æ˜¯å¦å­˜åœ¨

**éªŒè¯æ–¹æ³•**:
```sql
-- åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ
SELECT UserID, Username, Number FROM user_info WHERE Number = '13800138000';
```

**é¢„æœŸç»“æœ**: åº”è¯¥èƒ½æŸ¥åˆ°ä¸€æ¡è®°å½•

å¦‚æœæŸ¥ä¸åˆ°ï¼Œè¯´æ˜ç”¨æˆ·ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆæ³¨å†Œï¼š
```bash
POST /api/auth/register
{
  "phone": "13800138000",
  "verificationCode": "123456",
  "password": "password123",
  "confirmPassword": "password123",
  "userType": "user"
}
```

### âœ“ æ£€æŸ¥é¡¹3: Tokenæ˜¯å¦è¿‡æœŸ

Tokenæœ‰æ•ˆæœŸä¸º7å¤©ã€‚å¦‚æœè¶…è¿‡7å¤©ï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚

**éªŒè¯æ–¹æ³•**:
```bash
# è°ƒç”¨è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£
GET http://localhost:8081/api/auth/user-info
Headers: Authorization: Bearer ä½ çš„token

# å¦‚æœè¿”å›401ï¼Œè¯´æ˜tokenè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
```

### âœ“ æ£€æŸ¥é¡¹4: åç«¯æ˜¯å¦é‡å¯

ä¿®æ”¹ä»£ç å**å¿…é¡»é‡å¯**Spring Bootåº”ç”¨ï¼

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹IDEAæ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°æœ€æ–°çš„å¯åŠ¨æ—¶é—´
2025-11-02 14:30:00.123  INFO ... : Started AuthApplication
```

---

## ğŸ“± Postmanå®Œæ•´é…ç½®

### åˆ›å»ºç¯å¢ƒå˜é‡

1. ç‚¹å‡»Postmanå³ä¸Šè§’ "Environments"
2. ç‚¹å‡» "Create Environment"
3. å‘½å: `æœ¬åœ°æµ‹è¯•ç¯å¢ƒ`
4. æ·»åŠ å˜é‡:

```
baseUrl = http://localhost:8081
token = (ç•™ç©ºï¼Œç™»å½•åè‡ªåŠ¨å¡«å……)
phone = 13800138000
```

### å¯¼å…¥è¯·æ±‚é›†åˆ

åˆ›å»ºæ–°çš„Collection: "è·¯ç”±æ”¶è—æ¥å£æµ‹è¯•"

#### è¯·æ±‚1: ç”¨æˆ·ç™»å½•

**Name**: ç”¨æˆ·ç™»å½•  
**Method**: POST  
**URL**: `{{baseUrl}}/api/auth/login`  
**Body**:
```json
{
  "phone": "{{phone}}",
  "password": "password123",
  "userType": "user"
}
```
**Tests** (è‡ªåŠ¨ä¿å­˜token):
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    if (response.code === 200 && response.data.token) {
        pm.environment.set('token', response.data.token);
        console.log('âœ… Tokenå·²ä¿å­˜');
    }
}
```

#### è¯·æ±‚2: æ”¶è—è·¯çº¿

**Name**: æ”¶è—è·¯çº¿  
**Method**: POST  
**URL**: `{{baseUrl}}/api/favorites/route/favorite`  
**Headers**:
```
Authorization: Bearer {{token}}
Content-Type: application/json
```
**Body**:
```json
{
  "tripName": "åŒ—äº¬ä¸‰æ—¥æ¸¸",
  "startLocation": "åŒ—äº¬ç«™",
  "endLocation": "æ•…å®«",
  "startTime": "2025-11-10 09:00:00",
  "totalDistance": 25.5,
  "totalDuration": 180,
  "tripType": "æ–‡åŒ–æ¸¸",
  "waypoints": []
}
```

#### è¯·æ±‚3: å–æ¶ˆæ”¶è—

**Name**: å–æ¶ˆæ”¶è—  
**Method**: POST  
**URL**: `{{baseUrl}}/api/favorites/route/unfavorite/1`  
**Headers**:
```
Authorization: Bearer {{token}}
```

---

## ğŸ¯ ä¸€é”®æµ‹è¯•è„šæœ¬

### Postman Runneræµ‹è¯•

1. ç‚¹å‡»Collectionå³ä¾§çš„ "â–¶" æŒ‰é’®
2. é€‰æ‹© "Run collection"
3. æŒ‰é¡ºåºæ‰§è¡Œï¼š
   - ç”¨æˆ·ç™»å½• â†’ æ”¶è—è·¯çº¿ â†’ å–æ¶ˆæ”¶è—
4. æŸ¥çœ‹æµ‹è¯•ç»“æœ

### å‘½ä»¤è¡Œæµ‹è¯•ï¼ˆcurlï¼‰

```bash
# 1. ç™»å½•
curl -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "password123",
    "userType": "user"
  }'

# å¤åˆ¶è¿”å›çš„token

# 2. æ”¶è—è·¯çº¿
curl -X POST http://localhost:8081/api/favorites/route/favorite \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ä½ çš„token" \
  -d '{
    "tripName": "æµ‹è¯•è·¯çº¿",
    "startLocation": "èµ·ç‚¹",
    "endLocation": "ç»ˆç‚¹",
    "startTime": "2025-11-10 09:00:00",
    "totalDistance": 10.5,
    "totalDuration": 120,
    "tripType": "æµ‹è¯•",
    "waypoints": []
  }'
```

---

## ğŸ› å¸¸è§é”™è¯¯å¯¹ç…§è¡¨

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|---------|
| "User not authenticated or not found." | ç”¨æˆ·åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ | æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦æ­£ç¡®æ³¨å†Œ |
| "Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•" | Tokenè¿‡æœŸæˆ–è¢«é¡¶å· | é‡æ–°ç™»å½•è·å–æ–°token |
| "Authorization header is missing" | æœªæä¾›Token | æ·»åŠ Authorizationå¤´ |
| "Error processing trip scheme data." | JSONæ ¼å¼é”™è¯¯ | æ£€æŸ¥waypointsæ•°ç»„æ ¼å¼ |
| 500é”™è¯¯ | åç«¯é€»è¾‘é”™è¯¯ | æŸ¥çœ‹åç«¯æ§åˆ¶å°æ—¥å¿— |

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

æµ‹è¯•å‰è¯·ç¡®è®¤ï¼š

- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£8081ï¼‰
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ç”¨æˆ·å·²æ³¨å†Œï¼ˆæ‰‹æœºå·ï¼š13800138000ï¼‰
- [ ] è·å–äº†æœ‰æ•ˆçš„Token
- [ ] Tokenæ·»åŠ äº†"Bearer "å‰ç¼€
- [ ] Content-Typeè®¾ç½®ä¸ºapplication/json
- [ ] è¯·æ±‚Bodyæ ¼å¼æ­£ç¡®

---

## ğŸ’¡ æˆåŠŸæ¡ˆä¾‹

### å®Œæ•´çš„æµ‹è¯•æµç¨‹

```bash
# æ­¥éª¤1: æ³¨å†Œç”¨æˆ·ï¼ˆå¦‚æœæœªæ³¨å†Œï¼‰
POST /api/auth/send-verification-code
{ "phone": "13800138000" }

POST /api/auth/register
{
  "phone": "13800138000",
  "verificationCode": "123456",
  "password": "password123",
  "confirmPassword": "password123",
  "userType": "user"
}

# æ­¥éª¤2: ç™»å½•
POST /api/auth/login
{
  "phone": "13800138000",
  "password": "password123",
  "userType": "user"
}
# å¾—åˆ°token: eyJhbGciOiJIUzUxMiJ9...

# æ­¥éª¤3: æ”¶è—è·¯çº¿
POST /api/favorites/route/favorite
Headers: Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
Body: { ... è·¯çº¿ä¿¡æ¯ ... }

# âœ… æˆåŠŸè¿”å›:
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": "Trip scheme favorited successfully."
}
```

---

## ğŸ†˜ è¿˜æœ‰é—®é¢˜ï¼Ÿ

### æŸ¥çœ‹åç«¯æ—¥å¿—

**å…³é”®æ—¥å¿—**:
```
âœ… æˆåŠŸæ—¥å¿—:
è¯·æ±‚è®¤è¯æˆåŠŸ: 13800138000 (user)

âŒ å¤±è´¥æ—¥å¿—:
âš ï¸ TokenéªŒè¯å¤±è´¥ï¼Œç”¨æˆ·: 13800138000 (user) - å¯èƒ½è¢«é¡¶å·æˆ–å·²è¿‡æœŸ
âŒ ç”¨æˆ·æŸ¥è¯¢å¤±è´¥ - æ‰‹æœºå·: 13800138000
```

### æ•°æ®åº“æ£€æŸ¥

```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
SELECT * FROM user_info WHERE Number = '13800138000';

-- æ£€æŸ¥ç”¨æˆ·çš„tokenä¿¡æ¯
SELECT UserID, Number, active_token, token_expires_at 
FROM user_info 
WHERE Number = '13800138000';
```

### è”ç³»æŠ€æœ¯æ”¯æŒ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š
1. å®Œæ•´çš„é”™è¯¯å“åº”
2. åç«¯æ§åˆ¶å°æ—¥å¿—
3. ä½¿ç”¨çš„Tokenï¼ˆå‰20ä¸ªå­—ç¬¦ï¼‰
4. è¯·æ±‚çš„å®Œæ•´Headerså’ŒBody

---

**æµ‹è¯•æŒ‡å—ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-02  
**é¢„è®¡æµ‹è¯•æ—¶é—´**: 5åˆ†é’Ÿ

