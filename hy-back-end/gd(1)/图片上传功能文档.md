# 图片上传功能文档

## 概述
本文档提供聊天系统图片上传相关的API接口说明，包括上传聊天背景、群头像、用户头像等功能。

## 基础信息
- **Base URL**: `/api/group`
- **内容类型**: `multipart/form-data`（文件上传）/ `application/json`（设置背景）
- **认证方式**: 需要用户认证

---

## 功能说明

### 工作流程
1. **第一步**：用户通过上传接口上传图片文件
2. **第二步**：服务器保存图片并返回图片URL和元信息
3. **第三步**：用户使用返回的URL设置为聊天背景

---

## 1. 上传聊天背景图片

### 接口说明
上传图片文件，服务器保存后返回图片URL

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/upload-background`
- **Content-Type**: `multipart/form-data`
- **路径参数**:
  - `groupId` (Long): 群聊ID
- **查询参数**:
  - `userId` (Long): 用户ID

### 请求参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 图片文件（支持jpg、png、gif、bmp、webp） |
| userId | Long | 是 | 上传者用户ID（URL参数） |

### 文件限制
- **支持格式**: jpg, jpeg, png, gif, bmp, webp
- **最大大小**: 5MB
- **MIME类型**: image/jpeg, image/png, image/gif, image/bmp, image/webp

### 响应示例
```json
{
  "code": 200,
  "message": "图片上传成功",
  "data": {
    "imageId": 10001,
    "imageUrl": "http://localhost:8082/uploads/chat-backgrounds/550e8400-e29b-41d4-a716-446655440000.jpg",
    "originalFilename": "my-background.jpg",
    "fileSize": 2048576,
    "fileExtension": "jpg",
    "mimeType": "image/jpeg",
    "imageWidth": 1920,
    "imageHeight": 1080,
    "imageType": "chat_background",
    "uploadTime": "2025-12-11T10:30:00"
  }
}
```

### 使用示例（JavaScript + Fetch）
```javascript
async function uploadChatBackground(groupId, userId, file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(`/api/group/${groupId}/settings/upload-background?userId=${userId}`, {
    method: 'POST',
    body: formData
  });
  
  const result = await response.json();
  if (result.code === 200) {
    console.log('上传成功，图片URL:', result.data.imageUrl);
    return result.data;
  } else {
    console.error('上传失败:', result.message);
    throw new Error(result.message);
  }
}
```

### 使用示例（HTML Form）
```html
<form id="uploadForm" enctype="multipart/form-data">
  <input type="file" name="file" accept="image/*" required>
  <button type="submit">上传背景图片</button>
</form>

<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const groupId = 1001; // 群聊ID
  const userId = 2001;  // 用户ID
  const fileInput = this.querySelector('input[type="file"]');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('请选择图片文件');
    return;
  }
  
  try {
    const result = await uploadChatBackground(groupId, userId, file);
    alert('上传成功！图片URL: ' + result.imageUrl);
    
    // 自动设置为聊天背景
    await setChatBackground(groupId, userId, result.imageUrl);
  } catch (error) {
    alert('上传失败: ' + error.message);
  }
});
</script>
```

### cURL示例
```bash
curl -X POST "http://localhost:8082/api/group/1001/settings/upload-background?userId=2001" \
  -F "file=@/path/to/image.jpg"
```

---

## 2. 设置群聊背景

### 接口说明
使用已上传的图片URL设置为聊天背景

### 请求信息
- **URL**: `POST /api/group/{groupId}/settings/background`
- **Content-Type**: `application/json`
- **路径参数**:
  - `groupId` (Long): 群聊ID

### 请求体
```json
{
  "userId": 2001,
  "backgroundUrl": "http://localhost:8082/uploads/chat-backgrounds/550e8400-e29b-41d4-a716-446655440000.jpg"
}
```

### 参数说明
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| backgroundUrl | String | 否 | 背景图片URL，传null表示清除背景 |

### 响应示例
```json
{
  "code": 200,
  "message": "设置群聊背景成功",
  "data": "设置群聊背景成功"
}
```

### 使用示例（JavaScript）
```javascript
async function setChatBackground(groupId, userId, backgroundUrl) {
  const response = await fetch(`/api/group/${groupId}/settings/background`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userId: userId,
      backgroundUrl: backgroundUrl
    })
  });
  
  const result = await response.json();
  if (result.code === 200) {
    console.log('设置成功');
  } else {
    console.error('设置失败:', result.message);
  }
}
```

---

## 3. 完整使用流程示例

### 前端完整代码示例
```html
<!DOCTYPE html>
<html>
<head>
  <title>群聊背景设置</title>
  <style>
    .background-preview {
      width: 300px;
      height: 200px;
      border: 1px solid #ccc;
      background-size: cover;
      background-position: center;
    }
  </style>
</head>
<body>
  <h1>群聊背景设置</h1>
  
  <form id="uploadForm">
    <input type="file" id="fileInput" accept="image/*" required>
    <button type="submit">上传并设置为背景</button>
  </form>
  
  <div id="preview" class="background-preview"></div>
  <p id="status"></p>
  
  <script>
    const groupId = 1001; // 替换为实际的群聊ID
    const userId = 2001;  // 替换为实际的用户ID
    
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('status');
      const previewEl = document.getElementById('preview');
      
      if (!file) {
        statusEl.textContent = '请选择图片文件';
        return;
      }
      
      // 验证文件大小
      if (file.size > 5 * 1024 * 1024) {
        statusEl.textContent = '文件大小不能超过5MB';
        return;
      }
      
      // 验证文件类型
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        statusEl.textContent = '仅支持图片格式（jpg、png、gif、bmp、webp）';
        return;
      }
      
      try {
        statusEl.textContent = '正在上传...';
        
        // 步骤1：上传图片
        const formData = new FormData();
        formData.append('file', file);
        
        const uploadResponse = await fetch(
          `/api/group/${groupId}/settings/upload-background?userId=${userId}`,
          {
            method: 'POST',
            body: formData
          }
        );
        
        const uploadResult = await uploadResponse.json();
        
        if (uploadResult.code !== 200) {
          throw new Error(uploadResult.message);
        }
        
        const imageUrl = uploadResult.data.imageUrl;
        statusEl.textContent = '上传成功，正在设置背景...';
        
        // 步骤2：设置为背景
        const setResponse = await fetch(`/api/group/${groupId}/settings/background`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            backgroundUrl: imageUrl
          })
        });
        
        const setResult = await setResponse.json();
        
        if (setResult.code !== 200) {
          throw new Error(setResult.message);
        }
        
        // 预览图片
        previewEl.style.backgroundImage = `url(${imageUrl})`;
        statusEl.textContent = '✅ 背景设置成功！';
        
      } catch (error) {
        statusEl.textContent = '❌ 操作失败: ' + error.message;
      }
    });
  </script>
</body>
</html>
```

---

## 4. 数据库存储说明

### chat_images 表
上传的图片信息存储在 `chat_images` 表中，包含以下信息：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 图片ID（主键） |
| uploader_id | BIGINT | 上传者用户ID |
| image_type | ENUM | 图片类型（chat_background等） |
| original_filename | VARCHAR | 原始文件名 |
| stored_filename | VARCHAR | 存储文件名（UUID） |
| file_path | VARCHAR | 文件存储路径 |
| file_url | VARCHAR | 文件访问URL |
| file_size | BIGINT | 文件大小（字节） |
| file_extension | VARCHAR | 文件扩展名 |
| mime_type | VARCHAR | MIME类型 |
| image_width | INT | 图片宽度 |
| image_height | INT | 图片高度 |
| is_deleted | TINYINT | 是否已删除 |
| created_time | DATETIME | 上传时间 |
| updated_time | DATETIME | 更新时间 |

### 文件存储位置
- **存储路径**: `uploads/chat-backgrounds/`
- **文件命名**: UUID + 原始扩展名
- **访问URL**: `http://localhost:8082/uploads/chat-backgrounds/文件名`

---

## 5. 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 文件不能为空 | 请选择文件后再上传 |
| 400 | 文件大小超限 | 文件大小不能超过5MB |
| 400 | 不支持的文件类型 | 仅支持图片格式 |
| 404 | 群聊不存在 | 检查groupId是否正确 |
| 403 | 不是群成员 | 只有群成员才能设置背景 |
| 500 | 服务器错误 | 联系管理员 |

---

## 6. 注意事项

1. **文件大小限制**: 单个文件不超过5MB
2. **文件格式**: 仅支持图片格式（jpg、png、gif、bmp、webp）
3. **存储空间**: 服务器需要确保有足够的磁盘空间
4. **权限控制**: 只有群成员才能上传和设置群聊背景
5. **用户维度**: 每个用户可以为同一个群设置不同的背景
6. **图片管理**: 已上传的图片会保存在数据库中，支持查询和删除

---

## 7. 部署配置

### 生产环境配置
在 `application.properties` 中修改以下配置：

```properties
# 文件存储配置
file.upload.base-path=/var/www/uploads
file.upload.chat-background-path=/var/www/uploads/chat-backgrounds
file.upload.max-size=5242880

# 服务器配置（需要配置为实际的域名或IP）
server.port=80
```

### Nginx反向代理配置
```nginx
location /uploads/ {
    alias /var/www/uploads/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

---

## 8. 扩展功能建议

### 未来可以添加的功能
1. **图片压缩**: 自动压缩大尺寸图片
2. **缩略图生成**: 生成多个尺寸的缩略图
3. **图片审核**: 接入内容安全审核API
4. **批量上传**: 支持一次上传多张图片
5. **背景模板**: 提供预设的背景模板库
6. **图片裁剪**: 上传前支持在线裁剪
7. **水印添加**: 自动添加水印
8. **云存储**: 支持阿里云OSS、腾讯云COS等云存储

---

## 实施完成

✅ 数据库表已创建（chat_images）  
✅ 实体类和Repository已实现  
✅ 文件上传服务已实现  
✅ API接口已添加  
✅ 静态资源配置已完成  
✅ 文件验证和大小限制已实现  
✅ 图片元信息获取已实现  

**实现完成时间**: 2025-12-11
